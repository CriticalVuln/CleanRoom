<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Finance Tracker</title>

  <!-- Your original inline styles -->
  <style>
    /* Copied from Productivity Tracker */
    * { box-sizing: border-box; }
    body {
      background: #0D0B14; /* Darker background */
      color: #E0E0E0; /* Lighter default text */
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 40px;
      display: flex;
      flex-direction: column; /* Stack nav button and content */
      align-items: center; /* Center content horizontally */
    }
    .app-container {
      width: 100%;
      max-width: 1000px; /* Adjust max-width as needed */
      background: #1A1625; /* Darker card background */
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      margin-top: 70px; /* Add space below the fixed nav button */
    }
    /* Copied from Productivity Tracker */
    .card {
      background: #1A1625; /* Darker card background */
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      margin-bottom: 24px; /* Add margin between cards */
    }
    /* Container for the chart to control its height */
    .chart-container {
      position: relative;
      height: 300px; /* Match Productivity Tracker Overall Performance chart height */
      margin-top: 12px; /* Add some space above the chart */
    }
    /* --- End Copied/Adapted Styles --- */

    h1 {
        color: #FFF; /* White heading */
        font-weight: 600;
        margin-bottom: 20px;
        text-align: center;
    }
    #csvPicker {
        display: block; /* Make it a block element */
        margin: 0 auto 20px auto; /* Center it and add bottom margin */
        padding: 10px;
        border: 1px solid #4F4B68; /* Darker border */
        border-radius: 4px;
        background: #211D30; /* Darker input background */
        color: #E0E0E0; /* Lighter text */
        cursor: pointer;
    }
    /* Style the file input button text */
    #csvPicker::file-selector-button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        background: #63FFDA; /* Accent Cyan/Turquoise */
        color: #0D0B14; /* Dark text for contrast */
        font-weight: 600;
        cursor: pointer;
        margin-right: 10px;
    }
    #total {
        text-align: center;
        font-size: 1.1em;
        color: #FFF; /* White text for total */
    }
    /* Copied from Productivity Tracker */
    .content {
      width: 100%;
      max-width: 1400px; /* Match Productivity Tracker app-container width */
      margin-top: 70px; /* Add space below the fixed nav button */
      /* Center the content container itself */
      margin-left: auto;
      margin-right: auto;
    }
    /* Sidebar styles (copied from Landing Page) */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 60px;
      background: #1A1625;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
    }
    .sidebar a {
      color: #63FFDA;
      font-size: 24px;
      margin: 16px 0;
      text-decoration: none;
    }
    .sidebar a svg {
      width: 24px;
      height: 24px;
      fill: none;
      stroke: #63FFDA;
      stroke-width: 2;
    }
    /* --- New: File History Tab Styles --- */
    .file-history-tab {
      position: absolute;
      top: 18px;
      left: 70px;
      background: #211D30;
      color: #63FFDA;
      border: none;
      border-radius: 8px 8px 0 0;
      padding: 8px 22px 8px 18px;
      font-family: 'Poppins', sans-serif;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      z-index: 1100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      transition: background 0.15s, color 0.15s;
    }
    .file-history-tab.active {
      background: #63FFDA;
      color: #0D0B14;
    }
    .file-history-panel {
      position: absolute;
      top: 54px;
      left: 70px;
      background: #1A1625;
      color: #E0E0E0;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      min-width: 320px;
      max-width: 420px;
      padding: 18px 18px 10px 18px;
      z-index: 1100;
      display: none;
    }
    .file-history-panel h3 {
      margin: 0 0 10px 0;
      font-size: 1.1em;
      color: #63FFDA;
      font-weight: 600;
    }
    .file-history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 220px;
      overflow-y: auto;
    }
    .file-history-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 0;
      border-bottom: 1px solid #29223a;
      font-size: 14px;
    }
    .file-history-list li:last-child { border-bottom: none; }
    .file-history-list .filename {
      flex: 1;
      color: #E0E0E0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-history-list .delete-btn {
      background: none;
      border: none;
      color: #FF6B6B;
      font-size: 15px;
      cursor: pointer;
      margin-left: 12px;
      padding: 2px 8px;
      border-radius: 4px;
      transition: background 0.15s;
    }
    .file-history-list .delete-btn:hover {
      background: #2a263a;
    }
  </style>

  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- ―――---- added helper libraries ----――― -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script> <!-- Chart.js UMD bundle :contentReference[oaicite:1]{index=1} -->
  <!-- ADDED: Date Adapter for Chart.js Time Scale -->
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script> <!-- date-fns library -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script> <!-- date-fns adapter -->
</head>
<body>
  <script src="config.js"></script> <!-- Load config first -->
  <button id="fileHistoryTab" class="file-history-tab">File History</button>
  <div id="fileHistoryPanel" class="file-history-panel">
    <h3>Uploaded Files</h3>
    <ul id="fileHistoryList" class="file-history-list"></ul>
  </div>
  <nav class="sidebar">
    <a href="Landing Page.html">
      <svg viewBox="0 0 24 24">
        <path d="M3 10L12 3l9 7v11a1 1 0 0 1-1 1h-6v-7h-4v7H4a1 1 0 0 1-1-1V10z"/>
      </svg>
    </a>
    <a href="Personal Finance Tracker.html">
      <svg viewBox="0 0 24 24">
        <polyline points="3 17 8 12 13 16 21 4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </a>
    <a href="Productivity Tracker.html">
      <svg viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="9"/>
        <polyline points="12 7 12 12 15 15" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </a>
  </nav>

  <div class="content">
    <h1>Personal Finance Tracker</h1>
    <input id="pdfPicker" type="file" accept=".pdf" multiple>
    <div id="total"></div>
    <div class="chart-container">
      <canvas id="spendChart"></canvas>
    </div>
    <script>
      // Helper to extract month/year from filename
      function extractMonthYearFromName(name) {
        if (typeof name !== 'string') return null;
        const trimmedName = name.trim();

        const monthMap = {
          jan: 1, january: 1, feb: 2, february: 2, mar: 3, march: 3, apr: 4, april: 4,
          may: 5, jun: 6, june: 6, jul: 7, july: 7, aug: 8, august: 8, sep: 9, september: 9,
          oct: 10, october: 10, nov: 11, november: 11, dec: 12, december: 12
        };
        const monthPattern = '(January|Jan|February|Feb|March|Mar|April|Apr|May|June|Jun|July|Jul|August|Aug|September|Sep|Oct|October|November|Nov|December|Dec)';
        
        // Try to match "Month YYYY" (e.g., "March 2025")
        // User stated format: "Month Year Bank Statement"
        const textualMatchMonthYear = trimmedName.match(new RegExp(monthPattern + '\\s+(\\d{4})', 'i'));

        if (textualMatchMonthYear && textualMatchMonthYear[1] && textualMatchMonthYear[2]) {
          const monthName = textualMatchMonthYear[1].toLowerCase();
          const year = parseInt(textualMatchMonthYear[2], 10);
          const month = monthMap[monthName];
          if (month && year >= 1900 && year <= 2100) { // Added year range check
            return { year, month };
          }
        }

        // Fallback: Try to match "YYYY Month" (less common for user's stated format)
        const textualMatchYearMonth = trimmedName.match(new RegExp('(\\d{4})\\s+' + monthPattern, 'i'));
         if (textualMatchYearMonth && textualMatchYearMonth[1] && textualMatchYearMonth[2]) {
          const year = parseInt(textualMatchYearMonth[1], 10);
          const monthName = textualMatchYearMonth[2].toLowerCase();
          const month = monthMap[monthName];
          if (month && year >= 1900 && year <= 2100) {
            return { year, month };
          }
        }

        // Fallback to numeric month and year (e.g., "2025-03", "2025_3")
        const numericDateMatch = trimmedName.match(/(\\d{4})[-_]?([0-1]?[0-9])/);
        if (numericDateMatch && numericDateMatch[1] && numericDateMatch[2]) {
          const year = parseInt(numericDateMatch[1], 10);
          const month = parseInt(numericDateMatch[2], 10);
          if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12) {
            return { year, month };
          }
        }
        console.warn('Could not extract month/year from filename:', name); // Added warning
        return null;
      }
      let chart = null;
      // Global aggregates across all uploads
      let monthlyNet = {};
      let monthlyCharges = {};
      let monthlyPayments = {};
      let totalCharges = 0;
      let totalPayments = 0;

      // API Key will now be loaded from config.js
      const GEMINI_API_KEY = window.APP_CONFIG && window.APP_CONFIG.GEMINI_API_KEY;

      // --- File History State ---
      let fileHistory = JSON.parse(localStorage.getItem('financeFileHistory') || '[]');
      // --- File-to-Month Mapping for Robust Deletion ---
      let fileMonthMap = JSON.parse(localStorage.getItem('financeFileMonthMap') || '{}');

      function saveFileMonthMap() {
        localStorage.setItem('financeFileMonthMap', JSON.stringify(fileMonthMap));
      }

      // --- File History UI Logic ---
      const fileHistoryTab = document.getElementById('fileHistoryTab');
      const fileHistoryPanel = document.getElementById('fileHistoryPanel');
      const fileHistoryList = document.getElementById('fileHistoryList');

      function renderFileHistory() {
        fileHistoryList.innerHTML = '';
        if (!fileHistory.length) {
          fileHistoryList.innerHTML = '<li style="color:#A0A0A0;">No files uploaded yet.</li>';
          return;
        }

        // Sort fileHistory by date (year, then month), then by name for undated files
        fileHistory.sort((a, b) => {
          const dateA = extractMonthYearFromName(a.name);
          const dateB = extractMonthYearFromName(b.name);

          if (dateA && dateB) {
            if (dateA.year !== dateB.year) {
              return dateA.year - dateB.year; // Sort by year ascending
            }
            return dateA.month - dateB.month; // Then by month ascending
          } else if (dateA) {
            return -1; // dateA (has date) comes before dateB (no date)
          } else if (dateB) {
            return 1;  // dateB (has date) comes before dateA (no date)
          } else {
            // Neither has a parseable date, sort by name alphabetically
            return a.name.localeCompare(b.name);
          }
        });

        fileHistory.forEach(f => {
          const li = document.createElement('li');
          const nameSpan = document.createElement('span');
          nameSpan.className = 'filename';
          nameSpan.textContent = f.name;
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-btn';
          delBtn.textContent = 'Delete';
          delBtn.onclick = () => deleteFileHistory(f.name);
          li.appendChild(nameSpan);
          li.appendChild(delBtn);
          fileHistoryList.appendChild(li);
        });
      }

      function showFileHistory(show) {
        if (show) {
          fileHistoryPanel.style.display = 'block';
          fileHistoryTab.classList.add('active');
          renderFileHistory();
        } else {
          fileHistoryPanel.style.display = 'none';
          fileHistoryTab.classList.remove('active');
        }
      }
      fileHistoryTab.addEventListener('click', () => {
        showFileHistory(fileHistoryPanel.style.display !== 'block');
      });
      document.addEventListener('click', e => {
        if (!fileHistoryPanel.contains(e.target) && e.target !== fileHistoryTab) {
          showFileHistory(false);
        }
      });

      function addFileToHistory(name, keys) {
        if (!fileHistory.some(f => f.name === name)) {
          fileHistory.push({ name });
          localStorage.setItem('financeFileHistory', JSON.stringify(fileHistory));
        }
        if (Array.isArray(keys) && keys.length) {
          fileMonthMap[name] = keys;
          saveFileMonthMap();
        }
      }
      function deleteFileHistory(name) {
        // Remove from fileHistory
        fileHistory = fileHistory.filter(f => f.name !== name);
        localStorage.setItem('financeFileHistory', JSON.stringify(fileHistory));
        // Remove all data from this file from the charts
        removeFileData(name);
        // Remove mapping
        delete fileMonthMap[name];
        saveFileMonthMap();
        renderFileHistory();
        updateDisplay();
      }
      function removeFileData(name) {
        // Remove all data for this file from monthlyCharges/payments using fileMonthMap
        const keys = fileMonthMap[name] || [];
        keys.forEach(key => {
          delete monthlyCharges[key];
          delete monthlyPayments[key];
        });
        // Recalculate totals
        totalCharges = Object.values(monthlyCharges).reduce((a,b)=>a+b,0);
        totalPayments = Object.values(monthlyPayments).reduce((a,b)=>a+b,0);
      }

      // --- On load, render file history ---
      renderFileHistory();
      showFileHistory(false);

      // Update totals display and chart
      function updateDisplay() {
        // Clear numeric summary
        document.getElementById('total').innerHTML = '';
        // Combine months from charges and payments
        const labels = Array.from(new Set([
          ...Object.keys(monthlyCharges),
          ...Object.keys(monthlyPayments)
        ])).sort();
        const chargesData = labels.map(l => monthlyCharges[l] || 0);
        const paymentsData = labels.map(l => monthlyPayments[l] || 0);
        if (chart) chart.destroy();
        chart = new Chart(document.getElementById('spendChart'), {
          type: 'line',
          data: { labels, datasets: [
            {
              label: 'Charges',
              data: chargesData,
              tension: 0.3,
              borderColor: '#FF4C4C',
              backgroundColor: 'rgba(255,76,76,0.1)',
              fill: false,
              pointRadius: 3,
              pointBackgroundColor: '#FF4C4C',
              pointBorderColor: '#1A1625',
              pointHoverRadius: 6
            },
            {
              label: 'Payments',
              data: paymentsData,
              tension: 0.3,
              borderColor: '#4CFF4C',
              backgroundColor: 'rgba(76,255,76,0.1)',
              fill: false,
              pointRadius: 3,
              pointBackgroundColor: '#4CFF4C',
              pointBorderColor: '#1A1625',
              pointHoverRadius: 6
            }
          ]},
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { grid: { color: '#333' }, ticks: { color: '#ccc' } },
              y: { grid: { color: '#333' }, ticks: { color: '#ccc' } }
            },
            plugins: { legend: { labels: { color: '#E0E0E0' } } }
          }
        });
        localStorage.setItem('financeData', JSON.stringify({ monthlyCharges, monthlyPayments, totalCharges, totalPayments }));
      }

      // On load, restore saved data
      document.addEventListener('DOMContentLoaded', () => {
        // Wipe old finance data and file history on first load after this update
        if (!localStorage.getItem('financeDataReset_2025_05_15_pdf')) { // Changed reset key
          localStorage.removeItem('financeData');
          localStorage.removeItem('financeFileHistory');
          localStorage.removeItem('financeFileMonthMap'); // Clear map as well
          localStorage.setItem('financeDataReset_2025_05_15_pdf', 'true'); // Changed reset key
        }
        const saved = localStorage.getItem('financeData');
        if (saved) {
          const data = JSON.parse(saved);
          monthlyCharges = data.monthlyCharges || {};
          monthlyPayments = data.monthlyPayments || {};
          totalCharges = data.totalCharges || 0;
          totalPayments = data.totalPayments || 0;
          updateDisplay();
        }
      });

      // --- Event Listener for File Picker (supports multiple) ---
      document.getElementById('pdfPicker').addEventListener('change', async e => { // Made async
        const files = Array.from(e.target.files);
        if (!files.length) return;

        if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') { // Check if key is missing or is the placeholder
          alert("Gemini API key is not set or is invalid. Please create config.js with your key (see config.js.example for GEMINI_API_KEY) and ensure it is loaded.");
          e.target.value = null; // Clear the file input
          return;
        }

        for (const f of files) { // Process files one by one, allowing for async operations
          const fileName = f.name;
          const fileExtension = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();

          if (fileExtension === 'pdf') {
            // Show some loading indicator to the user if possible
            console.log(`Processing ${fileName}...`);
            try {
              await handlePdfFile(f); // Call the new PDF handler
            } catch (error) {
              console.error(`Error processing ${fileName}:`, error);
              alert(`An error occurred while processing ${fileName}. Check the console for details.`);
            }
          } else {
            alert("Unsupported file type. Please upload a PDF file.");
            // Clear the file input if any file is unsupported to prevent re-processing attempts
            e.target.value = null; 
            break; // Stop processing further files if one is invalid
          }
        }
        // Potentially clear file input after all files are processed, or let user manage it
        // e.target.value = null; 
      });

      // --- Function to process PDF files (placeholder for OpenAI API call) ---
      async function handlePdfFile(file) {
        const fileName = file.name;
        console.log(`Attempting to process PDF: ${fileName}`);
        const h1Title = document.querySelector('.content h1'); // More specific selector for the main title
        const originalTitle = h1Title ? h1Title.textContent : 'Personal Finance Tracker';
        if (h1Title) {
            h1Title.textContent = `Processing ${fileName}...`;
        }

        try {
          const base64File = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
          });

          const pureBase64 = base64File.substring(base64File.indexOf(',') + 1);
          const extractedData = await callGeminiPdfParser(pureBase64, fileName);

          if (!extractedData || !extractedData.transactions || !Array.isArray(extractedData.transactions)) {
            console.error("Failed to extract valid transaction data from PDF:", fileName, "Response:", extractedData);
            alert(`Could not extract transactions from ${fileName}. The API might have returned an unexpected format or no data. Check console.`);
            addFileToHistory(fileName, []);
            updateDisplay();
            return;
          }

          const fileInfo = extractMonthYearFromName(fileName);
          const overrideKey = fileInfo ? `${fileInfo.year}-${String(fileInfo.month).padStart(2, '0')}` : null;
          let contributedKeys = new Set();

          if (extractedData.transactions.length === 0) {
              console.warn(`No transactions found or extracted by AI for ${fileName}.`);
              addFileToHistory(fileName, []);
              updateDisplay();
              return;
          }

          extractedData.transactions.forEach(transaction => {
            const { date, amount, description } = transaction;
            const dt = new Date(date);
            const amt = Number(amount);

            if (isNaN(amt) || !date || isNaN(dt.getTime()) || dt.toString() === 'Invalid Date') {
              console.warn(`Skipping transaction from API: Invalid data. Date='${date}', Amount='${amt}', Description='${description}'`);
              return;
            }

            const keyToUse = overrideKey || `${dt.getUTCFullYear()}-${String(dt.getUTCMonth() + 1).padStart(2, '0')}`;
            contributedKeys.add(keyToUse);

            if (!monthlyCharges[keyToUse]) monthlyCharges[keyToUse] = 0;
            if (!monthlyPayments[keyToUse]) monthlyPayments[keyToUse] = 0;

            if (amt > 0) {
              monthlyCharges[keyToUse] += amt;
              totalCharges += amt;
            } else if (amt < 0) {
              monthlyPayments[keyToUse] += Math.abs(amt);
              totalPayments += Math.abs(amt);
            }
          });

          fileMonthMap[fileName] = Array.from(contributedKeys);
          saveFileMonthMap();
          addFileToHistory(fileName, Array.from(contributedKeys));
          updateDisplay();

        } catch (error) {
          console.error(`Error in handlePdfFile for ${fileName}:`, error);
          alert(`An error occurred while processing ${fileName}. Check the console for details. Error: ${error.message}`);
          addFileToHistory(fileName, []);
          updateDisplay();
        } finally {
           if (h1Title) {
             h1Title.textContent = originalTitle;
           }
        }
      }

      async function callGeminiPdfParser(base64Pdf, fileNameForContext) {
        console.log(`Sending ${fileNameForContext} to Google Gemini API for parsing...`);
        if (!GEMINI_API_KEY) {
            throw new Error("Gemini API key is not loaded. Please check config.js.");
        }
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

        const systemInstructionText = `You are a data extraction AI. You will receive a PDF bank statement. Your task is to:
1. Identify all individual financial transaction lines. Focus on itemized entries, not summary totals unless they are the only source for a specific transaction type.
2. For each transaction found, extract the date, description, and amount.
Return a single JSON object: \`{ "transactions": [ { "date": "YYYY-MM-DD", "description": "...", "amount": number }, ... ] }\`.
CRITICAL RULES for 'amount':
  - Charges/Debits/Purchases/Expenses/Withdrawals are POSITIVE numbers (e.g., 100.00).
  - Payments/Credits/Deposits/Income are NEGATIVE numbers (e.g., -50.00).
  - Examine transaction descriptions for keywords like 'Purchase', 'Fee', 'Withdrawal' (positive) or 'Payment', 'Deposit', 'Credit', 'Income' (negative).
  - If the PDF text clearly shows 'Debit' and 'Credit' columns, amounts in a 'Debit' column are positive, and amounts in a 'Credit' column are negative.
For 'date': Use 'YYYY-MM-DD'. If the full date isn't on the transaction line, infer the year and month from the overall statement period (often found in the filename or at the top/bottom of the PDF text). If day is missing, use '01'.
For 'description': Capture the full transaction detail as presented on the statement.
The response MUST be only the valid JSON object, with no extra text, explanations, or markdown formatting.`;

        const userPromptText = `Please analyze the attached PDF bank statement named '${fileNameForContext}' and extract all financial transactions according to the detailed system instructions. Pay utmost attention to correctly identifying and signing the 'amount' for each transaction (positive for charges, negative for payments/credits).`;

        const payload = {
          contents: [
            {
              parts: [
                { text: userPromptText },
                {
                  inline_data: {
                    mime_type: "application/pdf",
                    data: base64Pdf
                  }
                }
              ]
            }
          ],
          system_instruction: {
            parts: [
              { text: systemInstructionText }
            ]
          },
          generationConfig: {
            response_mime_type: "application/json",
            temperature: 0.2 
          }
        };

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const errorBody = await response.json().catch(() => response.text()); // Try to parse as JSON, fallback to text
            console.error("Gemini API Error Response:", errorBody);
            const errorMessage = errorBody.error && errorBody.error.message ? errorBody.error.message : JSON.stringify(errorBody);
            throw new Error(`Gemini API request failed with status ${response.status}: ${response.statusText}. Details: ${errorMessage}`);
          }

          const data = await response.json();
          console.log("Gemini API Raw Response:", data);

          if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) {
            const jsonString = data.candidates[0].content.parts[0].text;
            console.log("Gemini API JSON String Content:", jsonString);
            try {
                return JSON.parse(jsonString);
            } catch (parseError) {
                console.error("Failed to parse JSON from Gemini response:", parseError, "Raw content:", jsonString);
                // Check if it might already be an object (though API docs say it's a string with response_mime_type: "application/json")
                if (typeof jsonString === 'object') return jsonString;
                throw new Error("Failed to parse JSON from Gemini API response. Check console for raw output.");
            }
          } else {
            console.error("Unexpected Gemini API response structure:", data);
            throw new Error("Unexpected response structure from Gemini API. No valid content found.");
          }
        } catch (error) {
          console.error("Error calling Gemini API:", error);
          throw error; // Re-throw to be caught by handlePdfFile
        }
      }

      // --- Manual Reset: Clear all finance data, file history, and file-to-month map ---
      function resetFinanceData() {
        localStorage.removeItem('financeData');
        localStorage.removeItem('financeFileHistory');
        localStorage.removeItem('financeFileMonthMap');
        localStorage.removeItem('financeDataReset_2025_05_15_pdf'); // Ensured key is correct
        // Clear in-memory state
        fileHistory = [];
        fileMonthMap = {};
        monthlyCharges = {};
        monthlyPayments = {};
        totalCharges = 0;
        totalPayments = 0;
        updateDisplay();
        renderFileHistory();
        showFileHistory(false);
      }
      // Add a button for manual reset (for testing/cleanup)
      const resetBtn = document.createElement('button');
      resetBtn.textContent = 'Reset All Data';
      resetBtn.style.position = 'absolute';
      resetBtn.style.top = '18px';
      resetBtn.style.right = '40px';
      resetBtn.style.background = '#FF4C4C';
      resetBtn.style.color = '#fff';
      resetBtn.style.border = 'none';
      resetBtn.style.borderRadius = '8px';
      resetBtn.style.padding = '8px 18px';
      resetBtn.style.fontWeight = '600';
      resetBtn.style.cursor = 'pointer';
      resetBtn.style.zIndex = 1200;
      resetBtn.onclick = resetFinanceData;
      document.body.appendChild(resetBtn);
    </script>
  </div>
</body>
</html>
