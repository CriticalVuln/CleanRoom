<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  <title>Personal Finance Tracker</title>
  
  <!-- Immediate theme application to prevent white flash -->
  <script>
    (function() {
      // Check for saved theme preference and apply immediately
      let currentTheme = localStorage.getItem('dashboard-theme');
      
      // Migration: check for old theme key and migrate it
      if (!currentTheme) {
        const oldTheme = localStorage.getItem('theme');
        if (oldTheme) {
          currentTheme = oldTheme;
          localStorage.setItem('dashboard-theme', oldTheme);
          localStorage.removeItem('theme');
        } else {
          currentTheme = 'light';
        }
      }
      
      // Apply theme immediately to prevent flash
      document.documentElement.setAttribute('data-theme', currentTheme);
    })();
  </script>
  
  <style>
    /* === CSS VARIABLES FOR THEMING === */
    :root {
      /* Light Mode (Default) */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F8F9FA;
      --bg-tertiary: #F5F5F5;
      --text-primary: #333333;
      --text-secondary: #6B7280;
      --text-accent: #8B5CF6;
      --border-color: #E0E0E0;
      --shadow-light: rgba(0,0,0,0.08);
      --shadow-medium: rgba(0,0,0,0.1);
      --button-gradient-start: #8B5CF6;      --button-gradient-end: #A855F7;
      --button-shadow: rgba(139, 92, 246, 0.3);
      --button-hover-bg: #A855F7;
      --button-hover-glow: rgba(139, 92, 246, 0.6);
      --button-text-selected: #FFFFFF;
      --button-hover-border: rgba(139, 92, 246, 0.4);
      --button-hover-gradient-center: rgba(139, 92, 246, 0.4);
      --button-hover-gradient-mid: rgba(139, 92, 246, 0.2);
      --button-active-gradient-center: rgba(255, 255, 255, 0.3);
      --button-active-gradient-mid: rgba(255, 255, 255, 0.1);
      --switch-active: #8B5CF6;
      --priority-low: #4CAF50;
      --priority-medium: #FFC107;
      --priority-high: #F44336;
      --button-disabled-bg: #E5E7EB;
      --button-disabled-text: #9CA3AF;
    }

    /* Dark Mode */
    [data-theme="dark"] {
      --bg-primary: #0D0B14;
      --bg-secondary: #1A1625;
      --bg-tertiary: #211D30;
      --text-primary: #E0E0E0;
      --text-secondary: #A0A0A0;
      --text-accent: #63FFDA;
      --border-color: #4F4B68;
      --shadow-light: rgba(33,29,48,0.45);
      --shadow-medium: rgba(0,0,0,0.7);
      --button-gradient-start: #63FFDA;      --button-gradient-end: #63FFDA;
      --button-shadow: rgba(99, 255, 218, 0.3);
      --button-hover-bg: #52D9C3;
      --button-hover-glow: rgba(99, 255, 218, 1);
      --button-text-selected: #000000;
      --button-hover-border: rgba(99, 255, 218, 0.5);
      --button-hover-gradient-center: rgba(99, 255, 218, 0.4);
      --button-hover-gradient-mid: rgba(99, 255, 218, 0.2);
      --button-active-gradient-center: rgba(0, 0, 0, 0.3);
      --button-active-gradient-mid: rgba(0, 0, 0, 0.1);
      --switch-active: #A076F9;
      --priority-low: #4CAF50;
      --priority-medium: #FFC107;
      --priority-high: #F44336;
      --button-disabled-bg: #4F4B68;
      --button-disabled-text: #6B7280;
    }

    /* Global Reset and Base Styles */
    * { 
      box-sizing: border-box; 
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    /* Reusable Card Component */
    .card, .app-container {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px var(--shadow-medium);
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
    }
    .app-container {
      width: 100%;
      max-width: 1000px;
      padding: 25px;
      margin-top: 70px;
    }

    /* Content Layout */
    .content {
      width: 100%;
      max-width: 1400px;
      margin-top: 70px;
      margin-left: auto;
      margin-right: auto;
    }
    
    /* Chart Containers */
    .chart-container, .category-chart-container, .recent-transactions-container {
      position: relative;
    }
    .chart-container > h2, .category-chart-container h2, .recent-transactions-container h2 {
      text-align: center;
      color: var(--text-accent);
      font-weight: 600;
      margin-bottom: 15px;
      font-size: 1.2em;
    }    .category-chart-inner-container, .charges-payments-chart-inner-container {
      position: relative;
      height: 300px;
    }
    
    .category-chart-inner-container {
      height: 380px;
    }.category-chart-inner-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      padding: 15px 0;
    }    .category-chart-inner-container canvas {
      max-width: 100%;
      max-height: 100%;
    }    .charges-payments-chart-inner-container {
      height: 350px;
    }/* Page Elements */
    h1 {
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }
    
    #total {
      text-align: center;
      font-size: 1.1em;
      color: var(--text-primary);
    }
      /* Form Elements */
    #csvPicker {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
    }
    #csvPicker::file-selector-button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      background: var(--text-accent);
      color: var(--button-text-selected);
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;    }    /* Sidebar Navigation */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 60px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px 0;
    }
    
    .sidebar-nav {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .sidebar a {
      color: var(--text-accent);
      font-size: 24px;
      margin: 16px 0;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    .sidebar a:hover {
      transform: scale(1.1);
      color: var(--text-accent);
    }
    
    .sidebar a svg {
      width: 24px;
      height: 24px;
      fill: none;
      stroke: var(--text-accent);
      stroke-width: 2;
    }    /* Sidebar Dropdown Functionality */
    .sidebar-item {
      position: relative;
      margin: 16px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .sidebar-item-container {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      justify-content: center;    }

    .sidebar-item-main {
      display: flex;
      align-items: center;
      color: var(--text-accent);
      text-decoration: none;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .sidebar-item-main:hover {
      transform: scale(1.1);
      color: var(--text-accent);
    }

    .sidebar-item-main svg {
      width: 24px;
      height: 24px;
      fill: none;
      stroke: var(--text-accent);
      stroke-width: 2;
    }    .sidebar-submenu {
      position: absolute;
      top: 35px;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      visibility: hidden;
      transform: translateX(-50%) translateY(-10px);
      transition: all 0.3s ease;
      z-index: 1200;
    }.sidebar-submenu.expanded {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }    .sidebar-submenu a {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-accent);
      text-decoration: none;
      transition: all 0.3s ease;
      margin: 8px 0;
      padding: 16px;
      border-radius: 6px;
    }

    .sidebar-submenu a:last-child {
      border-bottom: none;
    }

    .sidebar-submenu a:hover {
      color: var(--text-accent);
      transform: scale(1.1);
      background: var(--bg-tertiary);
    }

    .sidebar-submenu a svg {
      width: 20px;
      height: 20px;
      stroke: var(--text-accent);
      stroke-width: 2;
      transition: all 0.3s ease;
    }/* Theme Toggle Button */
    .theme-toggle {
      width: 32px;
      height: 32px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-accent);
      padding: 0;
      margin: 10px;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      color: var(--text-accent);
      transform: scale(1.1);
      filter: brightness(1.2);
    }    .theme-toggle svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-accent);
      stroke-width: 2;
      fill: none;
      transition: stroke 0.3s ease;
    }

    .theme-toggle .sun-icon {
      display: block;
    }

    .theme-toggle .moon-icon {
      display: none;
    }

    [data-theme="dark"] .theme-toggle .sun-icon {
      display: none;
    }

    [data-theme="dark"] .theme-toggle .moon-icon {
      display: block;
    }/* Tab Components - Consolidated styling for File History and Banks tabs */
    .file-history-tab, .banks-tab, .upload-pdf-btn {
      position: absolute;
      top: 18px;
      background: var(--bg-tertiary);
      color: var(--text-accent);
      border: none;
      border-radius: 8px 8px 0 0;
      padding: 8px 22px 8px 18px;
      font-family: 'Poppins', sans-serif;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      z-index: 1100;
      box-shadow: 0 2px 8px var(--shadow-light);
      transition: background 0.15s, color 0.15s;
    }
    .file-history-tab {
      left: 70px;
    }
    .banks-tab {
      left: 200px;
    }
    .upload-pdf-btn {
      left: 330px;
    }
    .file-history-tab.active, .banks-tab.active, .upload-pdf-btn.active {
      background: var(--text-accent);
      color: var(--button-text-selected);
    }
      /* Panel Components - Consolidated styling for both panels */
    .file-history-panel {
      position: absolute;
      top: 54px;
      left: 70px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 16px var(--shadow-medium);
      min-width: 320px;
      max-width: 420px;
      padding: 18px 18px 10px 18px;
      z-index: 1100;
      display: none;
    }
    .file-history-panel h3 {
      margin: 0 0 10px 0;
      font-size: 1.1em;
      color: var(--text-accent);
      font-weight: 600;
    }    /* List Components */
    .file-history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 220px;
      overflow-y: auto;
    }
    .file-history-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
    }
    .file-history-list li:last-child { 
      border-bottom: none; 
    }
    .file-history-list .filename {
      flex: 1;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-history-list .delete-btn {
      background: none;
      border: none;
      color: var(--priority-high);
      font-size: 15px;
      cursor: pointer;
      margin-left: 12px;
      padding: 2px 8px;
      border-radius: 4px;
      transition: background 0.15s;
    }
    .file-history-list .delete-btn:hover {
      background: var(--bg-tertiary);
    }    /* Timeframe Controls - Consolidated */
    .timeframe-controls {
      text-align: center;
      margin-bottom: 15px;
      display: flex;
      justify-content: center;
      gap: 12px;
    }
    .timeframe-controls button {
      background: none;
      border: 1px solid transparent;
      color: var(--text-accent);
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      padding: 5px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s, box-shadow 0.2s;
    }
    .timeframe-controls button.active {
      background-color: var(--bg-primary);
      color: var(--text-accent);
      border-color: var(--text-accent);
      box-shadow: none;
    }    .timeframe-controls button:hover:not(.active) {
      background-color: transparent;
      color: var(--text-accent);
      border-color: transparent;
      box-shadow: 0 0 8px var(--button-hover-glow);
    }
    
    .upload-modal-btn:hover:not(.active):not(.primary) {
      background-color: transparent;
      color: var(--text-accent);
      border-color: transparent;
      box-shadow: 0 0 8px var(--button-hover-glow);
    }
    
    /* Layout Components */
    .charts-row-container {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 24px;
      margin-bottom: 24px;
    }
    .charts-row-container > .card {
      flex: 1 1 calc(50% - 12px);
      min-width: 300px;
      margin-bottom: 0;
    }      /* Recent Transactions Table */
    .recent-transactions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .recent-transactions-header h2 {
      margin: 0;
      color: var(--text-accent);
      font-weight: 600;
      font-size: 1.2em;
    }

    .search-container {
      position: relative;
      display: flex;
      align-items: center;
      max-width: 280px;
      flex: 1;
      margin-left: 20px;
    }

    #transactionSearchInput {
      width: 100%;
      padding: 8px 40px 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 0.9em;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
      outline: none;
    }

    #transactionSearchInput:focus {
      border-color: var(--text-accent);
      box-shadow: 0 0 0 2px rgba(99, 255, 218, 0.2);
    }

    #transactionSearchInput::placeholder {
      color: var(--text-secondary);
      opacity: 1;
    }

    .search-icon {
      position: absolute;
      right: 12px;
      width: 16px;
      height: 16px;
      stroke: var(--text-secondary);
      fill: none;
      stroke-width: 2;
      pointer-events: none;
      transition: stroke 0.3s ease;
    }

    #transactionSearchInput:focus + .search-icon {
      stroke: var(--text-accent);
    }

    .recent-transactions-table-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }
    .recent-transactions-table {
      width: 100%;
      border-collapse: collapse;
    }
    .recent-transactions-table th,
    .recent-transactions-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    .recent-transactions-table th {
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .recent-transactions-table td {
      color: var(--text-secondary);
    }
    .recent-transactions-table tr:last-child td {
      border-bottom: none;
    }
    .recent-transactions-table .amount-income {
      color: var(--text-accent);
      font-weight: 500;
    }
    .recent-transactions-table .amount-expense {
      color: var(--priority-high);
      font-weight: 500;
    }      /* Modal Components - Consolidated */
    .upload-modal {
      display: none;
      position: fixed;
      z-index: 1500;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }
    .upload-modal-content {
      background-color: var(--bg-secondary);
      margin: auto;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 8px 25px var(--shadow-medium);
      width: 90%;
      max-width: 550px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .upload-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    .upload-modal-header h2 {
      color: var(--text-primary);
      font-size: 1.4em;
      margin: 0;
    }
    .upload-modal-close-btn {
      color: var(--text-secondary);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
    }
    .upload-modal-close-btn:hover,
    .upload-modal-close-btn:focus {
      color: var(--text-primary);
    }    /* Upload Area Components */
    .upload-area {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      background-color: var(--bg-primary);
      transition: background-color 0.2s, border-color 0.2s;
    }
    .upload-area:hover {
      background-color: var(--bg-tertiary);
      border-color: var(--text-accent);
    }
    .upload-area-icon {
      font-size: 40px;
      color: var(--text-accent);
      margin-bottom: 15px;
    }
    .upload-area-text {
      color: var(--text-primary);
      font-size: 1.1em;
      margin-bottom: 8px;
    }
    .upload-area-subtext {
      color: var(--text-secondary);
      font-size: 0.9em;
    }
    #modalPdfInput {
      display: none;
    }
    #selectedFilesList {
      margin-top: 15px;
      max-height: 100px;
      overflow-y: auto;
      font-size: 0.9em;
      color: var(--text-secondary);
    }
    #selectedFilesList div {
      padding: 3px 0;
    }
    .upload-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }    /* Universal Button Styling - Consolidated */
    .upload-modal-btn {
      background: none;
      border: 1px solid transparent;
      color: var(--text-accent);
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      padding: 5px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
      --mouse-x: 50%;
      --mouse-y: 50%;
    }    .upload-modal-btn.primary {
      background-color: var(--bg-primary);
      color: var(--text-accent);
      border-color: var(--text-accent);
      box-shadow: none;
    }
    
    .upload-modal-btn.primary:hover {
      background-color: var(--bg-primary);
      color: var(--text-accent);
      border-color: var(--text-accent);
      box-shadow: 0 0 8px var(--button-hover-glow);
    }
    .upload-modal-btn.secondary {
      background: none;
      border: 1px solid transparent;
      color: var(--text-accent);
    }
    
    /* Progress Bar Component */
    #progressBarContainer {
      position: fixed;
      top: 0;      left: 0;
      width: 100%;
      background-color: var(--bg-primary);
      padding: 8px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.7);
      display: none;
      z-index: 9999;
    }
    #progressBar {
      width: 80%;      margin: 0 auto;
      height: 20px;
      background-color: var(--text-accent);
      background-image: linear-gradient(
        45deg,
        rgba(13, 11, 20, 0.25) 25%,
        transparent 25%,
        transparent 50%,
        rgba(13, 11, 20, 0.25) 50%,
        rgba(13, 11, 20, 0.25) 75%,
        transparent 75%,
        transparent
      );
      background-size: 40px 40px;
      border-radius: 5px;
      text-align: center;      line-height: 20px;
      color: var(--bg-primary);
      font-weight: bold;
      animation: progressBarAnimation 2s linear infinite;
      transition: width 0.3s ease-in-out;
    }
    @keyframes progressBarAnimation {
      0% { background-position: 40px 0; }
      100% { background-position: 0 0; }
    }    /* Top Controls */
    .top-right-controls {
      position: fixed;
      top: 20px;
      left: 80px;  /* Position just to the right of 60px sidebar */
      z-index: 1000;
      display: flex;
      gap: 16px;  /* Increased gap for better spacing */
      align-items: center;
    }

    .control-btn {
      background: var(--bg-tertiary);
      color: var(--text-accent);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px 16px;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px var(--shadow-light);
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .control-btn:hover {
      background: var(--text-accent);
      color: var(--button-text-selected);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--button-shadow);
    }

    .control-btn.active {
      background: var(--text-accent);
      color: var(--button-text-selected);
    }#agent-action-button {
      background-color: var(--text-accent);
      color: var(--bg-primary);
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }    #agent-action-button:hover {
      background-color: var(--button-hover-bg);
    }
      /* Consolidated Button States */
    button, .upload-modal-btn, .file-history-tab, .banks-tab, .control-btn, #agent-action-button {      background: transparent;
      border: 1px solid transparent;
      color: var(--text-accent);
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s, box-shadow 0.2s, border-color 0.2s;
      outline: none;
      box-shadow: none;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      vertical-align: middle;
    }
    .file-history-tab, .banks-tab {
      padding: 8px 22px 8px 18px;
    }
    .control-btn, #agent-action-button {
      padding: 10px 16px;
    }
    .upload-modal-btn {
      padding: 10px 20px;
    }
      /* Button Hover States */
    button:not(.active):not(:disabled):hover,
    .upload-modal-btn:not(.active):not(:disabled):hover,
    .file-history-tab:not(.active):not(:disabled):hover,
    .banks-tab:not(.active):not(:disabled):hover,
    .control-btn:not(.active):not(:disabled):hover,
    #agent-action-button:not(.active):not(:disabled):hover {
      background-color: transparent;
      color: var(--text-accent);
      border-color: transparent;
      box-shadow: 0 0 8px var(--text-accent);
    }      /* === ANIMATED GRADIENT EFFECTS === */
    button, .upload-modal-btn, .file-history-tab, .banks-tab, .control-btn, #agent-action-button, .timeframe-controls button {
      position: relative;
      overflow: hidden;
      --mouse-x: 50%;
      --mouse-y: 50%;
    }
    
    button::before, .upload-modal-btn::before, .file-history-tab::before, .banks-tab::before, .control-btn::before, #agent-action-button::before, .timeframe-controls button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(
        circle at var(--mouse-x) var(--mouse-y),
        var(--button-hover-gradient-center) 0%,
        var(--button-hover-gradient-mid) 30%,
        transparent 60%
      );
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: inherit;
      z-index: 1;
      pointer-events: none;
    }
      button:hover::before, .upload-modal-btn:hover::before, .file-history-tab:hover::before, .banks-tab:hover::before, .control-btn:hover::before, #agent-action-button:hover::before, .timeframe-controls button:hover::before {
      opacity: 1;
    }
    
    button span, .upload-modal-btn span, .file-history-tab span, .banks-tab span, .control-btn span, #agent-action-button span, .timeframe-controls button span {
      position: relative;
      z-index: 2;
    }
    
    button.active, .upload-modal-btn.active, .file-history-tab.active, .banks-tab.active, .control-btn.active, #agent-action-button.active, .timeframe-controls button.active {
      background: linear-gradient(135deg, var(--button-gradient-start), var(--button-gradient-end));
      color: var(--button-text-selected);
      border-color: var(--text-accent);
      box-shadow: 0 4px 15px var(--button-shadow);
    }
    
    button.active::before, .upload-modal-btn.active::before, .file-history-tab.active::before, .banks-tab.active::before, .control-btn.active::before, #agent-action-button.active::before, .timeframe-controls button.active::before {
      background: radial-gradient(
        circle at var(--mouse-x) var(--mouse-y),
        var(--button-active-gradient-center) 0%,
        var(--button-active-gradient-mid) 30%,
        transparent 60%
      );
      opacity: 0.7;
    }
      button.active:hover::before, .upload-modal-btn.active:hover::before, .file-history-tab.active:hover::before, .banks-tab.active:hover::before, .control-btn.active:hover::before, #agent-action-button.active:hover::before, .timeframe-controls button.active:hover::before {
      opacity: 1;
    }
      /* Button Active States */
    button.active, button:active,
    .upload-modal-btn.active, .upload-modal-btn:active,
    .file-history-tab.active, .file-history-tab:active,
    .banks-tab.active, .banks-tab:active,
    .control-btn.active, .control-btn:active,
    #agent-action-button.active, #agent-action-button:active {
      background-color: var(--bg-primary);
      color: var(--text-accent);
      border: 1px solid var(--text-accent);
      box-shadow: none;
    }
    
    /* Button Disabled States */
    button:disabled,
    .upload-modal-btn:disabled,
    .file-history-tab:disabled,
    .banks-tab:disabled,
    .control-btn:disabled,
    #agent-action-button:disabled {
      color: #4F4B68;
      background-color: #211D30;
      border-color: #4F4B68;
      cursor: not-allowed;
      box-shadow: none;
    }    /* Category Chart Dropdown Positioning */
    .category-chart-container {
      position: relative;
    }
      .category-chart-header {
      position: relative;
      margin-bottom: 5px;
    }    .category-chart-header h2 {
      margin: 0 0 20px 0;
      text-align: center;
      color: var(--text-accent);
      font-weight: 600;
      font-size: 1.2em;
    }
    #categoryMonthSelector {
      position: absolute;
      top: 0;
      right: 0;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 6px 12px;
      color: var(--text-primary);
      font-size: 0.9em;
      min-width: 140px;
      transition: all 0.3s ease;
    }
    
    #categoryMonthSelector:focus {
      outline: none;
      border-color: var(--text-accent);
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }

    /* Budget Widget Styling */
    .budget-widget-container {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .budget-widget-header {
      padding: 20px;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(139, 92, 246, 0.1) 100%);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .budget-widget-header:hover {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(139, 92, 246, 0.15) 100%);
    }

    .budget-widget-header h2 {
      margin: 0;
      color: var(--text-accent);
      font-weight: 600;
      font-size: 1.3em;
    }

    .budget-total-display {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .budget-total-label {
      color: var(--text-muted);
      font-size: 0.9em;
      font-weight: 500;
    }

    .budget-total-amount {
      color: var(--text-accent);
      font-size: 1.5em;
      font-weight: 700;
    }

    .budget-remaining {
      color: var(--text-muted);
      font-size: 0.85em;
    }

    .budget-remaining.positive {
      color: #10b981;
    }

    .budget-remaining.negative {
      color: #ef4444;
    }    .budget-toggle-btn {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.2);
      padding: 8px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      min-height: 40px;
    }

    .budget-toggle-btn:hover {
      background: rgba(139, 92, 246, 0.2);
      border-color: rgba(139, 92, 246, 0.4);
      transform: scale(1.05);
    }

    .budget-chevron {
      width: 20px;
      height: 20px;
      stroke: var(--text-accent);
      fill: none;
      stroke-width: 2.5;
      transition: transform 0.3s ease;
    }

    .budget-widget-container.collapsed .budget-chevron {
      transform: rotate(180deg);
    }

    .budget-widget-content {
      padding: 20px;
      max-height: 1000px;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .budget-widget-container.collapsed .budget-widget-content {
      max-height: 0;
      padding: 0 20px;
    }

    .budget-month-selector-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 8px;
    }

    .budget-month-selector-container label {
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.95em;
    }

    #budgetMonthSelector {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-size: 0.9em;
      min-width: 160px;
      transition: all 0.3s ease;
    }

    #budgetMonthSelector:focus {
      outline: none;
      border-color: var(--text-accent);
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }

    .budget-categories-container {
      background: var(--bg-secondary);
      border-radius: 8px;
      overflow: hidden;
    }    .budget-categories-header {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr 50px;
      gap: 16px;
      padding: 16px;
      background: linear-gradient(135deg, var(--bg-primary) 0%, rgba(139, 92, 246, 0.05) 100%);
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      color: var(--text-accent);
      font-size: 0.9em;
    }

    .budget-categories-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .budget-category-item {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr 50px;
      gap: 16px;
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s ease;
      align-items: center;
    }

    .budget-category-item:hover {
      background: rgba(139, 92, 246, 0.05);
    }

    .budget-category-item:last-child {
      border-bottom: none;
    }

    .budget-category-name {
      color: var(--text-primary);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .budget-amount {
      color: var(--text-muted);
      font-family: 'Courier New', monospace;
    }

    .budget-amount.spent {
      color: #ef4444;
    }

    .budget-amount.remaining.positive {
      color: #10b981;
    }

    .budget-amount.remaining.negative {
      color: #ef4444;
    }

    .budget-progress-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .budget-progress-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-primary);
      border-radius: 4px;
      overflow: hidden;
    }

    .budget-progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
    }

    .budget-progress-fill.over-budget {
      background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
    }    .budget-progress-text {
      font-size: 0.75em;
      color: var(--text-muted);
      text-align: center;
      font-weight: 500;
    }    /* Budget Category Delete Button - Enhanced Styling from Productivity Tracker */
    .budget-delete-btn {
      background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
      border: 1px solid rgba(244, 67, 54, 0.2);
      color: var(--priority-high);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      --mouse-x: 50%;
      --mouse-y: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 32px;
      min-width: 32px;
      box-shadow: 
        0 2px 4px var(--shadow-light),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      background: linear-gradient(145deg, 
        rgba(244, 67, 54, 0.05), 
        rgba(244, 67, 54, 0.02)
      );
    }

    .budget-delete-btn:hover {
      background: linear-gradient(145deg, 
        rgba(244, 67, 54, 0.15), 
        rgba(244, 67, 54, 0.08)
      );
      border-color: rgba(244, 67, 54, 0.6);
      box-shadow: 
        0 4px 12px rgba(244, 67, 54, 0.25),
        0 2px 4px var(--shadow-light),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transform: translateY(-2px) scale(1.05);
      color: var(--priority-high);
    }

    .budget-delete-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 
        0 1px 2px var(--shadow-light),
        inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Enhanced animated gradient effects for delete button */
    .budget-delete-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(
        circle at var(--mouse-x) var(--mouse-y),
        rgba(255, 255, 255, 0.15) 0%,
        rgba(255, 255, 255, 0.05) 30%,
        transparent 60%
      );
      opacity: 0;
      transition: opacity 0.4s ease;
      border-radius: inherit;
      z-index: 1;
      pointer-events: none;
    }

    .budget-delete-btn:hover::before {
      opacity: 1;
    }

    /* Subtle inner glow effect */
    .budget-delete-btn::after {
      content: '';
      position: absolute;
      top: 1px;
      left: 1px;
      right: 1px;
      bottom: 1px;
      background: linear-gradient(145deg, 
        rgba(244, 67, 54, 0.1), 
        transparent 50%
      );
      border-radius: 6px;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 0;
    }

    .budget-delete-btn:hover::after {
      opacity: 1;
    }

    /* SVG icon styling for delete button */
    .budget-delete-btn svg {
      width: 14px;
      height: 14px;
      position: relative;
      z-index: 2;
      pointer-events: none;
    }
    
    .budget-delete-btn .trash-icon {
      fill: currentColor;
    }

    /* Budget Modal Styles */
    .budget-modal {
      display: none;
      position: fixed;
      z-index: 1600;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      align-items: center;
      justify-content: center;
    }

    .budget-modal-content {
      background-color: var(--bg-secondary);
      margin: auto;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 8px 25px var(--shadow-medium);
      width: 90%;
      max-width: 450px;
      position: relative;
      border: 1px solid var(--border-color);
    }

    .budget-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .budget-modal-header h3 {
      margin: 0;
      color: var(--text-primary);
      font-size: 1.2em;
      font-weight: 600;
    }

    .budget-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .budget-modal-close:hover {
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    .budget-modal-body {
      margin-bottom: 20px;
    }

    .budget-modal-field {
      margin-bottom: 15px;
    }

    .budget-modal-field label {
      display: block;
      margin-bottom: 5px;
      color: var(--text-primary);
      font-weight: 500;
    }

    .budget-modal-field input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .budget-modal-field input:focus {
      outline: none;
      border-color: var(--text-accent);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .budget-modal-message {
      color: var(--text-primary);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .budget-modal-category-name {
      color: var(--text-accent);
      font-weight: 600;
    }

    .budget-modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .budget-modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      min-width: 80px;
    }

    .budget-modal-btn.primary {
      background-color: var(--text-accent);
      color: white;
    }

    .budget-modal-btn.primary:hover {
      background-color: #7c3aed;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .budget-modal-btn.secondary {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .budget-modal-btn.secondary:hover {
      background-color: var(--bg-secondary);
      border-color: var(--text-accent);
    }

    .budget-modal-btn.danger {
      background-color: #ef4444;
      color: white;
    }

    .budget-modal-btn.danger:hover {
      background-color: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .budget-success-message {
      color: #10b981;
      text-align: center;
      font-weight: 500;
    }

    /* Budget Actions Container and Buttons */
    .budget-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      padding: 20px 16px 16px 16px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      margin-top: 16px;
    }

    .budget-action-btn {
      background: transparent;
      border: 1px solid var(--text-accent);
      color: var(--text-accent);
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      min-height: 44px;
      min-width: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      --mouse-x: 50%;
      --mouse-y: 50%;
      box-shadow: 0 2px 8px var(--shadow-light);
    }

    .budget-action-btn:hover {
      background: var(--text-accent);
      color: var(--button-text-selected);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--button-shadow);
    }

    .budget-action-btn span {
      position: relative;
      z-index: 2;
    }

    .budget-action-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(
        circle at var(--mouse-x) var(--mouse-y),
        var(--button-hover-gradient-center) 0%,
        var(--button-hover-gradient-mid) 30%,
        transparent 60%
      );
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: inherit;
      z-index: 1;
      pointer-events: none;
    }

    .budget-action-btn:hover::before {
      opacity: 1;
    }

    /* ...existing code... */
  </style>

  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- ―――---- added helper libraries ----――― -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script> <!-- Chart.js UMD bundle :contentReference[oaicite:1]{index=1} -->
  <!-- ADDED: Date Adapter for Chart.js Time Scale -->
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script> <!-- date-fns library -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script> <!-- date-fns adapter -->  <script src="config.js"></script>
  <!-- Ensure config.js is loaded before any other scripts that use GEMINI_API_KEY -->
  <script src="theme.js"></script>
</head>
<body>  <div class="sidebar">
    <div class="sidebar-nav">      <a href="Landing Page.html" title="Home">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 10L12 3l9 7v11a1 1 0 0 1-1 1h-6v-7h-4v7H4a1 1 0 0 1-1-1V10z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>      <!-- Personal Finance Tracker with Dropdown -->
      <div class="sidebar-item">
        <div class="sidebar-item-container">
          <a href="Personal Finance Tracker.html" title="Finance Tracker" class="sidebar-item-main" id="financeMainIcon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <polyline points="3 17 8 12 13 16 21 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div><div class="sidebar-submenu" id="financeSubmenu">
          <a href="#" title="Investment Tracker">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 3v18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M7 12l3-3 4 4 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div>      </div>      <div class="sidebar-item">
        <div class="sidebar-item-container">
          <a href="Productivity Tracker.html" class="sidebar-item-main" title="Productivity Tracker" id="productivityMainIcon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
              <polyline points="12 7 12 12 15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div><div class="sidebar-submenu" id="productivitySubmenu">          <a href="#" title="Nutrition Tracker">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <!-- Stylized Apple icon for nutrition/food tracking -->
              <path d="M12 4C9.5 4 7.5 5.5 7 8C6.5 10.5 7 13.5 8.5 16C9.5 17.5 10.5 19 12 19C13.5 19 14.5 17.5 15.5 16C17 13.5 17.5 10.5 17 8C16.5 5.5 14.5 4 12 4Z" fill="currentColor"/>
              <!-- Apple dent/dimple at top -->
              <path d="M12 4C11.5 4.5 11 5 11.5 5.5C12 6 12.5 5.5 13 5C13.5 4.5 13 4 12.5 3.8C12.2 3.9 12 4 12 4Z" fill="currentColor"/>
              <!-- Apple stem -->
              <rect x="11.5" y="2" width="1" height="2.5" rx="0.5" fill="currentColor"/>
              <!-- Apple leaf -->
              <ellipse cx="13.5" cy="3" rx="1.5" ry="0.8" fill="currentColor" opacity="0.8" transform="rotate(30 13.5 3)"/>
              <!-- Apple highlight/shine -->
              <ellipse cx="10" cy="8" rx="1" ry="2" fill="currentColor" opacity="0.3"/>
            </svg>
          </a>
          <a href="#" title="Fitness Tracker">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <!-- Dumbbell icon for fitness tracking -->
              <rect x="2" y="9" width="4" height="6" rx="2" fill="currentColor"/>
              <rect x="18" y="9" width="4" height="6" rx="2" fill="currentColor"/>
              <rect x="6" y="11" width="12" height="2" fill="currentColor"/>
              <circle cx="4" cy="8" r="1.5" fill="currentColor"/>
              <circle cx="4" cy="16" r="1.5" fill="currentColor"/>
              <circle cx="20" cy="8" r="1.5" fill="currentColor"/>
              <circle cx="20" cy="16" r="1.5" fill="currentColor"/>
            </svg>
          </a>
        </div>
      </div>
    </div>
    
    <!-- Theme Toggle Button -->
    <button id="themeToggle" title="Toggle Dark/Light Mode" class="theme-toggle">
      <svg viewBox="0 0 24 24" class="sun-icon">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
      <svg viewBox="0 0 24 24" class="moon-icon" style="display: none;">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
    </button>
  </div>  <!-- New: Top Right Controls Button -->
  <div class="top-right-controls">
    <button id="banksTab" class="control-btn">Banks</button>
    <button id="openPdfUploadModalBtn" class="control-btn">Upload PDF</button>
    <button id="fileHistoryTab" class="control-btn">File History</button>
    <button id="agent-action-button" class="control-btn">Generate Presentation</button>
  </div>
  <div class="content">
    <h1>Personal Finance Tracker</h1>
    <!-- Modified: This input will now trigger the modal. We'll hide its default appearance. -->
    <input id="pdfPicker" type="file" accept=".pdf" multiple style="display: none;">

    <div id="total"></div>

    <!-- New PDF Upload Modal -->
    <div id="pdfUploadModal" class="upload-modal">
      <div class="upload-modal-content">
        <div class="upload-modal-header">
          <h2>Upload PDF Statements</h2>
          <button id="closeUploadModalBtn" class="upload-modal-close-btn">&times;</button>
        </div>
        
        <label for="modalPdfInput" class="upload-area" id="uploadAreaLabel">
          <div class="upload-area-icon">&#x21E7;</div> <!-- Unicode UPWARDS ARROW -->
          <div class="upload-area-text">Drag & drop files or click to choose files</div>
          <div class="upload-area-subtext">Supported file types: PDF</div>
        </label>
        <input id="modalPdfInput" type="file" accept=".pdf" multiple>
        <div id="selectedFilesList">
          <!-- Selected files will be listed here -->
        </div>

        <div class="upload-modal-footer">
          <button id="cancelUploadBtn" class="upload-modal-btn secondary">Cancel</button>
          <button id="confirmUploadBtn" class="upload-modal-btn primary">Upload</button>
        </div>
      </div>
    </div>
    <!-- End New PDF Upload Modal -->    <!-- Budgeting Tool Widget -->
    <div class="budget-widget-container card">
      <div class="budget-widget-header" id="budgetWidgetHeader">
        <h2>Monthly Budget Tracker</h2>
        <div class="budget-total-display">
          <span class="budget-total-label">Total Budget:</span>
          <span class="budget-total-amount" id="totalBudgetAmount">$0</span>
          <span class="budget-remaining" id="budgetRemaining">($0 remaining)</span>
        </div>
        <button class="budget-toggle-btn" id="budgetToggleBtn" title="Expand/Collapse Budget Details">
          <svg viewBox="0 0 24 24" class="budget-chevron">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>
      </div>
      
      <div class="budget-widget-content" id="budgetWidgetContent">
        <div class="budget-month-selector-container">
          <label for="budgetMonthSelector">Budget for:</label>
          <select id="budgetMonthSelector"></select>
        </div>
        
        <div class="budget-categories-container">
          <div class="budget-categories-header">
            <span>Category</span>
            <span>Budget</span>
            <span>Spent</span>
            <span>Remaining</span>
            <span>Progress</span>
          </div>
          
          <div id="budgetCategoriesList" class="budget-categories-list">
            <!-- Category budget items will be dynamically inserted here -->
          </div>            <div class="budget-actions">
            <button id="addCategoryBudgetBtn" class="budget-action-btn"><span>Add Category</span></button>
            <button id="resetBudgetBtn" class="budget-action-btn"><span>Reset Budget</span></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Row container for side-by-side charts -->
    <div class="charts-row-container">
      <div class="chart-container card">
        <h2>Expenses</h2> <!-- Changed from Charges vs Payments, removed inline style -->
        <div class="timeframe-controls">
          <button data-chart="expenses" data-range="day">Day</button>
          <button data-chart="expenses" data-range="week">Week</button>
          <button data-chart="expenses" data-range="month" class="active">Month</button>
          <button data-chart="expenses" data-range="year">Year</button>
        </div>
        <div class="charges-payments-chart-inner-container"> <!-- NEW WRAPPER -->
          <canvas id="spendChart"></canvas>
        </div>
      </div>      <div class="category-chart-container card"> <!-- Ensured .card class is present -->
        <div class="category-chart-header">
          <h2>Spending Categories</h2>
          <select id="categoryMonthSelector"></select>
        </div>
        <div class="category-chart-inner-container">
          <canvas id="categorySpendChart"></canvas>
        </div>
      </div>
    </div>    <!-- New Recent Transactions Widget -->
    <div class="recent-transactions-container card">
      <div class="recent-transactions-header">
        <h2>Recent Transactions</h2>
        <div class="search-container">
          <input type="text" id="transactionSearchInput" placeholder="Search transactions..." />
          <svg class="search-icon" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="M21 21l-4.35-4.35"></path>
          </svg>
        </div>
      </div>
      <div class="recent-transactions-table-container">        <table class="recent-transactions-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Category</th>
              <th>Amount</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody id="recentTransactionsBody">
            <!-- Transactions will be populated here by JavaScript -->
          </tbody>
        </table>
      </div>    </div>

    <div id="fileHistoryPanel" class="file-history-panel">
      <h3>Uploaded Files</h3>
      <ul id="fileHistoryList" class="file-history-list"></ul>
    </div>    <!-- New Banks Panel (initially hidden) -->
    <div id="banksPanel" class="file-history-panel" style="display:none; position:absolute; top:54px; left:200px;">
      <h3>Banks</h3>
      <ul id="banksList" class="file-history-list">
        <li style="color:var(--text-secondary);">No banks added yet.</li>
      </ul>
      <div style="text-align:right; margin-top:12px;">
        <button id="importBanksBtn" class="upload-modal-btn primary">Import</button>
      </div>
    </div>

    <div id="progressBarContainer">
      <div id="progressBar">Processing...</div>
    </div>

    <!-- Budget Modals -->
    <!-- Add Category Modal -->
    <div id="budgetAddCategoryModal" class="budget-modal">
      <div class="budget-modal-content">
        <div class="budget-modal-header">
          <h3>Add Budget Category</h3>
          <span class="budget-modal-close" id="closeAddCategoryModal">&times;</span>
        </div>
        <div class="budget-modal-body">
          <div class="budget-modal-field">
            <label for="budgetCategoryNameInput">Category Name:</label>
            <input type="text" id="budgetCategoryNameInput" placeholder="e.g., Groceries, Entertainment">
          </div>
          <div class="budget-modal-field">
            <label for="budgetCategoryAmountInput">Budget Amount:</label>
            <input type="number" id="budgetCategoryAmountInput" placeholder="0.00" step="0.01" min="0">
          </div>
        </div>
        <div class="budget-modal-actions">
          <button class="budget-modal-btn secondary" id="cancelAddCategoryBtn">Cancel</button>
          <button class="budget-modal-btn primary" id="confirmAddCategoryBtn">Add Category</button>
        </div>
      </div>
    </div>

    <!-- Reset Budget Modal -->
    <div id="budgetResetModal" class="budget-modal">
      <div class="budget-modal-content">
        <div class="budget-modal-header">
          <h3>Reset Budget</h3>
          <span class="budget-modal-close" id="closeResetModal">&times;</span>
        </div>
        <div class="budget-modal-body">
          <div class="budget-modal-message">
            Are you sure you want to reset the budget for this month? This will clear all category budgets and cannot be undone.
          </div>
        </div>
        <div class="budget-modal-actions">
          <button class="budget-modal-btn secondary" id="cancelResetBtn">Cancel</button>
          <button class="budget-modal-btn danger" id="confirmResetBtn">Reset Budget</button>
        </div>
      </div>
    </div>

    <!-- Delete Category Modal -->
    <div id="budgetDeleteCategoryModal" class="budget-modal">
      <div class="budget-modal-content">
        <div class="budget-modal-header">
          <h3>Delete Category</h3>
          <span class="budget-modal-close" id="closeDeleteCategoryModal">&times;</span>
        </div>
        <div class="budget-modal-body">
          <div class="budget-modal-message">
            Are you sure you want to delete the category "<span class="budget-modal-category-name" id="deleteCategoryName"></span>"?
          </div>
        </div>
        <div class="budget-modal-actions">
          <button class="budget-modal-btn secondary" id="cancelDeleteCategoryBtn">Cancel</button>
          <button class="budget-modal-btn danger" id="confirmDeleteCategoryBtn">Delete Category</button>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div id="budgetSuccessModal" class="budget-modal">
      <div class="budget-modal-content">
        <div class="budget-modal-header">
          <h3>Success</h3>
          <span class="budget-modal-close" id="closeSuccessModal">&times;</span>
        </div>
        <div class="budget-modal-body">
          <div class="budget-success-message" id="successMessage">
            Budget data saved successfully!
          </div>
        </div>
        <div class="budget-modal-actions">
          <button class="budget-modal-btn primary" id="okSuccessBtn">OK</button>
        </div>
      </div>
    </div>

    <script>
      // Helper to extract month/year from filename
      function extractMonthYearFromName(name) {
        if (typeof name !== 'string') return null;
        const trimmedName = name.trim();

        const monthMap = {
          jan: 1, january: 1, feb: 2, february: 2, mar: 3, march: 3, apr: 4, april: 4,
          may: 5, jun: 6, june: 6, jul: 7, july: 7, aug: 8, august: 8, sep: 9, september: 9,
          oct: 10, october: 10, nov: 11, november: 11, dec: 12, december: 12
        };
        const monthPattern = '(January|Jan|February|Feb|March|Mar|April|Apr|May|June|Jun|July|Jul|August|Aug|September|Sep|Oct|October|November|Nov|December|Dec)';

        const textualMatchMonthYear = trimmedName.match(new RegExp(monthPattern + '\\s+(\\d{4})', 'i'));

        if (textualMatchMonthYear && textualMatchMonthYear[1] && textualMatchMonthYear[2]) {
          const monthName = textualMatchMonthYear[1].toLowerCase();
          const year = parseInt(textualMatchMonthYear[2], 10);
          const month = monthMap[monthName];
          if (month && year >= 1900 && year <= 2100) { // Added year range check
            return { year, month };
          }
        }

        // Fallback: Try to match "YYYY Month" (less common for user's stated format)
        const textualMatchYearMonth = trimmedName.match(new RegExp('(\\d{4})\\s+' + monthPattern, 'i'));
         if (textualMatchYearMonth && textualMatchYearMonth[1] && textualMatchYearMonth[2]) {
          const year = parseInt(textualMatchYearMonth[1], 10);
          const monthName = textualMatchYearMonth[2].toLowerCase();
          const month = monthMap[monthName];
          if (month && year >= 1900 && year <= 2100) {
            return { year, month };
          }
        }

        // Fallback to numeric month and year (e.g., "2025-03", "2025_3")
        const numericDateMatch = trimmedName.match(/(\\d{4})[-_]?([0-1]?[0-9])/);
        if (numericDateMatch && numericDateMatch[1] && numericDateMatch[2]) {
          const year = parseInt(numericDateMatch[1], 10);
          const month = parseInt(numericDateMatch[2], 10);
          if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12) {
            return { year, month };
          }
        }
        console.warn('Could not extract month/year from filename:', name); // Added warning
        return null;
      }
      let chart = null;
      
      let dailyActivity = {}; // New: {"YYYY-MM-DD": {charges: 0, payments: 0, dcIncome: 0, categories: {"Groceries": 0,...}}}
      let globalAllTransactions = []; // New: To store all individual transactions

      let categoryChart = null;
      const CATEGORIES = ["Groceries", "Food Delivery/Restaurant", "Gas", "Misc", "Other"];      // --- New: N8N Webhook URL ---
      const N8N_WEBHOOK_URL = "https://criticalvuln.app.n8n.cloud/webhook-test/f597b035-7b41-496a-8e8e-f3102a67508a"; // <<< REPLACE WITH YOUR ACTUAL N8N WEBHOOK URL

      let sharedChartTimeframe = 'month'; // Shared timeframe for charts

      // API Key will now be loaded from config.js
      const GEMINI_API_KEY = window.APP_CONFIG && window.APP_CONFIG.GEMINI_API_KEY;

      // --- File History State ---
      let fileHistory = JSON.parse(localStorage.getItem('financeFileHistory') || '[]');
  
      let fileDataKeysMap = JSON.parse(localStorage.getItem('financeFileDataKeysMap') || '{}'); // New: {"filename": ["YYYY-MM-DD", ...]}
      let globalAllTransactionsStorageKey = 'financeGlobalAllTransactions'; // New

      const progressBarContainer = document.getElementById('progressBarContainer');
      const progressBar = document.getElementById('progressBar');
      // const originalStatusElement = document.getElementById('yourStatusMessageElementId'); // Optional: Replace ID

      function showProcessingBar(message = "Processing file...") {
   
        if (progressBarContainer && progressBar) {
          progressBar.textContent = message;
          progressBarContainer.style.display = 'block';
        }
      }

      function hideProcessingBar() {
        if (progressBarContainer) {
          progressBarContainer.style.display = 'none';
        }
       
      }
    
      function setupTimeframeControls() {
        const timeframeButtons = document.querySelectorAll('.timeframe-controls button[data-range]');

        timeframeButtons.forEach(button => {
          button.addEventListener('click', (event) => {
            const clickedButton = event.target;
            // Ensure the clicked element is a button with data-range
            if (!clickedButton.matches('button[data-range]')) return;

            const newTimeframe = clickedButton.dataset.range;
            
            // Update the shared timeframe state
            sharedChartTimeframe = newTimeframe;

            // Update 'active' class on ALL timeframe buttons
            document.querySelectorAll('.timeframe-controls button[data-range]').forEach(btn => {
              btn.classList.remove('active');
              if (btn.dataset.range === newTimeframe) {
                btn.classList.add('active');
              }
            });            // Re-render charts with the new timeframe
            if (typeof renderSpendChart === 'function') {
              renderSpendChart(sharedChartTimeframe);
            }
          });
        });
      }
      // --- End Synchronized Timeframe Controls ---

      function saveFileDataKeysMap() { // New name
        localStorage.setItem('financeFileDataKeysMap', JSON.stringify(fileDataKeysMap));
      }

      // --- File History UI Logic ---
      const fileHistoryTab = document.getElementById('fileHistoryTab');
      const fileHistoryPanel = document.getElementById('fileHistoryPanel');
      const fileHistoryList = document.getElementById('fileHistoryList');

      function renderFileHistory() {
        // Guard against missing element
        if (!fileHistoryList) return;
        fileHistoryList.innerHTML = '';
        if (!fileHistory.length) {
          fileHistoryList.innerHTML = '<li style="color:#A0A0A0;">No files uploaded yet.</li>';
          return;
        }

        // Sort fileHistory by date (year, then month), then by name for undated files
        fileHistory.sort((a, b) => {
          const dateA = extractMonthYearFromName(a.name);
          const dateB = extractMonthYearFromName(b.name);

          if (dateA && dateB) {
            if (dateA.year !== dateB.year) {
              return dateA.year - dateB.year; // Sort by year ascending
            }
            return dateA.month - dateB.month; // Then by month ascending
          } else if (dateA) {
            return -1; // dateA (has date) comes before dateB (no date)
          } else if (dateB) {
            return 1;  // dateB (has date) comes before dateA (no date)
          } else {
            // Neither has a parseable date, sort by name alphabetically
            return a.name.localeCompare(b.name);
          }
        });

        fileHistory.forEach(f => {
          const li = document.createElement('li');
          const nameSpan = document.createElement('span');
          nameSpan.className = 'filename';
          nameSpan.textContent = f.name;
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-btn';
          delBtn.textContent = 'Delete';
          delBtn.onclick = (event) => { // Add event parameter
            event.stopPropagation(); // Stop the click from bubbling to the document
            deleteFileHistory(f.name);
          };
          li.appendChild(nameSpan);
          li.appendChild(delBtn);
          fileHistoryList.appendChild(li);
        });
      }

      function showFileHistory(show) {
        // Guard against missing elements
        if (!fileHistoryPanel || !fileHistoryTab) return;
         if (show) {
           fileHistoryPanel.style.display = 'block';
           fileHistoryTab.classList.add('active');
           renderFileHistory();
         } else {
           fileHistoryPanel.style.display = 'none';
           fileHistoryTab.classList.remove('active');
         }
      }
      if (fileHistoryTab) {
        fileHistoryTab.addEventListener('click', () => {
          showFileHistory(fileHistoryPanel.style.display !== 'block');
        });
      }
      if (fileHistoryPanel) {
        document.addEventListener('click', e => {
          if (!fileHistoryPanel.contains(e.target) && e.target !== fileHistoryTab) {
            showFileHistory(false);
          }
        });
      }

      function addFileToHistory(name, keys) { // keys are now YYYY-MM-DD
        if (!fileHistory.some(f => f.name === name)) {
          fileHistory.push({ name });
          localStorage.setItem('financeFileHistory', JSON.stringify(fileHistory));
        }
        if (Array.isArray(keys) && keys.length) {
          fileDataKeysMap[name] = keys; // Store daily keys
          saveFileDataKeysMap();
        }
      }
      function deleteFileHistory(name) {
        // Remove from fileHistory
        fileHistory = fileHistory.filter(f => f.name !== name);
        localStorage.setItem('financeFileHistory', JSON.stringify(fileHistory));
        // Remove all data from this file from the charts
        removeFileData(name); // Uses daily keys now
        // Remove mapping
        delete fileDataKeysMap[name];
        saveFileDataKeysMap();
        renderFileHistory();
        // updateDisplay(); // Will be called by updateAndSaveData
        updateAndSaveData();
      }

      // --- New: Helper function to rebuild dailyActivity from globalAllTransactions for specific dates ---
      function rebuildDailyActivityForDates(dateKeysToRebuild) {
        const dates = Array.isArray(dateKeysToRebuild) ? dateKeysToRebuild : Array.from(dateKeysToRebuild);

        dates.forEach(dateKey => {
          // Initialize/clear the specific day's activity
          dailyActivity[dateKey] = { charges: 0, payments: 0, dcIncome: 0, categories: {} };
          CATEGORIES.forEach(cat => dailyActivity[dateKey].categories[cat] = 0); // Ensure all categories are initialized for summing up
        });

        globalAllTransactions.forEach(tx => {
          if (dates.includes(tx.date)) { // Process only if the transaction's date is one we're rebuilding
            const dateKey = tx.date;
            const amount = parseFloat(tx.amount); // Amount is stored as parsed: positive for charge, negative for income/payment
            const isDCFile = tx.sourceFile.toUpperCase().startsWith("DC");

            if (!dailyActivity[dateKey]) { // Should not happen if initialized above, but as a safeguard
              dailyActivity[dateKey] = { charges: 0, payments: 0, dcIncome: 0, categories: {} };
              CATEGORIES.forEach(cat => dailyActivity[dateKey].categories[cat] = 0);
            }

            if (isDCFile) {
              if (amount < 0) // DC income is stored as negative by parser, dcIncome in dailyActivity is positive
                dailyActivity[dateKey].dcIncome += Math.abs(amount);
            } else { // Not a DC file
              if (amount > 0) { // Charge
                dailyActivity[dateKey].charges += amount;
                let categoryToApply = "Other"; // Default category
                if (tx.category && CATEGORIES.includes(tx.category)) {
                  categoryToApply = tx.category;
                }
                dailyActivity[dateKey].categories[categoryToApply] = (dailyActivity[dateKey].categories[categoryToApply] || 0) + amount;
              } else if (amount < 0) { // Payment
                dailyActivity[dateKey].payments += Math.abs(amount);
              }
            }
          }
        });

        // Clean up days that ended up with no activity after rebuild
        dates.forEach(dateKey => {
          const dayData = dailyActivity[dateKey];
          if (dayData) { // Check if dayData exists, as it might have been deleted by another process if code changes
            let isEmpty = dayData.charges === 0 && dayData.payments === 0 && dayData.dcIncome === 0;
            if (isEmpty) {
              let categoriesSum = 0;
              CATEGORIES.forEach(cat => categoriesSum += (dayData.categories[cat] || 0));
              if (categoriesSum === 0) {
                delete dailyActivity[dateKey];
              }
            }
          }
        });
      }

      function removeFileData(name) {
        const dailyKeysAffectedByThisFile = fileDataKeysMap[name] || [];

        // Remove transactions from globalAllTransactions associated with this file
        globalAllTransactions = globalAllTransactions.filter(tx => tx.sourceFile !== name);
        localStorage.setItem(globalAllTransactionsStorageKey, JSON.stringify(globalAllTransactions));

        // After removing transactions, rebuild dailyActivity for the dates this file affected
        if (dailyKeysAffectedByThisFile.length > 0) {
          rebuildDailyActivityForDates(dailyKeysAffectedByThisFile);
        }
        
        // fileDataKeysMap[name] will be deleted by deleteFileHistory function
        // Totals are recalculated in updateDisplay based on remaining dailyActivity
      }

      // --- On load, render file history ---
      renderFileHistory();
      showFileHistory(false);      // Update totals display and chart
      function updateDisplay() {
        // Clear numeric summary
        document.getElementById('total').innerHTML = '';

        renderSpendChart(sharedChartTimeframe); // Use shared timeframe

        localStorage.setItem('financeDailyActivity', JSON.stringify(dailyActivity)); // New: Save all daily activity
        localStorage.setItem(globalAllTransactionsStorageKey, JSON.stringify(globalAllTransactions)); // New: Save all transactions

        // Update and render category chart
        populateCategoryMonthSelector();
        const selectedMonthForCategory = document.getElementById('categoryMonthSelector').value;        renderCategoriesChart(selectedMonthForCategory);

        renderRecentTransactions(); // New: Render recent transactions
        
        // Update budget widget
        updateBudgetOnDataChange();
      }      // --- New: Update and Save all data ---
      function updateAndSaveData() {
        updateDisplay(); // This now handles saving all primary data to localStorage
        // fileMonthMap is saved by its own function saveFileMonthMap()
      }

      // --- New: Render Recent Transactions with Search Support ---
      function renderRecentTransactions(searchQuery = '') {
        const tbody = document.getElementById('recentTransactionsBody');
        tbody.innerHTML = ''; // Clear existing rows

        if (globalAllTransactions.length === 0) {
          const tr = tbody.insertRow();
          const td = tr.insertCell();
          td.colSpan = 5;
          td.textContent = 'No transactions to display yet.';
          td.style.textAlign = 'center';
          td.style.color = '#A0A0A0';
          return;
        }

        // Sort transactions by date, most recent first
        const sortedTransactions = [...globalAllTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Filter transactions based on search query
        let filteredTransactions = sortedTransactions;
        if (searchQuery.trim()) {
          const query = searchQuery.toLowerCase().trim();
          filteredTransactions = sortedTransactions.filter(tx => {
            return (
              tx.date.toLowerCase().includes(query) ||
              tx.description.toLowerCase().includes(query) ||
              (tx.category && tx.category.toLowerCase().includes(query)) ||
              tx.amount.toString().includes(query) ||
              tx.sourceFile.toLowerCase().includes(query)
            );
          });
        }

        // Show message if no results found
        if (filteredTransactions.length === 0) {
          const tr = tbody.insertRow();
          const td = tr.insertCell();
          td.colSpan = 5;
          td.textContent = searchQuery.trim() ? `No transactions found matching "${searchQuery}"` : 'No transactions to display yet.';
          td.style.textAlign = 'center';
          td.style.color = '#A0A0A0';
          return;
        }

        // Limit to 50 results for performance (can be adjusted)
        const recentTransactions = filteredTransactions.slice(0, 50);

        recentTransactions.forEach(tx => {
          const tr = tbody.insertRow();
          
          const dateCell = tr.insertCell();
          dateCell.textContent = tx.date;

          const descCell = tr.insertCell();
          descCell.textContent = tx.description;
          
          const categoryCell = tr.insertCell();
          categoryCell.textContent = tx.category || 'N/A';

          const amountCell = tr.insertCell();
          amountCell.textContent = parseFloat(tx.amount).toFixed(2);
          // Amounts from parser: positive for charges/expenses, negative for income/payments
          if (tx.amount < 0) { // Income or Payment
            amountCell.className = 'amount-income';
            amountCell.textContent = Math.abs(parseFloat(tx.amount)).toFixed(2); // Display as positive
          } else { // Charge or Expense
            amountCell.className = 'amount-expense';
          }
          
          const sourceCell = tr.insertCell();
          sourceCell.textContent = tx.sourceFile;
          sourceCell.style.fontSize = '0.85em';
          sourceCell.style.color = '#888';
        });
      }

      // --- New: Setup Search Functionality ---
      function setupTransactionSearch() {
        const searchInput = document.getElementById('transactionSearchInput');
        if (!searchInput) return;

        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
          // Clear previous timeout to debounce search
          clearTimeout(searchTimeout);
          
          // Wait 300ms after user stops typing before searching
          searchTimeout = setTimeout(() => {
            renderRecentTransactions(e.target.value);
          }, 300);
        });

        // Also search on Enter key
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            renderRecentTransactions(e.target.value);          }
        });
      }

      // --- New: Category Chart Functions ---
      function populateCategoryMonthSelector() {
        const selector = document.getElementById('categoryMonthSelector');
        const currentSelection = selector.value; // Expects YYYY-MM
        selector.innerHTML = ''; // Clear existing options

        const availableMonths = new Set();
        Object.keys(dailyActivity).forEach(dateKey_YYYY_MM_DD => {
            availableMonths.add(dateKey_YYYY_MM_DD.substring(0, 7)); // Extract YYYY-MM
        });
        
        const sortedMonths = Array.from(availableMonths).sort().reverse(); // Latest first

        if (sortedMonths.length === 0) {
            const option = document.createElement('option');
            option.value = "";
            option.textContent = "No category data";
            selector.appendChild(option);
            selector.disabled = true;
            return;
        }

        selector.disabled = false;
        sortedMonths.forEach(monthKey_YYYY_MM => { // monthKey is YYYY-MM
            const option = document.createElement('option');
            option.value = monthKey_YYYY_MM;
            const [year, monthNum] = monthKey_YYYY_MM.split('-');
            const monthName = new Date(year, parseInt(monthNum)-1, 1).toLocaleString('default', { month: 'long' });
            option.textContent = `${monthName} ${year}`;
            selector.appendChild(option);
        });

        if (sortedMonths.includes(currentSelection)) {
            selector.value = currentSelection;
        } else if (sortedMonths.length > 0) {
            selector.value = sortedMonths[0]; // Default to the latest month
        }
      }
      
      document.getElementById('categoryMonthSelector').addEventListener('change', (event) => {
        renderCategoriesChart(event.target.value); // Value is YYYY-MM
      });

      function renderCategoriesChart(monthKey_YYYY_MM) { // Expects YYYY-MM
        const container = document.querySelector('.category-chart-inner-container');
        container.innerHTML = '<canvas id="categorySpendChart"></canvas>'; // Ensure fresh canvas
        const ctx = document.getElementById('categorySpendChart').getContext('2d');



        if (categoryChart) {
            categoryChart.destroy();
        }

        if (!monthKey_YYYY_MM || !/^\d{4}-\d{2}$/.test(monthKey_YYYY_MM)) { // Validate monthKey format
            ctx.font = "16px Poppins";
            ctx.fillStyle = "#A0A0A0";
            ctx.textAlign = "center";
            ctx.fillText(monthKey_YYYY_MM ? "Invalid period format" : "Select a period", container.offsetWidth / 2, container.offsetHeight / 2);
            return;
        }
        
        const aggregatedCategoriesForMonth = {};
        CATEGORIES.forEach(cat => aggregatedCategoriesForMonth[cat] = 0); // Initialize all categories to 0

        let foundDataForMonth = false;
        Object.keys(dailyActivity).forEach(dateKey_YYYY_MM_DD => {
            if (dateKey_YYYY_MM_DD.startsWith(monthKey_YYYY_MM)) { // Check if the date belongs to the selected month
                const dayData = dailyActivity[dateKey_YYYY_MM_DD];
                if (dayData && dayData.categories) {




                    foundDataForMonth = true;
                    CATEGORIES.forEach(cat => {
                        if (dayData.categories[cat]) {
                            aggregatedCategoriesForMonth[cat] += dayData.categories[cat];
                        }
                    });
                }
            }
        });

        if (!foundDataForMonth) {
            ctx.font = "16px Poppins";
            ctx.fillStyle = "#A0A0A0";
            ctx.textAlign = "center";
            ctx.fillText("No category data for selected period", container.offsetWidth / 2, container.offsetHeight / 2);
            return;
        }

        const labels = CATEGORIES;
        const rawData = labels.map(cat => aggregatedCategoriesForMonth[cat] || 0);

        const filteredLabels = [];
        const filteredData = [];
        labels.forEach((label, index) => {
            if (rawData[index] > 0) {
                filteredLabels.push(label);
                filteredData.push(rawData[index]);
            }
        });

        if (filteredData.length === 0) {
            ctx.font = "16px Poppins";
            ctx.fillStyle = "#A0A0A0";
            ctx.textAlign = "center";
            ctx.fillText("No spending in categories for " + monthKey_YYYY_MM, container.offsetWidth / 2, container.offsetHeight / 2);
            return;
        }
          categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: filteredLabels,
                datasets: [{
                    label: 'Spending by Category',
                    data: filteredData,                    backgroundColor: [
                        '#FF6B6B', // Groceries - Red
                        '#4CAF50', // Food Delivery/Restaurant - Green  
                        '#FFC107', // Gas - Amber

                        '#63FFDA', // Bills - Cyan
                        '#8B5CF6', // Other - Purple
                        '#FF9800'  // Extra color - Orange
                    ],                    borderColor: [
                        '#FF6B6B',
                        '#4CAF50',
                        '#FFC107',
                        '#63FFDA',
                        '#8B5CF6',
                        '#FF9800'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,                plugins: {
                    legend: {
                        position: 'top',
                        labels: { 
                            color: '#A0A0A0',
                            font: {
                                size: 14
                            },
                            padding: 15
                        }
                    },
                    title: {
                        display: false
                    }
                }
            }
        });
      }      // --- New: Aggregate data for charts based on timeframe ---
      function aggregateDataForChart(sourceData, timeframe, dataType) {
        const now = new Date();
        let labels = [];
        let data = [];
        const aggregated = {}; // Temp object to sum data for periods

        const allSortedDates = Object.keys(sourceData).sort();

        allSortedDates.forEach(dateKey => {
          const entry = sourceData[dateKey];          const value = entry ? (entry[dataType] || 0) : 0;
          if (value === 0 && dataType === 'dcIncome') return; // Skip if no income

          const date = new Date(dateKey + 'T00:00:00'); // Ensure local timezone interpretation

          let periodKey = '';

          if (timeframe === 'day') {
            periodKey = dateKey; // YYYY-MM-DD
          } else if (timeframe === 'week') {
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - date.getDay()); // Sunday
            periodKey = `${weekStart.getFullYear()}-${(weekStart.getMonth() + 1).toString().padStart(2, '0')}-${weekStart.getDate().toString().padStart(2, '0')}`;
          } else if (timeframe === 'month') {
            periodKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          } else if (timeframe === 'year') {
            periodKey = date.getFullYear().toString();
          }

          if (periodKey) {
            aggregated[periodKey] = (aggregated[periodKey] || 0) + value;
          }
        });

        labels = Object.keys(aggregated).sort();
        data = labels.map(key => aggregated[key]);
        
        // Format labels for display
        const formattedLabels = labels.map(label => {
            if (timeframe === 'day') {
                const [y, m, d] = label.split('-');
                return `${m}/${d}`;
            }
            if (timeframe === 'week') {
                 const [y, m, d] = label.split('-');
                return `Wk ${m}/${d}`;
            }
            if (timeframe === 'month') {
                const [y,m] = label.split('-');
                return new Date(y, parseInt(m)-1, 1).toLocaleString('default', { month: 'short' });
            }
            if (timeframe === 'year') {
                return label;
            }
            return label;
        });

        return { labels: formattedLabels, data };
      }      // --- Modified: renderSpendChart to accept timeframe ---
      function renderSpendChart(timeframe = 'month') {
        const { labels: chartLabels, data: chargesData } = aggregateDataForChart(dailyActivity, timeframe, 'charges');
        const { data: paymentsData } = aggregateDataForChart(dailyActivity, timeframe, 'payments'); // Labels will be the same

        // Properly destroy existing chart and refresh canvas
        if (chart) {
          chart.destroy();
          chart = null;
        }
        
        // Get the chart container and refresh the canvas
        const chartContainer = document.querySelector('.charges-payments-chart-inner-container');
        if (chartContainer) {
          chartContainer.innerHTML = '<canvas id="spendChart"></canvas>';
        }
        
        const canvas = document.getElementById('spendChart');
        if (!canvas) {
          console.error('Canvas element not found');
          return;
        }
          chart = new Chart(canvas, {
          type: 'bar',
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: 'Charges',
                data: chargesData,
                backgroundColor: '#FF6B6B',
                borderRadius: 6,
                borderSkipped: false,
                barPercentage: 0.6
              },
              {
                label: 'Payments',
                data: paymentsData,
                backgroundColor: '#4CAF50',
                borderRadius: 6,
                borderSkipped: false,
                barPercentage: 0.6
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            elements: { 
              bar: { 
                borderRadius: 8, 
                borderSkipped: false 
              } 
            },            scales: {
              x: {
                grid: { color: '#A0A0A0' },
                ticks: { color: '#A0A0A0' }
              },
              y: { 
                grid: { color: '#A0A0A0' }, 
                ticks: { color: '#A0A0A0' }, 
                beginAtZero: true 
              }
            },            plugins: {
              legend: { 
                labels: { color: '#A0A0A0' }
              },
              title: { 
                display: false
              }
            }
          }
        });
      }

      // --- Event Listeners for Timeframe Controls ---
      document.querySelectorAll('.timeframe-controls button').forEach(button => {
        button.addEventListener('click', () => {
          const chartName = button.dataset.chart;
          const range = button.dataset.range;

          // Remove active class from all buttons in this group
          button.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
          // Add active class to the clicked button
          button.classList.add('active');          if (chartName === 'expenses') {
            expensesChartTimeframe = range;
            renderSpendChart(expensesChartTimeframe);
          }
        });      });      // === ANIMATED GRADIENT EFFECT FOR BUTTONS ===
      function setupAnimatedButtons() {
        const buttons = document.querySelectorAll('button, .upload-modal-btn, .file-history-tab, .banks-tab, #agent-action-button, .timeframe-controls button, .budget-delete-btn');
        
        buttons.forEach(button => {
          // Skip if already has event listeners
          if (button.hasAttribute('data-animated-setup')) return;
          button.setAttribute('data-animated-setup', 'true');
          
          button.addEventListener('mousemove', (e) => {
            const rect = button.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            
            button.style.setProperty('--mouse-x', `${x}%`);
            button.style.setProperty('--mouse-y', `${y}%`);
          });
          
          button.addEventListener('mouseleave', () => {
            // Reset to center when mouse leaves
            button.style.setProperty('--mouse-x', '50%');
            button.style.setProperty('--mouse-y', '50%');
          });
        });
      }

      // On load, restore saved data
      document.addEventListener('DOMContentLoaded', () => {
        const savedDailyActivity = localStorage.getItem('financeDailyActivity');
        if (savedDailyActivity) {
          dailyActivity = JSON.parse(savedDailyActivity);
        } else {
          dailyActivity = {}; // Initialize if nothing is saved
        }

        const savedGlobalTransactions = localStorage.getItem(globalAllTransactionsStorageKey);
        if (savedGlobalTransactions) {
          globalAllTransactions = JSON.parse(savedGlobalTransactions);
        } else {
          globalAllTransactions = [];
        }

        // fileHistory is already loaded at the top
        const savedFileDataKeysMap = localStorage.getItem('financeFileDataKeysMap');
        if (savedFileDataKeysMap) {
          fileDataKeysMap = JSON.parse(savedFileDataKeysMap);
        } else {
          fileDataKeysMap = {}; // Initialize if nothing is saved
        }        updateDisplay(); // Call once after all data is loaded
        setupAnimatedButtons(); // Initialize animated gradient effects
        setupTransactionSearch(); // Initialize search functionality
      });

      // --- New: PDF Upload Modal Logic ---
      const pdfUploadModal = document.getElementById('pdfUploadModal');
      const openPdfUploadModalBtn = document.getElementById('openPdfUploadModalBtn');
      const closeUploadModalBtn = document.getElementById('closeUploadModalBtn');
      const modalPdfInput = document.getElementById('modalPdfInput');
      const uploadAreaLabel = document.getElementById('uploadAreaLabel');
      const selectedFilesList = document.getElementById('selectedFilesList');
      const confirmUploadBtn = document.getElementById('confirmUploadBtn');
      const cancelUploadBtn = document.getElementById('cancelUploadBtn');
      const originalPdfPicker = document.getElementById('pdfPicker'); // The original, now hidden, input

      let filesToUploadModal = []; // Renamed to avoid conflict

      if (openPdfUploadModalBtn) {
        openPdfUploadModalBtn.onclick = () => {
          pdfUploadModal.style.display = 'flex';
          filesToUploadModal = []; // Reset on open
          updateSelectedFilesListModal(); // Renamed to avoid conflict
        };
      }

      if (closeUploadModalBtn) {
        closeUploadModalBtn.onclick = () => {
          pdfUploadModal.style.display = 'none';
        };
      }

      if (cancelUploadBtn) {
        cancelUploadBtn.onclick = () => {
          pdfUploadModal.style.display = 'none';
        };
      }

      if (modalPdfInput) {
        modalPdfInput.onchange = (e) => {
          const newFiles = Array.from(e.target.files);
          newFiles.forEach(file => {
            if (file.type === "application/pdf" && !filesToUploadModal.some(existingFile => existingFile.name === file.name && existingFile.size === file.size)) {
              filesToUploadModal.push(file);
            }
          });
          updateSelectedFilesListModal(); 
          modalPdfInput.value = ''; // Clear input to allow re-selecting/re-adding the same file if needed
        };
      }

      function updateSelectedFilesListModal() { // Renamed to avoid conflict
        if (!selectedFilesList) return;
        selectedFilesList.innerHTML = '';
        if (filesToUploadModal.length === 0) {
          selectedFilesList.innerHTML = '<div>No files selected.</div>';
        } else {
          filesToUploadModal.forEach(file => {
            const fileDiv = document.createElement('div');
            fileDiv.textContent = file.name;
            selectedFilesList.appendChild(fileDiv);
          });
        }
        if (confirmUploadBtn) confirmUploadBtn.disabled = filesToUploadModal.length === 0;
      }

      if (confirmUploadBtn) {
        confirmUploadBtn.onclick = async () => {
          if (filesToUploadModal.length > 0) {
            showProcessingBar("Preparing to upload..."); // Show progress bar
            pdfUploadModal.style.display = 'none';
            const dataTransfer = new DataTransfer();
            filesToUploadModal.forEach(file => dataTransfer.items.add(file));
            if (originalPdfPicker) originalPdfPicker.files = dataTransfer.files;
            
            const event = new Event('change', { bubbles: true });
            if (originalPdfPicker) originalPdfPicker.dispatchEvent(event);
          }
        };
      }

      // Close modal if user clicks outside of it
      window.onclick = (event) => {
        if (event.target == pdfUploadModal) {
          pdfUploadModal.style.display = 'none';
        }
      };

      // Drag and drop functionality for the upload area
      if (uploadAreaLabel) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          uploadAreaLabel.addEventListener(eventName, preventDefaultsModal, false); // Renamed to avoid conflict
        });

        function preventDefaultsModal(e) { // Renamed to avoid conflict
          e.preventDefault();
          e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
          uploadAreaLabel.addEventListener(eventName, () => uploadAreaLabel.classList.add('hover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
          uploadAreaLabel.addEventListener(eventName, () => uploadAreaLabel.classList.remove('hover'), false);
        });

        uploadAreaLabel.addEventListener('drop', (e) => {
          const dt = e.dataTransfer;
          const droppedFiles = Array.from(dt.files).filter(file => file.type === "application/pdf");
          
          if (droppedFiles.length > 0) {
              droppedFiles.forEach(file => {
                if (!filesToUploadModal.some(existingFile => existingFile.name === file.name && existingFile.size === file.size)) {
                  filesToUploadModal.push(file);
                }
              });
              updateSelectedFilesListModal(); 
          } else if (dt.files.length > 0) {
              alert("Please drop PDF files only.");
          }
          if (modalPdfInput) modalPdfInput.value = ''; 
        }, false);
      }

      if (originalPdfPicker) {
        originalPdfPicker.addEventListener('change', async e => { 
          const files = Array.from(e.target.files); // These are the files confirmed from the modal
          if (!files.length) {
            hideProcessingBar(); // Hide if no files somehow
            return;
          }
         

          if (!GEMINI_API_KEY || GEMINI_API_KEY.trim() === "") {
            alert("Gemini API key is not set or is invalid. Please create config.js with your key (set GEMINI_API_KEY) and ensure it is loaded.");
            e.target.value = null;
            hideProcessingBar();
            return;
          }

          // if (h1Title) h1Title.textContent = `Processing ${files.length} file(s)...`; // Replaced by progress bar
          showProcessingBar(`Processing ${files.length} file(s)...`); // Show progress bar

          try {
            for (let i = 0; i < files.length; i++) {
              const f = files[i];
              const fileName = f.name;
              const fileExtension = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();

              // if (h1Title) h1Title.textContent = `Processing ${fileName} (${i + 1} of ${files.length})...`; // Replaced by progress bar
              showProcessingBar(`Processing ${fileName} (${i + 1} of ${files.length})...`); // Update progress bar message

              if (fileExtension === 'pdf') {
                try {
                  await handlePdfFile(f); 
                } catch (error) {
                  console.error(`Error processing ${fileName}:`, error);
                  alert(`An error occurred while processing ${fileName}. Check the console for details.`);
                  // Optionally, break or decide how to handle errors for multiple files
                }
              } else {
                alert("Unsupported file type. Please upload a PDF file.");
                e.target.value = null; 
                // if (h1Title) h1Title.textContent = originalPageTitle; // No longer needed
                break; 
              }
            }
          } finally {
            updateAndSaveData(); // <<< KEY FIX: Update display and save data after all files are processed
            // if (h1Title) h1Title.textContent = originalPageTitle; // No longer needed
            hideProcessingBar(); // Hide progress bar when all processing is done or an error broke the loop
            e.target.value = null; // Clear the file input to allow re-uploading the same file(s)
          }
        });
      }

      // --- Function to process PDF files (placeholder for OpenAI API call) ---
      async function handlePdfFile(file) {
        const fileName = file.name;
        console.log(`Attempting to process PDF: ${fileName}`);

        // Store old keys this file affected, to ensure they are rebuilt correctly
        const oldKeysForThisFile = fileDataKeysMap[fileName] ? new Set(fileDataKeysMap[fileName]) : new Set();
        
        // First, remove any existing transactions from this file to prevent duplication if re-uploaded
        globalAllTransactions = globalAllTransactions.filter(tx => tx.sourceFile !== fileName);
        // Note: At this point, dailyActivity might be stale for oldKeysForThisFile until rebuild happens.

        try {

          const base64File = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result); 
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file); 
          });

          const pureBase64 = base64File.substring(base64File.indexOf(',') + 1);
          
          const extractedData = await callGeminiPdfParser(pureBase64, fileName);

          let newContributedDailyKeys = new Set();

          if (!extractedData || !extractedData.transactions || !Array.isArray(extractedData.transactions)) {
            console.error('No transactions found or invalid format from parser for file:', fileName);
            addFileToHistory(fileName, []); // Update history with no keys for this file
            // Rebuild any dates this file previously affected to clear its old contributions
            if (oldKeysForThisFile.size > 0) {
                rebuildDailyActivityForDates(Array.from(oldKeysForThisFile));
            }
            return; 
          }

          const isDCFile = fileName.toUpperCase().startsWith("DC"); // Determine once

          if (extractedData.transactions.length === 0) {
            console.log(`No transactions extracted from ${fileName}.`);
            addFileToHistory(fileName, []); 
          } else {
            extractedData.transactions.forEach(transaction => {
              const transactionDate = transaction.date; 
              
              if (!transactionDate || !/^\d{4}-\d{2}-\d{2}$/.test(transactionDate)) {
                console.warn(`Skipping transaction in ${fileName} due to missing or invalid date:`, transaction);
                return; 
              }
              
              const amount = parseFloat(transaction.amount);
              if (isNaN(amount)) {
                console.warn(`Skipping transaction in ${fileName} due to invalid amount:`, transaction);
                return; 
              }
              newContributedDailyKeys.add(transactionDate);

              globalAllTransactions.push({
                date: transactionDate,
                description: transaction.description,
                amount: amount, 
                category: transaction.category || (isDCFile ? 'Income' : 'N/A'),
                sourceFile: fileName
              });
            });
            addFileToHistory(fileName, Array.from(newContributedDailyKeys));
          }

          // Combine old and new keys to ensure all affected dates are rebuilt
          const allAffectedKeys = new Set([...oldKeysForThisFile, ...newContributedDailyKeys]);
          if (allAffectedKeys.size > 0) {
            rebuildDailyActivityForDates(Array.from(allAffectedKeys));
          }

        } catch (error) {
          console.error(`Error in handlePdfFile for ${fileName}:`, error);

          if (oldKeysForThisFile.size > 0) {
             rebuildDailyActivityForDates(Array.from(oldKeysForThisFile));
          }
          throw error; 
        }
      }

      async function callGeminiPdfParser(base64Pdf, fileNameForContext) {
        console.log(`Sending ${fileNameForContext} to Google Gemini API for parsing...`);
        if (!GEMINI_API_KEY) {
            throw new Error("Gemini API key is not loaded. Please check config.js.");
        }
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;


        let systemInstructionText = `You are a data extraction AI. You will receive a PDF bank statement. Your task is to:
1. Identify all individual financial transaction lines. Focus on itemized entries, not summary totals unless they are the only source for a specific transaction type.
2. For each transaction found, extract the date, description, and amount.
3. For each transaction identified as an expense (typically a positive amount based on the rules below), categorize it into one of the following: 'Groceries', 'Food Delivery/Restaurant', 'Gas', 'Misc', 'Other'. If a transaction is a credit/payment (negative amount), the category field can be null or an empty string.

Return a single JSON object: \`{ "transactions": [ { "date": "YYYY-MM-DD", "description": "...", "amount": number, "category": "string_or_null" }, ... ] }\`.

CRITICAL RULES for 'amount':
  - Charges/Debits/Purchases/Expenses/Withdrawals are POSITIVE numbers (e.g., 100.00).
  - Payments/Credits/Deposits/Income are NEGATIVE numbers (e.g., -50.00).
  - Examine transaction descriptions for keywords like 'Purchase', 'Fee', 'Withdrawal' (positive) or 'Payment', 'Deposit', 'Credit', 'Income' (negative).
  - If the PDF text clearly shows 'Debit' and 'Credit' columns, amounts in a 'Debit' column are positive, and amounts in a 'Credit' column are negative.

For 'date': Use 'YYYY-MM-DD'. If the full date isn't on the transaction line, infer the year and month from the overall statement period (often found in the filename or at the top/bottom of the PDF text). If day is missing, use '01'.
For 'description': Capture the full transaction detail as presented on the statement.

Category definitions for expenses:
- 'Groceries': Purchases from supermarkets, grocery stores (e.g., Walmart, Kroger, Trader Joe's, ALDI, Whole Foods).
- 'Food Delivery/Restaurant': Expenses at restaurants, cafes, fast food establishments, and food delivery services (e.g., Doordash, Uber Eats, Grubhub, Starbucks, McDonald's, local restaurants).
- 'Gas': Fuel purchases from gas stations (e.g., Shell, Exxon, BP, Chevron, local gas stations).
- 'Misc': This category is for all other expenses that do not clearly fall into 'Groceries', 'Food Delivery/Restaurant', or 'Gas'. This includes but is not limited to: utility payments (electricity, water, internet, phone), subscriptions (Netflix, Spotify, gym), shopping (clothing, electronics, household goods), entertainment (movies, concerts), travel costs (flights, hotels, not gas), medical co-pays, insurance premiums, rent/mortgage payments, loan repayments, childcare fees, property taxes. If an expense doesn't fit the specific categories above, it should be classified as 'Misc'.
- 'Other': Use this category sparingly for expenses that are highly unusual or cannot be classified even under the broad 'Misc' category. For most unclassified expenses, 'Misc' is preferred. This could also be used if an item is clearly an expense but its nature is completely indeterminable.

The response MUST be only the valid JSON object, with no extra text, explanations, or markdown formatting.`;

        // Check if the filename starts with "DC"
        if (fileNameForContext && fileNameForContext.toUpperCase().startsWith("DC")) {
          // Modify system instruction for "DC" files to only extract income (payments/credits)
          // and not categorize expenses.
          systemInstructionText = `You are a data extraction AI. You will receive a PDF bank statement from a file named '${fileNameForContext}'.
This file is specifically for income. Your task is to:
1. Identify all individual financial transaction lines that represent INCOME or CREDITS to the account.
2. For each such transaction found, extract the date, description, and amount.
3. IGNORE ALL EXPENSES/CHARGES/DEBITS. Only process income/credits.

Return a single JSON object: \`{ "transactions": [ { "date": "YYYY-MM-DD", "description": "...", "amount": number, "category": null }, ... ] }\`.

CRITICAL RULES for 'amount':
  - Payments/Credits/Deposits/Income are NEGATIVE numbers (e.g., -50.00).
  - ALL OTHER TRANSACTION TYPES (CHARGES/DEBITS/EXPENSES) SHOULD BE IGNORED.

For 'date': Use 'YYYY-MM-DD'. If the full date isn't on the transaction line, infer the year and month from the overall statement period. If day is missing, use '01'.
For 'description': Capture the full transaction detail.
The 'category' field should always be null for these income transactions.

The response MUST be only the valid JSON object, with no extra text, explanations, or markdown formatting.`;
        }


        const userPromptText = `Please analyze the attached PDF bank statement named '${fileNameForContext}' and extract all financial transactions according to the detailed system instructions. Pay utmost attention to correctly identifying and signing the 'amount' for each transaction (positive for charges, negative for payments/credits) and categorizing expenses.`;

        const payload = {
          contents: [
            {
              parts: [
                { text: userPromptText },
                {
                  inline_data: {
                    mime_type: "application/pdf",
                    data: base64Pdf
                  }
                }
              ]
            }
          ],
          system_instruction: {
            parts: [
              { text: systemInstructionText }
            ]
          },
          generationConfig: {
            response_mime_type: "application/json",
            temperature: 0.2 
          }
        };

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const errorBody = await response.json().catch(() => response.text()); // Try to parse as JSON, fallback to text
            console.error("Gemini API Error Response:", errorBody);
            const errorMessage = errorBody.error && errorBody.error.message ? errorBody.error.message : JSON.stringify(errorBody);
            throw new Error(`Gemini API request failed with status ${response.status}: ${response.statusText}. Details: ${errorMessage}`);
          }

          const data = await response.json();
          console.log("Gemini API Raw Response:", data);

          if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) {
            const jsonString = data.candidates[0].content.parts[0].text;
            console.log("Gemini API JSON String Content:", jsonString);
            try {
                return JSON.parse(jsonString);
            } catch (parseError) {
                console.error("Failed to parse JSON from Gemini response:", parseError, "Raw content:", jsonString);
                // Check if it might already be an object (though API docs say it's a string with response_mime_type: "application/json")
                if (typeof jsonString === 'object') return jsonString;
                throw new Error("Failed to parse JSON from Gemini API response. Check console for raw output.");
            }
          } else {
            console.error("Unexpected Gemini API response structure:", data);
            throw new Error("Unexpected response structure from Gemini API. No valid content found.");
          }
        } catch (error) {
          console.error("Error calling Gemini API:", error);
          // Display a more user-friendly error message on the page
          const errorDisplay = document.getElementById('apiErrorDisplay'); // Assuming you add such an element
          if (errorDisplay) {
            errorDisplay.textContent = `Error communicating with the AI: ${error.message}. Please check your API key and network connection.`;
          }
          return { transactions: [], summary: "Error during parsing." }; // Return empty on error
        }
      }

      // --- Banks Panel UI Logic ---
      const banksTab = document.getElementById('banksTab');
      let banksPanel = document.getElementById('banksPanel');
      const banksList = document.getElementById('banksList');

      // Helper: Get/Set banks links in localStorage
      function getBankLinks() {
        try {
          return JSON.parse(localStorage.getItem('financeBanksLinks')) || [];
        } catch (e) {
          return [];
        }
      }
      function setBankLinks(links) {
        localStorage.setItem('financeBanksLinks', JSON.stringify(links));
      }

      // Render the banks list in the popup
      function renderBanksList() {
        if (!banksList) return;
        const links = getBankLinks();
        banksList.innerHTML = '';
        if (!links.length) {
          const li = document.createElement('li');
          li.style.color = '#A0A0A0';
          li.textContent = 'No banks added yet.';
          banksList.appendChild(li);
          return;
        }
        links.forEach(link => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = link.url;
          a.textContent = link.name;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.style.color = '#7adfff';
          a.style.textDecoration = 'underline';
          li.appendChild(a);
          // --- Add delete button next to each bank ---
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-btn';
          delBtn.textContent = 'Delete';
          delBtn.onclick = (event) => {
            event.stopPropagation();
            // Remove this bank from storage and re-render
            const links = getBankLinks();
            const idx = links.findIndex(l => l.name === link.name && l.url === link.url);
            if (idx !== -1) {
              links.splice(idx, 1);
              setBankLinks(links);
              renderBanksList();
            }
          };
          li.appendChild(delBtn);
          banksList.appendChild(li);
        });
      }

      // Initial render on page load
      renderBanksList();

      function showBanksPanel(show) {
        if (!banksPanel || !banksTab) return;
        if (show) {
          banksPanel.style.display = 'block';
          banksTab.classList.add('active');
          renderBanksList(); // Always update when shown
        } else {
          banksPanel.style.display = 'none';
          banksTab.classList.remove('active');
        }
      }
      if (banksTab) {
        banksTab.addEventListener('click', () => {
          showBanksPanel(banksPanel.style.display !== 'block');
        });
      }
      if (banksPanel) {
        document.addEventListener('click', e => {
          if (!banksPanel.contains(e.target) && e.target !== banksTab) {
            showBanksPanel(false);
          }
        });
      }

      // --- Banks Import Modal Logic ---
      // Create the modal HTML and append to body (hidden by default)
      (function createBanksImportModal() {
        if (document.getElementById('banksImportModal')) return; // Prevent duplicate
        const modal = document.createElement('div');
        modal.id = 'banksImportModal';
        modal.className = 'upload-modal';
        modal.style.display = 'none';
        modal.innerHTML = `
          <div class="upload-modal-content">
            <div class="upload-modal-header">
              <h2>Add Bank Link</h2>
              <button id="closeBanksImportModalBtn" class="upload-modal-close-btn">&times;</button>
            </div>
            <div style="display:flex; flex-direction:column; gap:16px;">
              <input id="bankNameInput" type="text" placeholder="Bank Name" style="padding:10px; border-radius:4px; border:1px solid #4F4B68; background:#211D30; color:#E0E0E0; font-size:1em;" />
              <input id="bankUrlInput" type="text" placeholder="Bank URL (https://...)" style="padding:10px; border-radius:4px; border:1px solid #4F4B68; background:#211D30; color:#E0E0E0; font-size:1em;" />
            </div>
            <div class="upload-modal-footer">
              <button id="cancelBanksImportBtn" class="upload-modal-btn secondary">Cancel</button>
              <button id="saveBanksImportBtn" class="upload-modal-btn primary">Save</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      })();

      // Show/hide logic for the modal
      const banksImportModal = document.getElementById('banksImportModal');
      const importBanksBtn = document.getElementById('importBanksBtn');
      const closeBanksImportModalBtn = document.getElementById('closeBanksImportModalBtn');
      const cancelBanksImportBtn = document.getElementById('cancelBanksImportBtn');
      const saveBanksImportBtn = document.getElementById('saveBanksImportBtn');
      if (importBanksBtn && banksImportModal) {
        banksImportModal.style.display = 'none'; // Ensure it's hidden by default
        importBanksBtn.onclick = () => {
          banksImportModal.style.display = 'flex';
          document.getElementById('bankNameInput').value = '';
          document.getElementById('bankUrlInput').value = '';
        };
      }
      if (closeBanksImportModalBtn) closeBanksImportModalBtn.onclick = () => { banksImportModal.style.display = 'none'; };
      if (cancelBanksImportBtn) cancelBanksImportBtn.onclick = () => { banksImportModal.style.display = 'none'; };
      // Close modal if user clicks outside of it
      window.addEventListener('click', function(event) {
        if (event.target === banksImportModal) {
          banksImportModal.style.display = 'none';
        }
      });

      // --- Banks Import Modal Save Logic ---
      if (saveBanksImportBtn) {
        saveBanksImportBtn.onclick = () => {
          const name = document.getElementById('bankNameInput').value.trim();
          const url = document.getElementById('bankUrlInput').value.trim();
          if (!name || !url) {
            alert('Please enter both a bank name and URL.');
            return;
          }
          // Basic URL validation
          if (!/^https?:\/\//i.test(url)) {
            alert('Please enter a valid URL starting with http:// or https://');
            return;
          }
          const links = getBankLinks();
          links.push({ name, url });
          setBankLinks(links);
          renderBanksList();
          banksImportModal.style.display = 'none';
        };
      }

      // --- New: Presentation Generation Logic ---
      async function generatePresentationData() {
        const presentationData = {};
        const today = new Date();
        const formattedToday = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;

        // Slide 1: Title Slide
        presentationData.slide1 = {
          title: "Personal Finance Overview",
          subtitle: `Generated on: ${formattedToday}`
        };

        // Helper to get overall financial summary
        function getOverallSummary() {
          let totalIncome = 0;
          let totalExpenses = 0;
          let firstDate = null;
          let lastDate = null;

          const dates = Object.keys(dailyActivity).sort();
          if (dates.length > 0) {
            firstDate = dates[0];
            lastDate = dates[dates.length - 1];
          }

          Object.values(dailyActivity).forEach(day => {
            totalIncome += day.dcIncome || 0;
            totalExpenses += day.charges || 0;
          });

          return {
            totalIncome: totalIncome.toFixed(2),
            totalExpenses: totalExpenses.toFixed(2),
            net: (totalIncome - totalExpenses).toFixed(2),
            periodCovered: firstDate && lastDate ? `Data from ${firstDate} to ${lastDate}` : "No data available"
          };
        }
        presentationData.slide2 = getOverallSummary();

        // Helper to get monthly aggregates
        function getMonthlyAggregates(dataType) { // dataType can be 'dcIncome' or 'charges'
          const monthly = {};
          Object.entries(dailyActivity).forEach(([dateKey, data]) => {
            const monthKey = dateKey.substring(0, 7); // YYYY-MM
            monthly[monthKey] = (monthly[monthKey] || 0) + (data[dataType] || 0);
          });
          return monthly;
        }

        // Slide 3: Income Highlights
        const monthlyIncome = getMonthlyAggregates('dcIncome');
        let totalIncomeThisMonth = 0;
        let highestIncomeMonthAmount = 0;
        let highestIncomeMonth = "N/A";
        const currentMonthKey = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;

        if (monthlyIncome[currentMonthKey]) {
          totalIncomeThisMonth = monthlyIncome[currentMonthKey];
        }
        for (const [month, amount] of Object.entries(monthlyIncome)) {
          if (amount > highestIncomeMonthAmount) {
            highestIncomeMonthAmount = amount;
            highestIncomeMonth = month;
          }
        }
        presentationData.slide3 = {
          title: "Income Highlights",
          totalIncomeThisMonth: totalIncomeThisMonth.toFixed(2),
          highestIncomeMonth: `${highestIncomeMonth} (${highestIncomeMonthAmount.toFixed(2)})`,
          // You could add more insights here, e.g., average monthly income
        };

        // Slide 4: Expense Highlights
        const monthlyExpenses = getMonthlyAggregates('charges');
        let totalExpensesThisMonth = 0;
        let highestExpenseMonthAmount = 0;
        let highestExpenseMonth = "N/A";

        if (monthlyExpenses[currentMonthKey]) {
          totalExpensesThisMonth = monthlyExpenses[currentMonthKey];
        }
        for (const [month, amount] of Object.entries(monthlyExpenses)) {
          if (amount > highestExpenseMonthAmount) {
            highestExpenseMonthAmount = amount;
            highestExpenseMonth = month;
          }
        }
        presentationData.slide4 = {
          title: "Expense Highlights",
          totalExpensesThisMonth: totalExpensesThisMonth.toFixed(2),
          highestExpenseMonth: `${highestExpenseMonth} (${highestExpenseMonthAmount.toFixed(2)})`,
          // You could add more insights here, e.g., average monthly expenses
        };
        
        // Slide 5: Top Expense Categories (for the most recent month with data)
        function getTopExpenseCategories() {
            const availableMonths = new Set();
            Object.keys(dailyActivity).forEach(dateKey_YYYY_MM_DD => {
                if (dailyActivity[dateKey_YYYY_MM_DD] && Object.keys(dailyActivity[dateKey_YYYY_MM_DD].categories).length > 0) {
                    availableMonths.add(dateKey_YYYY_MM_DD.substring(0, 7)); // YYYY-MM
                }
            });
            const sortedMonths = Array.from(availableMonths).sort().reverse();
            let topCategories = "No category data available for recent months.";

            if (sortedMonths.length > 0) {
                const latestMonthKey = sortedMonths[0];
                const aggregatedCategories = {};
                CATEGORIES.forEach(cat => aggregatedCategories[cat] = 0);

                Object.keys(dailyActivity).forEach(dateKey_YYYY_MM_DD => {
                    if (dateKey_YYYY_MM_DD.startsWith(latestMonthKey)) {
                        const dayData = dailyActivity[dateKey_YYYY_MM_DD];
                        if (dayData && dayData.categories) {
                            CATEGORIES.forEach(cat => {
                                if (dayData.categories[cat]) {
                                    aggregatedCategories[cat] += dayData.categories[cat];
                                }
                            });
                        }
                    }
                });
                
                const sortedTopCategories = Object.entries(aggregatedCategories)
                    .filter(([_, amount]) => amount > 0)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5); // Top 5 categories

                if (sortedTopCategories.length > 0) {
                    topCategories = sortedTopCategories.map(([name, amount]) => `${name}: ${amount.toFixed(2)}`).join(', ');
                } else {
                    topCategories = `No expenses recorded in categories for ${latestMonthKey}.`;
                }
                return {
                    title: `Top Expense Categories for ${latestMonthKey}`,
                    categories: topCategories
                };
            }
            return {
                title: "Top Expense Categories",
                categories: topCategories
            };
        }
        presentationData.slide5 = getTopExpenseCategories();

        // Slide 6: Recent Transactions Summary (last 7 days)
        function getRecentTransactionsSummary() {
          const sevenDaysAgo = new Date(today);
          sevenDaysAgo.setDate(today.getDate() - 7);
          
          let recentTxCount = 0;
          let totalSpentLast7Days = 0;
          const recentSample = [];

          const sortedTransactions = [...globalAllTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));

          sortedTransactions.forEach(tx => {
            const txDate = new Date(tx.date + "T00:00:00"); // Ensure correct date parsing
            if (txDate >= sevenDaysAgo) {
              recentTxCount++;
              if (tx.amount > 0) { // Expense
                totalSpentLast7Days += tx.amount;
              }
              if (recentSample.length < 3) { // Get last 3 transactions
                  recentSample.push(`${tx.date}: ${tx.description} (${tx.amount.toFixed(2)})`);
              }
            }
          });
          return {
            title: "Recent Transactions (Last 7 Days)",
            count: recentTxCount,
            totalSpent: totalSpentLast7Days.toFixed(2),
            sampleTransactions: recentSample.length > 0 ? recentSample.join('; ') : "No transactions in the last 7 days."
          };
        }
        presentationData.slide6 = getRecentTransactionsSummary();

        // Slide 7: Actionable Next Steps
        presentationData.slide7 = {
          title: "Actionable Next Steps",
          steps: [
            "Review spending patterns against budget goals.",
            "Identify top expense categories for potential savings.",
            "Monitor upcoming bills and payments.",
            "Consider setting new financial goals based on this overview."
            // These are generic; n8n agent could potentially generate more specific ones.
          ]
        };

        // Slide 8: Concluding Slide
        presentationData.slide8 = {
          title: "Thank You",
          message: "This financial overview was generated based on the available data."
        };
        
        return presentationData;
      }

      async function sendToN8N(data) {
        if (N8N_WEBHOOK_URL === "YOUR_N8N_WEBHOOK_URL_HERE" || !N8N_WEBHOOK_URL) {
          alert("N8N Webhook URL is not configured. Please update it in the script.");
          console.error("N8N Webhook URL is not configured.");
          return;
        }
        try {
          showProcessingBar("Generating presentation data...");
          const response = await fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
          });
          hideProcessingBar();
          if (response.ok) {
            alert('Presentation data sent to N8N successfully!');
            console.log('Data sent to N8N:', data);
          } else {
            const errorText = await response.text();
            alert(`Failed to send data to N8N. Status: ${response.status}. Details: ${errorText}`);
            console.error('Failed to send data to N8N:', response.status, errorText);
          }
        } catch (error) {
          hideProcessingBar();
          alert('Error sending data to N8N: ' + error.message);
          console.error('Error sending data to N8N:', error);
        }
      }

      const agentButton = document.getElementById('agent-action-button');
      if (agentButton) {
        agentButton.addEventListener('click', async () => {
          if (Object.keys(dailyActivity).length === 0 && globalAllTransactions.length === 0) {
            alert("No data available to generate a presentation. Please upload some files first.");
            return;
          }
          const dataForN8N = await generatePresentationData();
          await sendToN8N(dataForN8N);
        });      }
      // --- End Presentation Generation Logic ---

      // --- Budget Widget Implementation ---
      
      let budgetData = {};
      const budgetStorageKey = 'financeBudgetData';
      
      // Load budget data from localStorage
      function loadBudgetData() {
        const stored = localStorage.getItem(budgetStorageKey);
        if (stored) {
          try {
            budgetData = JSON.parse(stored);
          } catch (e) {
            console.error('Error loading budget data:', e);
            budgetData = {};
          }
        }
      }        // Save budget data to localStorage
      function saveBudgetData() {
        try {
          localStorage.setItem(budgetStorageKey, JSON.stringify(budgetData));
          showSuccessMessage('Budget saved successfully!');
        } catch (e) {
          console.error('Error saving budget data:', e);
          showSuccessMessage('Error saving budget data. Please try again.');
        }
      }

      // Auto-save budget data to localStorage (silent save)
      function autoSaveBudgetData() {
        try {
          localStorage.setItem(budgetStorageKey, JSON.stringify(budgetData));
        } catch (e) {
          console.error('Error auto-saving budget data:', e);
        }
      }
        // Initialize budget widget
      function initializeBudgetWidget() {
        loadBudgetData();
        setupBudgetModals();
        setupBudgetEventListeners();
        populateBudgetMonthSelector();
        renderBudgetCategories();
        updateBudgetTotals();
      }
      
      // Setup event listeners for budget widget
      function setupBudgetEventListeners() {
        // Toggle widget collapse/expand
        const toggleBtn = document.getElementById('budgetToggleBtn');
        const widgetContainer = document.querySelector('.budget-widget-container');
        
        if (toggleBtn) {
          toggleBtn.addEventListener('click', () => {
            widgetContainer.classList.toggle('collapsed');
          });
        }
        
        // Month selector change
        const monthSelector = document.getElementById('budgetMonthSelector');
        if (monthSelector) {
          monthSelector.addEventListener('change', () => {
            renderBudgetCategories();
            updateBudgetTotals();
          });
        }          // Action buttons
        const addCategoryBtn = document.getElementById('addCategoryBudgetBtn');
        const resetBudgetBtn = document.getElementById('resetBudgetBtn');
        
        // Add mouse tracking for gradient effects
        const budgetActionBtns = [addCategoryBtn, resetBudgetBtn];
        budgetActionBtns.forEach(btn => {
          if (btn) {
            btn.addEventListener('mousemove', (e) => {
              const rect = btn.getBoundingClientRect();
              const x = ((e.clientX - rect.left) / rect.width) * 100;
              const y = ((e.clientY - rect.top) / rect.height) * 100;
              btn.style.setProperty('--mouse-x', `${x}%`);
              btn.style.setProperty('--mouse-y', `${y}%`);
            });
          }
        });        if (addCategoryBtn) {
          addCategoryBtn.addEventListener('click', () => {
            showAddCategoryDialog();
          });
        }
          if (resetBudgetBtn) {
          resetBudgetBtn.addEventListener('click', () => {
            resetCurrentMonthBudget();
          });
        }
      }
      
      // Populate month selector with available months
      function populateBudgetMonthSelector() {
        const selector = document.getElementById('budgetMonthSelector');
        if (!selector) return;
        
        selector.innerHTML = '';
        
        // Get current month as default
        const today = new Date();
        const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        
        // Get months from existing data
        const availableMonths = new Set();
        availableMonths.add(currentMonth); // Always include current month
        
        // Add months from daily activity data
        Object.keys(dailyActivity).forEach(dateKey => {
          const month = dateKey.substring(0, 7); // Extract YYYY-MM
          availableMonths.add(month);
        });
        
        // Sort months (newest first)
        const sortedMonths = Array.from(availableMonths).sort().reverse();
        
        sortedMonths.forEach(month => {
          const option = document.createElement('option');
          option.value = month;
          const [year, monthNum] = month.split('-');
          const monthName = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long', year: 'numeric' });
          option.textContent = monthName;
          selector.appendChild(option);
        });
        
        // Set current month as selected
        selector.value = currentMonth;
      }
      
      // Render budget categories for selected month
      function renderBudgetCategories() {
        const container = document.getElementById('budgetCategoriesList');
        const monthSelector = document.getElementById('budgetMonthSelector');
        
        if (!container || !monthSelector) return;
        
        const selectedMonth = monthSelector.value;
        container.innerHTML = '';
        
        // Ensure budget data exists for this month
        if (!budgetData[selectedMonth]) {
          budgetData[selectedMonth] = {};
        }
        
        // Calculate spending for each category in the selected month
        const monthlySpending = calculateMonthlySpending(selectedMonth);
        
        // Get all categories (predefined + custom budget categories)
        const allCategories = new Set([...CATEGORIES]);
        Object.keys(budgetData[selectedMonth]).forEach(cat => allCategories.add(cat));
        
        const sortedCategories = Array.from(allCategories).sort();
          sortedCategories.forEach(category => {
          const budgetAmount = budgetData[selectedMonth][category] || 0;
          const spentAmount = monthlySpending[category] || 0;
          const remaining = budgetAmount - spentAmount;
          const progressPercent = budgetAmount > 0 ? Math.min((spentAmount / budgetAmount) * 100, 100) : 0;
          
          const categoryRow = document.createElement('div');
          categoryRow.className = 'budget-category-item';
          categoryRow.innerHTML = `
            <div class="budget-category-name">${category}</div>
            <div class="budget-category-budget">
              <input type="number" 
                     class="budget-input" 
                     value="${budgetAmount}" 
                     min="0" 
                     step="0.01"
                     data-category="${category}">
            </div>
            <div class="budget-category-spent">$${spentAmount.toFixed(2)}</div>
            <div class="budget-category-remaining ${remaining >= 0 ? 'positive' : 'negative'}">
              $${remaining.toFixed(2)}
            </div>
            <div class="budget-category-progress">
              <div class="budget-progress-bar">
                <div class="budget-progress-fill ${getProgressBarClass(progressPercent)}" 
                     style="width: ${progressPercent}%"></div>
              </div>
              <span class="budget-progress-text">${progressPercent.toFixed(1)}%</span>
            </div>
            <button class="budget-delete-btn" data-category="${category}" title="Remove Category">
              <svg viewBox="0 0 24 24" class="trash-icon">
                <path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-4.5l-1-1z"/>
              </svg>
            </button>
          `;
          
          container.appendChild(categoryRow);
        });
          // Add event listeners for budget inputs
        container.querySelectorAll('.budget-input').forEach(input => {
          input.addEventListener('change', (e) => {
            const category = e.target.dataset.category;
            const amount = parseFloat(e.target.value) || 0;
            budgetData[selectedMonth][category] = amount;
            autoSaveBudgetData(); // Auto-save changes
            renderBudgetCategories(); // Re-render to update calculations
            updateBudgetTotals();
          });
        });        // Add event listeners for delete buttons
        container.querySelectorAll('.budget-delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const category = e.target.dataset.category;
            categoryToDelete = category;
            
            // Update category name in modal
            const deleteCategoryNameEl = document.getElementById('deleteCategoryName');
            if (deleteCategoryNameEl) {
              deleteCategoryNameEl.textContent = category;
            }
            
            showBudgetModal('budgetDeleteCategoryModal');
          });
        });
        
        // Setup animated gradient effects for newly created delete buttons
        setupAnimatedButtons();
      }
      
      // Calculate monthly spending by category
      function calculateMonthlySpending(monthKey) {
        const spending = {};
        
        // Initialize all categories with 0
        CATEGORIES.forEach(cat => spending[cat] = 0);
        
        // Sum spending for the selected month
        Object.keys(dailyActivity).forEach(dateKey => {
          if (dateKey.startsWith(monthKey)) {
            const dayData = dailyActivity[dateKey];
            if (dayData && dayData.categories) {
              Object.keys(dayData.categories).forEach(category => {
                if (!spending[category]) spending[category] = 0;
                spending[category] += dayData.categories[category] || 0;
              });
            }
          }
        });
        
        return spending;
      }
      
      // Get CSS class for progress bar based on percentage
      function getProgressBarClass(percent) {
        if (percent <= 50) return 'progress-low';
        if (percent <= 80) return 'progress-medium';
        if (percent <= 100) return 'progress-high';
        return 'progress-over';
      }
      
      // Update budget totals display
      function updateBudgetTotals() {
        const monthSelector = document.getElementById('budgetMonthSelector');
        const totalAmountEl = document.getElementById('totalBudgetAmount');
        const remainingEl = document.getElementById('budgetRemaining');
        
        if (!monthSelector || !totalAmountEl || !remainingEl) return;
        
        const selectedMonth = monthSelector.value;
        const monthBudget = budgetData[selectedMonth] || {};
        const monthlySpending = calculateMonthlySpending(selectedMonth);
        
        let totalBudget = 0;
        let totalSpent = 0;
        
        Object.keys(monthBudget).forEach(category => {
          totalBudget += monthBudget[category] || 0;
        });
        
        Object.keys(monthlySpending).forEach(category => {
          if (monthBudget[category] > 0) { // Only count spending for budgeted categories
            totalSpent += monthlySpending[category] || 0;
          }
        });
        
        const remaining = totalBudget - totalSpent;
        
        totalAmountEl.textContent = `$${totalBudget.toFixed(2)}`;
        remainingEl.textContent = `($${Math.abs(remaining).toFixed(2)} ${remaining >= 0 ? 'remaining' : 'over'})`;
        remainingEl.className = `budget-remaining ${remaining >= 0 ? 'positive' : 'negative'}`;
      }
        // Show dialog to add new category budget
      function showAddCategoryDialog() {
        // Clear previous inputs
        const categoryNameInput = document.getElementById('budgetCategoryNameInput');
        const categoryAmountInput = document.getElementById('budgetCategoryAmountInput');
        
        if (categoryNameInput) categoryNameInput.value = '';
        if (categoryAmountInput) categoryAmountInput.value = '';
        
        showBudgetModal('budgetAddCategoryModal');
        
        // Focus on category name input
        if (categoryNameInput) {
          setTimeout(() => categoryNameInput.focus(), 100);
        }
      }
        // Reset budget for current month
      function resetCurrentMonthBudget() {
        const monthSelector = document.getElementById('budgetMonthSelector');
        const selectedMonth = monthSelector.value;
        const resetMonthDisplay = document.getElementById('resetMonthDisplay');
        
        // Update month display in modal
        if (resetMonthDisplay) {
          const [year, monthNum] = selectedMonth.split('-');
          const monthName = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long', year: 'numeric' });
          resetMonthDisplay.textContent = monthName;
        }
        
        showBudgetModal('budgetResetModal');
      }
        // Update budget widget when data changes
      function updateBudgetOnDataChange() {
        if (document.getElementById('budgetMonthSelector')) {
          populateBudgetMonthSelector();
          renderBudgetCategories();
          updateBudgetTotals();
        }
      }
      
      // Budget Modal Helper Functions
      function showBudgetModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = 'flex';
        }
      }
      
      function hideBudgetModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = 'none';
        }
      }
      
      // Modal Action Handlers
      let categoryToDelete = '';
        function handleAddCategoryConfirm() {
        const categoryNameInput = document.getElementById('budgetCategoryNameInput');
        const categoryAmountInput = document.getElementById('budgetCategoryAmountInput');
        
        const categoryName = categoryNameInput.value.trim();
        const amount = parseFloat(categoryAmountInput.value) || 0;
        
        if (!categoryName) {
          categoryNameInput.focus();
          return;
        }
        
        const monthSelector = document.getElementById('budgetMonthSelector');
        const selectedMonth = monthSelector.value;
        
        if (!budgetData[selectedMonth]) {
          budgetData[selectedMonth] = {};
        }
        
        budgetData[selectedMonth][categoryName] = amount;
        autoSaveBudgetData(); // Auto-save changes
        renderBudgetCategories();
        updateBudgetTotals();
        
        // Clear inputs and hide modal
        categoryNameInput.value = '';
        categoryAmountInput.value = '';
        hideBudgetModal('budgetAddCategoryModal');
      }
        function handleResetConfirm() {
        const monthSelector = document.getElementById('budgetMonthSelector');
        const selectedMonth = monthSelector.value;
        
        budgetData[selectedMonth] = {};
        autoSaveBudgetData(); // Auto-save changes
        renderBudgetCategories();
        updateBudgetTotals();
        hideBudgetModal('budgetResetModal');
      }
        function handleDeleteCategoryConfirm() {
        const monthSelector = document.getElementById('budgetMonthSelector');
        const selectedMonth = monthSelector.value;
        
        if (categoryToDelete && budgetData[selectedMonth]) {
          delete budgetData[selectedMonth][categoryToDelete];
          autoSaveBudgetData(); // Auto-save changes
          renderBudgetCategories();
          updateBudgetTotals();
        }
        
        categoryToDelete = '';
        hideBudgetModal('budgetDeleteCategoryModal');
      }
      
      function showSuccessMessage(message) {
        const successMessageEl = document.getElementById('successMessage');
        if (successMessageEl) {
          successMessageEl.textContent = message;
        }
        showBudgetModal('budgetSuccessModal');
      }
      
      function setupBudgetModals() {
        // Add Category Modal
        const addCategoryModal = document.getElementById('budgetAddCategoryModal');
        const closeAddCategoryModal = document.getElementById('closeAddCategoryModal');
        const cancelAddCategoryBtn = document.getElementById('cancelAddCategoryBtn');
        const confirmAddCategoryBtn = document.getElementById('confirmAddCategoryBtn');
        const categoryNameInput = document.getElementById('budgetCategoryNameInput');
        const categoryAmountInput = document.getElementById('budgetCategoryAmountInput');
        
        if (closeAddCategoryModal) {
          closeAddCategoryModal.addEventListener('click', () => hideBudgetModal('budgetAddCategoryModal'));
        }
        if (cancelAddCategoryBtn) {
          cancelAddCategoryBtn.addEventListener('click', () => hideBudgetModal('budgetAddCategoryModal'));
        }
        if (confirmAddCategoryBtn) {
          confirmAddCategoryBtn.addEventListener('click', handleAddCategoryConfirm);
        }
        
        // Add keyboard support for Add Category modal
        if (categoryNameInput) {
          categoryNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              categoryAmountInput.focus();
            }
          });
        }
        if (categoryAmountInput) {
          categoryAmountInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              handleAddCategoryConfirm();
            }
          });
        }
        
        // Reset Budget Modal
        const resetModal = document.getElementById('budgetResetModal');
        const closeResetModal = document.getElementById('closeResetModal');
        const cancelResetBtn = document.getElementById('cancelResetBtn');
        const confirmResetBtn = document.getElementById('confirmResetBtn');
        
        if (closeResetModal) {
          closeResetModal.addEventListener('click', () => hideBudgetModal('budgetResetModal'));
        }
        if (cancelResetBtn) {
          cancelResetBtn.addEventListener('click', () => hideBudgetModal('budgetResetModal'));
        }
        if (confirmResetBtn) {
          confirmResetBtn.addEventListener('click', handleResetConfirm);
        }
        
        // Delete Category Modal
        const deleteCategoryModal = document.getElementById('budgetDeleteCategoryModal');
        const closeDeleteCategoryModal = document.getElementById('closeDeleteCategoryModal');
        const cancelDeleteCategoryBtn = document.getElementById('cancelDeleteCategoryBtn');
        const confirmDeleteCategoryBtn = document.getElementById('confirmDeleteCategoryBtn');
        
        if (closeDeleteCategoryModal) {
          closeDeleteCategoryModal.addEventListener('click', () => hideBudgetModal('budgetDeleteCategoryModal'));
        }
        if (cancelDeleteCategoryBtn) {
          cancelDeleteCategoryBtn.addEventListener('click', () => hideBudgetModal('budgetDeleteCategoryModal'));
        }
        if (confirmDeleteCategoryBtn) {
          confirmDeleteCategoryBtn.addEventListener('click', handleDeleteCategoryConfirm);
        }
        
        // Success Modal
        const successModal = document.getElementById('budgetSuccessModal');
        const closeSuccessModal = document.getElementById('closeSuccessModal');
        const closeSuccessBtn = document.getElementById('closeSuccessBtn');
        
        if (closeSuccessModal) {
          closeSuccessModal.addEventListener('click', () => hideBudgetModal('budgetSuccessModal'));
        }
        if (closeSuccessBtn) {
          closeSuccessBtn.addEventListener('click', () => hideBudgetModal('budgetSuccessModal'));
        }
        
        // Close modal when clicking outside
        [addCategoryModal, resetModal, deleteCategoryModal, successModal].forEach(modal => {
          if (modal) {
            modal.addEventListener('click', (e) => {
              if (e.target === modal) {
                modal.style.display = 'none';
              }
            });
          }
        });
        
        // Global keyboard event handler for modals
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            // Close any open budget modal
            [addCategoryModal, resetModal, deleteCategoryModal, successModal].forEach(modal => {
              if (modal && modal.style.display === 'flex') {
                modal.style.display = 'none';
              }
            });
          }
        });
      }      // Initialize budget widget
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeBudgetWidget);
      } else {
        initializeBudgetWidget();
      }        // --- End Budget Widget Implementation ---      // --- Sidebar Dropdown Functionality ---
      function initializeSidebarDropdown() {
        // Finance dropdown
        const financeMainIcon = document.getElementById('financeMainIcon');
        const financeSubmenu = document.getElementById('financeSubmenu');
        
        // Productivity dropdown
        const productivityMainIcon = document.getElementById('productivityMainIcon');
        const productivitySubmenu = document.getElementById('productivitySubmenu');
          // Function to toggle a specific dropdown
        function toggleDropdown(icon, submenu) {
          if (!icon || !submenu) return;
          
          const isExpanded = submenu.classList.contains('expanded');
          
          // Close all dropdowns first
          document.querySelectorAll('.sidebar-submenu').forEach(menu => menu.classList.remove('expanded'));
          
          // If it wasn't expanded, expand this one and return true (indicating we toggled)
          if (!isExpanded) {
            submenu.classList.add('expanded');
            return true;
          }
          return false; // Indicate we just closed it
        }
        
        // Finance dropdown event listener
        if (financeMainIcon && financeSubmenu) {
          financeMainIcon.addEventListener('click', (e) => {
            const wasToggled = toggleDropdown(financeMainIcon, financeSubmenu);
            if (wasToggled) {
              e.preventDefault(); // Only prevent navigation if we opened a dropdown
              e.stopPropagation();
            }
            // If wasToggled is false, allow normal navigation behavior
          });
        }
        
        // Productivity dropdown event listener
        if (productivityMainIcon && productivitySubmenu) {
          productivityMainIcon.addEventListener('click', (e) => {
            const wasToggled = toggleDropdown(productivityMainIcon, productivitySubmenu);
            if (wasToggled) {
              e.preventDefault(); // Only prevent navigation if we opened a dropdown
              e.stopPropagation();
            }
            // If wasToggled is false, allow normal navigation behavior
          });
        }
        
        // Close dropdown when clicking elsewhere
        document.addEventListener('click', (e) => {
          const isDropdownClick = e.target.closest('.sidebar-item-main') || e.target.closest('.sidebar-submenu');
          if (!isDropdownClick) {
            document.querySelectorAll('.sidebar-submenu').forEach(menu => menu.classList.remove('expanded'));
          }
        });
        
        // Close dropdown on escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            document.querySelectorAll('.sidebar-submenu').forEach(menu => menu.classList.remove('expanded'));
          }
        });
      }
      
      // Initialize sidebar dropdown
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeSidebarDropdown);
      } else {
        initializeSidebarDropdown();
      }

      setupTimeframeControls(); // Call to initialize the new synchronized controls
    </script>
</body>
</html>