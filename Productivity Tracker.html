<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Twoâ€‘Column Task Dashboard with Rounded Bars</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <!-- Immediate theme application to prevent white flash -->
  <script>
    (function() {
      // Check for saved theme preference and apply immediately
      let currentTheme = localStorage.getItem('dashboard-theme');
      
      // Migration: check for old theme key and migrate it
      if (!currentTheme) {
        const oldTheme = localStorage.getItem('theme');
        if (oldTheme) {
          currentTheme = oldTheme;
          localStorage.setItem('dashboard-theme', oldTheme);
          localStorage.removeItem('theme');
        } else {
          currentTheme = 'light';
        }
      }
      
      // Apply theme immediately to prevent flash
      document.documentElement.setAttribute('data-theme', currentTheme);
    })();
  </script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">  <style>
    /* === CSS VARIABLES FOR THEMING === */
    :root {
      /* Light Mode Colors */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F8FAFC;
      --bg-tertiary: #F1F5F9;
      --text-primary: #1E293B;
      --text-secondary: #64748B;
      --text-muted: #94A3B8;
      --border-color: #E2E8F0;
      --accent-primary: #8B5CF6;
      --accent-secondary: #06B6D4;
      --success-color: #10B981;
      --warning-color: #F59E0B;
      --error-color: #EF4444;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --overlay-bg: rgba(0, 0, 0, 0.5);      --button-disabled-text: #9CA3AF;
      --priority-low: #10B981;
      --priority-medium: #F59E0B;
      --priority-high: #EF4444;
      --button-gradient-start: #8B5CF6;
      --button-gradient-end: #A855F7;
      --button-shadow: rgba(139, 92, 246, 0.3);
      --button-hover-glow: rgba(139, 92, 246, 0.6);
      --button-text-selected: #FFFFFF;
      --button-hover-border: rgba(139, 92, 246, 0.4);
      --button-hover-gradient-center: rgba(139, 92, 246, 0.4);      --button-hover-gradient-mid: rgba(139, 92, 246, 0.2);
      --button-active-gradient-center: rgba(255, 255, 255, 0.3);
      --button-active-gradient-mid: rgba(255, 255, 255, 0.1);
      --heatmap-level-1: rgba(139, 92, 246, 0.3);
      --heatmap-level-2: rgba(139, 92, 246, 0.6);
      --heatmap-level-3: #8B5CF6;
    }

    /* Dark Mode */
    [data-theme="dark"] {
      --bg-primary: #0D0B14;
      --bg-secondary: #1A1625;
      --bg-tertiary: #211D30;
      --text-primary: #E0E0E0;
      --text-secondary: #A0A0A0;
      --text-muted: #6B7280;
      --border-color: #4F4B68;
      --accent-primary: #63FFDA;
      --accent-secondary: #A076F9;
      --success-color: #39FF14;
      --warning-color: #FFC107;
      --error-color: #FF6B6B;
      --shadow-color: rgba(0, 0, 0, 0.5);
      --overlay-bg: rgba(0, 0, 0, 0.7);      --button-disabled-text: #4B5563;
      --priority-low: #4CAF50;
      --priority-medium: #FFC107;
      --priority-high: #F44336;
      --button-gradient-start: #63FFDA;
      --button-gradient-end: #63FFDA;
      --button-shadow: rgba(99, 255, 218, 0.3);
      --button-hover-glow: rgba(99, 255, 218, 1);
      --button-text-selected: #000000;
      --button-hover-border: rgba(99, 255, 218, 0.5);
      --button-hover-gradient-center: rgba(99, 255, 218, 0.4);      --button-hover-gradient-mid: rgba(99, 255, 218, 0.2);
      --button-active-gradient-center: rgba(0, 0, 0, 0.3);
      --button-active-gradient-mid: rgba(0, 0, 0, 0.1);
      --heatmap-level-1: rgba(99, 255, 218, 0.3);
      --heatmap-level-2: rgba(99, 255, 218, 0.6);
      --heatmap-level-3: #63FFDA;
    }

    /* === GLOBAL RESET & BASE === */
    * { box-sizing: border-box; }
    
    html, body, .app-container, .dashboard, .widget-row {
      overflow-x: hidden;
    }
    
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 40px;
      display: flex;
      justify-content: center;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    .app-container {
      width: 100%;
      max-width: 1400px;
    }

    /* === DRAG & DROP === */
    .sortable-fallback, .sortable-ghost {
      position: fixed !important;
      pointer-events: none;
      z-index: 10000;
      width: auto !important;
      max-width: 100% !important;
      height: auto !important;
    }    /* === REUSABLE COMPONENTS === */
    .card {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px var(--shadow-color);
      margin-bottom: 24px;
      position: relative;
      width: 100%;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }    .drag-handle {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      cursor: grab;
      background: url('data:image/svg+xml;utf8,<svg width="24" height="24" fill="%23A0A0A0" xmlns="http://www.w3.org/2000/svg"><path d="M4 9h2V7H4v2zm4 0h2V7H8v2zm4 0h2V7h-2v2zm4 0h2V7h-2v2zM4 13h2v-2H4v2zm4 0h2v-2H8v2zm4 0h2v-2h-2v2zm4 0h2v-2h-2v2z"/></svg>') no-repeat center;
      opacity: 0.6;
      transition: opacity 0.3s ease;
    }

    .drag-handle:hover {
      opacity: 1;
    }/* === TASK MANAGEMENT === */
    .task-input {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .priority-select {
      display: flex;
      gap: 8px;
      margin-right: 8px;
    }    .priority-btn {
      width: 16px;
      height: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s ease;
    }
    .priority-btn.selected { opacity: 1; }
    .priority-btn.low { background: var(--priority-low); }
    .priority-btn.med { background: var(--priority-medium); }
    .priority-btn.high { background: var(--priority-high); }

    .task-input input {
      flex: 1;
      height: 36px;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
      transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
    }

    .task-input input:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    .task-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
      padding-top: 24px;
    }    .task-list li {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
      position: relative;
      transition: border-color 0.3s ease;
    }

    .task-list label {
      margin-left: 8px;
      flex: 1;
      color: var(--text-primary);
      margin-right: 8px;
      transition: color 0.3s ease;
    }    .edit-btn, .delete-btn {
      background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
      border: 1px solid var(--border-color);
      padding: 8px 12px;
      margin: 0 6px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      --mouse-x: 50%;
      --mouse-y: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 32px;
      min-width: 32px;
      box-shadow: 
        0 2px 4px var(--shadow-light),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .edit-btn {
      color: var(--accent-primary);
      border-color: rgba(139, 92, 246, 0.2);
      background: linear-gradient(145deg, 
        rgba(139, 92, 246, 0.05), 
        rgba(139, 92, 246, 0.02)
      );
    }
    
    .delete-btn {
      color: var(--error-color);
      border-color: rgba(244, 67, 54, 0.2);
      background: linear-gradient(145deg, 
        rgba(244, 67, 54, 0.05), 
        rgba(244, 67, 54, 0.02)
      );
    }

    .edit-btn:hover {
      background: linear-gradient(145deg, 
        rgba(139, 92, 246, 0.15), 
        rgba(139, 92, 246, 0.08)
      );
      border-color: rgba(139, 92, 246, 0.6);
      box-shadow: 
        0 4px 12px rgba(139, 92, 246, 0.25),
        0 2px 4px var(--shadow-light),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transform: translateY(-2px) scale(1.05);
      color: var(--accent-primary);
    }

    .delete-btn:hover {
      background: linear-gradient(145deg, 
        rgba(244, 67, 54, 0.15), 
        rgba(244, 67, 54, 0.08)
      );
      border-color: rgba(244, 67, 54, 0.6);
      box-shadow: 
        0 4px 12px rgba(244, 67, 54, 0.25),
        0 2px 4px var(--shadow-light),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transform: translateY(-2px) scale(1.05);
      color: var(--error-color);
    }

    .edit-btn:active, .delete-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 
        0 1px 2px var(--shadow-light),
        inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Enhanced animated gradient effects for edit/delete buttons */
    .edit-btn::before, .delete-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(
        circle at var(--mouse-x) var(--mouse-y),
        rgba(255, 255, 255, 0.15) 0%,
        rgba(255, 255, 255, 0.05) 30%,
        transparent 60%
      );
      opacity: 0;
      transition: opacity 0.4s ease;
      border-radius: inherit;
      z-index: 1;
      pointer-events: none;
    }

    .edit-btn:hover::before, .delete-btn:hover::before {
      opacity: 1;
    }

    /* Subtle inner glow effect */
    .edit-btn::after {
      content: '';
      position: absolute;
      top: 1px;
      left: 1px;
      right: 1px;
      bottom: 1px;
      background: linear-gradient(145deg, 
        rgba(139, 92, 246, 0.1), 
        transparent 50%
      );
      border-radius: 6px;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 0;
    }

    .delete-btn::after {
      content: '';
      position: absolute;
      top: 1px;
      left: 1px;
      right: 1px;
      bottom: 1px;
      background: linear-gradient(145deg, 
        rgba(244, 67, 54, 0.1), 
        transparent 50%
      );
      border-radius: 6px;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 0;
    }

    .edit-btn:hover::after, .delete-btn:hover::after {
      opacity: 1;
    }

    .edit-container {
      display: none;
      align-items: center;
      margin-left: auto;
      gap: 4px;
    }    .edit-container input[type="number"] {
      width: 60px;
      padding: 4px 6px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 12px;
      appearance: textfield;
      -moz-appearance: textfield;
      transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
    }

    .edit-container input[type="number"]::-webkit-outer-spin-button,
    .edit-container input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .task-list li.editing .edit-btn { display: none; }
    .task-list li.editing .edit-container { display: flex; }    .tooltip {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      box-shadow: 0 2px 8px var(--shadow-color);
      z-index: 10;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    .task-list li:hover .tooltip { display: block; }    /* === DROPDOWN & SWITCHES === */
    .task-dropdown {
      position: relative;
      margin-left: 8px;
    }    .task-dropdown summary.options-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 36px;
      padding: 0 16px;
      border: 1px solid var(--accent-primary);
      border-radius: 4px;
      background: var(--bg-primary);
      color: var(--accent-primary);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      line-height: normal;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    .task-dropdown summary.options-btn::-webkit-details-marker {
      display: none;
    }

    .task-dropdown-content {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      min-width: 150px;
      background: var(--bg-secondary);
      padding: 8px;
      border-radius: 4px;
      z-index: 10;
      display: none;
      box-shadow: 0 4px 12px var(--shadow-color);
      border: 1px solid var(--border-color);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .task-dropdown[open] .task-dropdown-content { display: block; }
    .task-dropdown-content label { 
      display: block; 
      color: var(--text-primary); 
      margin-bottom: 4px; 
      font-size: 14px;
      transition: color 0.3s ease;
    }
    .task-dropdown-content input {
      width: 100%; 
      padding: 4px 8px; 
      margin-top: 2px;
      border: 1px solid var(--border-color); 
      border-radius: 4px; 
      background: var(--bg-primary); 
      color: var(--text-primary);
      transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
      margin-left: 8px;
      vertical-align: middle;
    }

    .switch input { opacity: 0; width: 0; height: 0; }    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--border-color);
      border-radius: 34px;
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background: var(--bg-primary);
      border-radius: 50%;
      transition: .4s;
    }

    .switch input:checked + .slider {
      background: var(--accent-primary);
    }

    .switch input:checked + .slider:before {
      transform: translateX(20px);
    }    /* === UNIFIED BUTTON SYSTEM === */
    .task-input button,
    .task-dropdown summary.options-btn,
    .timeframe-toggle button,
    .landing-timeframe-controls button,
    .difficulty-toggle button,
    .priority-difficulty-toggle button {
      background: none;
      border: 1px solid transparent;
      color: var(--accent-primary);
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s, box-shadow 0.2s, border-color 0.2s;
      outline: none;
      box-shadow: none;
      height: 42px;
      padding: 14px 18px;
      font-size: 14px;
      margin-left: 8px;
      display: flex;      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .task-input button:not(.active):hover,
    .task-dropdown summary.options-btn:hover,
    .timeframe-toggle button:not(.active):hover,
    .landing-timeframe-controls button:not(.active):hover,
    .difficulty-toggle button:not(.active):hover,
    .priority-difficulty-toggle button:not(.active):hover,
    .timeframe-toggle button:not(.selected):hover,
    .landing-timeframe-controls button:not(.selected):hover {      background-color: transparent;
      color: var(--accent-primary);
      border-color: transparent;
      box-shadow: 0 0 8px var(--accent-primary);
    }

    /* === ANIMATED GRADIENT EFFECTS === */
    .task-input button,
    .task-dropdown summary.options-btn,
    .timeframe-toggle button,
    .landing-timeframe-controls button,
    .difficulty-toggle button,
    .priority-difficulty-toggle button {
      position: relative;
      overflow: hidden;
      --mouse-x: 50%;
      --mouse-y: 50%;
    }

    .task-input button::before,
    .task-dropdown summary.options-btn::before,
    .timeframe-toggle button::before,
    .landing-timeframe-controls button::before,
    .difficulty-toggle button::before,
    .priority-difficulty-toggle button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(
        circle at var(--mouse-x) var(--mouse-y),
        var(--button-hover-gradient-center) 0%,
        var(--button-hover-gradient-mid) 30%,
        transparent 60%
      );
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: inherit;
      z-index: 1;
      pointer-events: none;
    }

    .task-input button:hover::before,
    .task-dropdown summary.options-btn:hover::before,
    .timeframe-toggle button:hover::before,
    .landing-timeframe-controls button:hover::before,
    .difficulty-toggle button:hover::before,
    .priority-difficulty-toggle button:hover::before {
      opacity: 1;
    }

    .task-input button span,
    .task-dropdown summary.options-btn span,
    .timeframe-toggle button span,
    .landing-timeframe-controls button span,
    .difficulty-toggle button span,
    .priority-difficulty-toggle button span {
      position: relative;
      z-index: 2;
    }

    .task-input button.active,
    .task-dropdown summary.options-btn.active,
    .timeframe-toggle button.active,
    .landing-timeframe-controls button.active,
    .difficulty-toggle button.active,
    .priority-difficulty-toggle button.active,
    .timeframe-toggle button.selected,
    .landing-timeframe-controls button.selected {
      background: linear-gradient(135deg, var(--button-gradient-start), var(--button-gradient-end));
      color: var(--button-text-selected);
      border-color: var(--accent-primary);
      box-shadow: 0 4px 15px var(--button-shadow);
    }    .task-input button.active::before,
    .task-dropdown summary.options-btn.active::before,
    .timeframe-toggle button.active::before,
    .landing-timeframe-controls button.active::before,
    .difficulty-toggle button.active::before,
    .priority-difficulty-toggle button.active::before,
    .timeframe-toggle button.selected::before,
    .landing-timeframe-controls button.selected::before {
      background: radial-gradient(
        circle at var(--mouse-x) var(--mouse-y),
        var(--button-active-gradient-center) 0%,
        var(--button-active-gradient-mid) 30%,
        transparent 60%
      );
      opacity: 0.3;
    }    .task-input button.active:hover::before,
    .task-dropdown summary.options-btn.active:hover::before,
    .timeframe-toggle button.active:hover::before,
    .landing-timeframe-controls button.active:hover::before,
    .difficulty-toggle button.active:hover::before,
    .priority-difficulty-toggle button.active:hover::before,
    .timeframe-toggle button.selected:hover::before,
    .landing-timeframe-controls button.selected:hover::before {
      opacity: 0.6;
    }

    /* === TEXT VISIBILITY FIX FOR SELECTED BUTTONS ON HOVER === */
    .task-input button.active:hover,
    .task-input button.selected:hover,
    .task-dropdown summary.options-btn.active:hover,
    .timeframe-toggle button.active:hover,
    .timeframe-toggle button.selected:hover,
    .landing-timeframe-controls button.active:hover,
    .landing-timeframe-controls button.selected:hover,
    .difficulty-toggle button.active:hover,
    .difficulty-toggle button.selected:hover,
    .priority-difficulty-toggle button.active:hover,
    .priority-difficulty-toggle button.selected:hover {
      color: var(--button-text-selected) !important;
    }

    .task-input button.active:hover span,
    .task-input button.selected:hover span,
    .task-dropdown summary.options-btn.active:hover span,
    .timeframe-toggle button.active:hover span,
    .timeframe-toggle button.selected:hover span,
    .landing-timeframe-controls button.active:hover span,
    .landing-timeframe-controls button.selected:hover span,
    .difficulty-toggle button.active:hover span,
    .difficulty-toggle button.selected:hover span,
    .priority-difficulty-toggle button.active:hover span,
    .priority-difficulty-toggle button.selected:hover span {
      color: var(--button-text-selected) !important;
      z-index: 3;
    }

    .task-input button:hover:not(.active):not(.selected),
    .task-dropdown summary.options-btn:hover:not(.active):not(.selected),
    .timeframe-toggle button:hover:not(.active):not(.selected),
    .landing-timeframe-controls button:hover:not(.active):not(.selected),
    .difficulty-toggle button:hover:not(.active):not(.selected),
    .priority-difficulty-toggle button:hover:not(.active):not(.selected) {
      color: var(--accent-primary);
      border-color: var(--button-hover-border);
      box-shadow: 0 0 12px var(--button-hover-glow);
      transform: translateY(-1px);
    }

    /* === CHART HEADERS & CONTROLS === */
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }    .widget-title {
      font-size: 1.3em;
      font-weight: 600;
      color: var(--accent-primary);
      margin: 0;
      transition: color 0.3s ease;
    }

    .timeframe-toggle,
    .landing-timeframe-controls,
    .difficulty-toggle,
    .priority-difficulty-toggle {
      display: flex;
      gap: 8px;
    }

    .activity-calendar-header {
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .calendar-view-toggle-container {
      position: absolute;
      left: 50%;
      top: 5px;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
    }    .calendar-view-toggle-container label {
      font-size: 12px;
      color: var(--text-secondary);
      transition: color 0.3s ease;
    }/* === CALENDAR NAVIGATION === */
    .calendar-view-year .calendar-title-month-nav,
    .calendar-view-month .calendar-title-year-nav {
      display: none;
    }

    .calendar-view-month .calendar-title-month-nav,
    .calendar-view-year .calendar-title-year-nav {
      display: flex;
      align-items: center;
      gap: 15px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 35px;
    }

    .calendar-view-month .activity-calendar-header h3 {
      margin-bottom: 10px;
    }

    .calendar-title-year-nav {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .activity-calendar-header h3 {
      margin: 0;
      font-weight: 600;
      font-size: 18px;
      width: 120px;
      text-align: left;
    }

    #calendarYearDisplay {
      font-size: 16px;
      color: #A0A0A0;
      font-weight: bold;
    }

    .calendar-nav-btn {
      background: transparent;
      border: none;
      color: #A0A0A0;
      font-size: 20px;
      cursor: pointer;
      padding: 0 5px;
      font-weight: bold;
    }

    .calendar-nav-btn:hover {
      color: #FFF;
    }

    .calendar-legend {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 3px;
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 10px;
      color: #A0A0A0;
      width: 120px;
    }

    .calendar-legend .activity-square {
      width: 11px !important;
      height: 11px !important;
      aspect-ratio: unset !important;
    }

    /* === LAYOUT & CONTAINERS === */
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 12px;
    }

    .hours-chart-container {
      position: relative;
      height: 150px;
      margin-top: 12px;
    }

    .widget-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      align-items: start;
    }

    .widget-row > .card {
      margin-bottom: 0;
    }    .calendar-container {
      position: relative;
      height: 560px;
      margin-top: 12px;
      overflow: hidden;
    }    .difficulty-chart-container,
    .priority-difficulty-chart-container {
      height: 250px;
      margin-top: 13px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card:has(.difficulty-toggle),
    .card:has(#priorityDifficultyChart) {
      height: 360px;
      display: flex;
      flex-direction: column;
    }

    /* Ensure pie chart canvas is properly centered */
    #priorityDifficultyChart {
      max-width: 100%;
      max-height: 100%;
    }    /* === ACTIVITY CALENDAR SQUARES === */
    .activity-squares-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 2px;
      grid-template-columns: none;
      align-content: normal;
      padding: 5px;
      height: auto;
    }

    .calendar-view-month .activity-squares-container {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      justify-content: stretch;
      align-content: start;
      gap: 2px;
      padding: 5px;
      height: 100%;
    }    .activity-square {
      width: 24px;
      height: 24px;
      background-color: var(--bg-tertiary);
      border-radius: 2px;
      transition: background-color 0.3s ease;
    }

    .calendar-view-month .activity-square {
      width: auto;
      height: auto;
      aspect-ratio: 1 / 1;
    }

    .calendar-view-month .activity-square.friday {
      box-sizing: border-box;
      border: 1px solid var(--error-color);
    }

    .padding-square {
      background-color: transparent !important;
      pointer-events: none;
      border: none !important;
      box-shadow: none !important;
    }    .activity-square.heatmap-level-0 { background-color: var(--bg-tertiary); }
    .activity-square.heatmap-level-1 { background-color: var(--heatmap-level-1); }
    .activity-square.heatmap-level-2 { background-color: var(--heatmap-level-2); }
    .activity-square.heatmap-level-3 { background-color: var(--heatmap-level-3); }/* === DELTA INDICATORS === */
    .delta-indicator {
      padding: 5px 10px;
      border-radius: 16px;
      font-size: 1em;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .delta-indicator.increase {
      background-color: rgba(16, 185, 129, 0.12) !important;
      color: var(--success-color) !important;
    }

    .delta-indicator.decrease {
      background-color: rgba(239, 68, 68, 0.12) !important;
      color: var(--error-color) !important;
    }    /* === SIDEBAR === */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 60px;
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      transition: background-color 0.3s ease;
      border-right: 1px solid var(--border-color);
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .sidebar a {
      color: var(--accent-primary);
      font-size: 24px;
      margin: 16px 0;
      text-decoration: none;
      transition: color 0.3s ease, filter 0.3s ease;
    }

    .sidebar a:hover {
      filter: brightness(1.2);
    }

    .sidebar a svg {
      width: 24px;
      height: 24px;
      fill: none;
      stroke: var(--accent-primary);
      stroke-width: 2;
      transition: stroke 0.3s ease;
    }    .sidebar a:hover svg {
      filter: brightness(1.2);
    }    /* === SIDEBAR DROPDOWN STYLES === */
    .sidebar-item {
      position: relative;
      display: flex;
      flex-direction: column;
      margin: 16px 0;
      align-items: center;
    }

    .sidebar-item-container {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      justify-content: center;    }

    .sidebar-item-main {
      display: flex;
      align-items: center;
      color: var(--accent-primary);
      text-decoration: none;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .sidebar-item-main a {
      margin: 0;
      color: inherit;
      text-decoration: none;
    }    .sidebar-submenu {
      position: absolute;
      top: 35px;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      visibility: hidden;
      transform: translateX(-50%) translateY(-10px);
      transition: all 0.3s ease;
      z-index: 1200;
    }.sidebar-submenu.expanded {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }    .sidebar-submenu a {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-primary);
      text-decoration: none;
      transition: all 0.3s ease;
      margin: 8px 0;
      padding: 16px;
      border-radius: 6px;
    }

    .sidebar-submenu a:last-child {
      border-bottom: none;
    }

    .sidebar-submenu a:hover {
      color: var(--accent-primary);
      transform: scale(1.1);
      background: var(--bg-tertiary);
    }

    .sidebar-submenu a svg {
      width: 20px;
      height: 20px;
      stroke: var(--accent-primary);
      stroke-width: 2;
      transition: all 0.3s ease;
    }

    /* === THEME TOGGLE === */
    .theme-toggle {
      background: none;
      border: none;
      color: var(--accent-primary);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background-color 0.3s ease, filter 0.3s ease;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle:hover {
      filter: brightness(1.2);
    }

    .theme-toggle svg {
      width: 24px;
      height: 24px;
      stroke: var(--accent-primary);
      stroke-width: 2;
      fill: none;
      transition: stroke 0.3s ease;
    }

    .theme-toggle .sun-icon {
      display: block;
    }

    .theme-toggle .moon-icon {
      display: none;
    }    [data-theme="dark"] .theme-toggle .sun-icon {
      display: none;
    }

    [data-theme="dark"] .theme-toggle .moon-icon {
      display: block;
    }

    /* SVG icons for edit/delete buttons */
    .edit-btn svg, .delete-btn svg {
      width: 14px;
      height: 14px;
      position: relative;
      z-index: 2;
      pointer-events: none;
    }
    
    .edit-btn .pencil-icon {
      fill: currentColor;
    }
    
    .delete-btn .trash-icon {
      fill: currentColor;
    }
  </style>
</head>
<body>
  <!-- NEW: Persistent Sidebar Navigation -->
  <nav class="sidebar">    <div class="sidebar-nav">
      <a href="Landing Page.html">
        <svg viewBox="0 0 24 24">
          <path d="M3 10L12 3l9 7v11a1 1 0 0 1-1 1h-6v-7h-4v7H4a1 1 0 0 1-1-1V10z"/>
        </svg>
      </a>      <div class="sidebar-item">
        <div class="sidebar-item-container">
          <a href="Personal Finance Tracker.html" title="Finance Tracker" class="sidebar-item-main" id="financeMainIcon">
            <svg viewBox="0 0 24 24">
              <polyline points="3 17 8 12 13 16 21 4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div><div class="sidebar-submenu" id="financeSubmenu">
          <a href="#" title="Investment Tracker">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 3v18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M7 12l3-3 4 4 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div>      </div>      <div class="sidebar-item">
        <div class="sidebar-item-container">
          <a href="Productivity Tracker.html" class="sidebar-item-main" id="productivityMainIcon">
            <svg viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="9"/>
              <polyline points="12 7 12 12 15 15" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div><div class="sidebar-submenu" id="productivitySubmenu">          <a href="#" title="Nutrition Tracker">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <!-- Stylized Apple icon for nutrition/food tracking -->
              <path d="M12 4C9.5 4 7.5 5.5 7 8C6.5 10.5 7 13.5 8.5 16C9.5 17.5 10.5 19 12 19C13.5 19 14.5 17.5 15.5 16C17 13.5 17.5 10.5 17 8C16.5 5.5 14.5 4 12 4Z" fill="currentColor"/>
              <!-- Apple dent/dimple at top -->
              <path d="M12 4C11.5 4.5 11 5 11.5 5.5C12 6 12.5 5.5 13 5C13.5 4.5 13 4 12.5 3.8C12.2 3.9 12 4 12 4Z" fill="currentColor"/>
              <!-- Apple stem -->
              <rect x="11.5" y="2" width="1" height="2.5" rx="0.5" fill="currentColor"/>
              <!-- Apple leaf -->
              <ellipse cx="13.5" cy="3" rx="1.5" ry="0.8" fill="currentColor" opacity="0.8" transform="rotate(30 13.5 3)"/>
              <!-- Apple highlight/shine -->
              <ellipse cx="10" cy="8" rx="1" ry="2" fill="currentColor" opacity="0.3"/>
            </svg>
          </a>
          <a href="#" title="Fitness Tracker">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <!-- Dumbbell icon for fitness tracking -->
              <rect x="2" y="9" width="4" height="6" rx="2" fill="currentColor"/>
              <rect x="18" y="9" width="4" height="6" rx="2" fill="currentColor"/>
              <rect x="6" y="11" width="12" height="2" fill="currentColor"/>
              <circle cx="4" cy="8" r="1.5" fill="currentColor"/>
              <circle cx="4" cy="16" r="1.5" fill="currentColor"/>
              <circle cx="20" cy="8" r="1.5" fill="currentColor"/>
              <circle cx="20" cy="16" r="1.5" fill="currentColor"/>
            </svg>
          </a>
        </div>
      </div>
    </div>
    
    <!-- Theme Toggle Button -->
    <button id="themeToggle" title="Toggle Dark/Light Mode" class="theme-toggle">
      <svg viewBox="0 0 24 24" class="sun-icon">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
      <svg viewBox="0 0 24 24" class="moon-icon" style="display: none;">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
    </button>
  </nav>
  <!-- End NEW Sidebar Navigation -->

  <div class="app-container">
    <div class="dashboard">

      <!-- 1. EXISTING TODO LIST CARD -->
      <div class="card">
        <div class="drag-handle"></div>
        <div class="task-input">
          <div class="priority-select">
            <button class="priority-btn low selected"  data-priority="low"  title="Low"></button>
            <button class="priority-btn med"           data-priority="med"  title="Medium"></button>
            <button class="priority-btn high"          data-priority="high" title="High"></button>
          </div>
          <input id="newTask" type="text" placeholder="Enter a new taskâ€¦">
          <!-- time fields dropdown -->
          <details class="task-dropdown">
            <summary class="options-btn">Options</summary>
            <div class="task-dropdown-content">
              <label>Time Allotted
                <input id="newTimeAllotted" type="number" min="0" placeholder="hrs">
              </label>
              <!-- Difficulty toggle â†’ iOS switch -->
              <label>Difficulty</label>
              <label class="switch">
                <input id="newDifficulty" type="checkbox">
                <span class="slider"></span>
              </label>
              <span id="difficultyLabel">Easy</span>
            </div>
          </details>
          <button id="addBtn">Add Task</button>
        </div>
        <ul id="taskList" class="task-list"></ul>
      </div>

      <!-- 2. OVERALL PERFORMANCE CARD (Moved Here) -->
      <div class="card">
        <div class="drag-handle"></div>
        <div class="chart-header">
          <h3 class="widget-title">Overall Performance</h3> <!-- MODIFICATION: Added widget-title class -->
          <div class="timeframe-toggle landing-timeframe-controls"> <!-- MODIFICATION: Added landing-timeframe-controls class -->
            <button data-range="year" class="active timeframe-btn">This Year</button> <!-- MODIFICATION: Added timeframe-btn class -->
            <button data-range="month" class="timeframe-btn">This Month</button> <!-- MODIFICATION: Added timeframe-btn class -->
            <button data-range="week" class="timeframe-btn">This Week</button> <!-- MODIFICATION: Added timeframe-btn class -->
            <button data-range="day" class="timeframe-btn">Today</button> <!-- MODIFICATION: Added timeframe-btn class -->
          </div>
        </div>
        <div class="chart-container">
          <canvas id="overallPerformanceChart"></canvas>
        </div>
      </div>

      <!-- Row container for Hours Worked and future widget -->
      <div class="widget-row">
        <!-- Column 1: Hours Worked + New Widget -->
        <div> <!-- Added wrapper div for vertical stacking -->
            <!-- 3. HOURS WORKED CARD (Now inside wrapper) -->
            <div class="card">
              <div class="drag-handle"></div>
              <div class="chart-header">
                <h3 class="widget-title">Hours Worked</h3> <!-- MODIFICATION: Added widget-title class -->
                <div class="timeframe-toggle">
                  <button data-range="year" class="active">This Year</button>
                  <button data-range="month">This Month</button>
                  <button data-range="week">This Week</button>
                  <button data-range="day">Today</button>
                </div>
              </div>
              <!-- Total Hours Display Area -->
              <div id="totalHoursDisplay">
                  <span>Total Spent: 0 hrs</span>
                  <span class="delta-indicator"></span> <!-- Added span for delta -->
              </div>
              <div class="hours-chart-container">
                <canvas id="hoursWorkedChart"></canvas>
              </div>
            </div>

            <!-- 5. NEW HALF-WIDTH WIDGET PLACEHOLDER -->
            <!-- Wrapper for side-by-side placeholders -->
            <div style="display: flex; gap: 24px;"> <!-- Added flex wrapper -->
                <!-- Difficulty Completion Chart -->
                <div class="card"> <!-- Removed new-widget-placeholder class -->
                    <div class="drag-handle"></div>
                    <div class="timeframe-toggle difficulty-toggle"> <!-- New toggle group -->
                        <button data-range="year" class="active">This Year</button>
                        <button data-range="month">This Month</button>
                        <button data-range="week">This Week</button>
                        <button data-range="day">Today</button>
                    </div>
                    <div class="difficulty-chart-container"> <!-- Adjusted container height via CSS -->
                        <canvas id="difficultyCompletionChart"></canvas> <!-- New canvas -->
                    </div>
                </div>
                <!-- Priority vs Difficulty Chart -->
                <div class="card"> <!-- Removed new-widget-placeholder class -->
                    <div class="drag-handle"></div>
                    <div class="timeframe-toggle priority-difficulty-toggle"> <!-- New toggle group -->
                        <button data-range="year">This Year</button>
                        <button data-range="month">This Month</button>
                        <button data-range="week">This Week</button>
                        <button data-range="day">Today</button> <!-- Default to Today - REMOVED active CLASS -->
                    </div>
                    <div class="priority-difficulty-chart-container"> <!-- New container -->
                        <canvas id="priorityDifficultyChart"></canvas> <!-- New canvas -->
                    </div>
                </div>
            </div> <!-- End flex wrapper -->
        </div> <!-- End wrapper div -->

        <!-- Column 2: Activity Calendar -->
        <div> <!-- Added wrapper div for consistency, though only one item -->
            <!-- 4. NEW ACTIVITY CALENDAR WIDGET -->
            <div class="card" id="activityCalendarCard"> <!-- Add ID to card -->
              <div class="drag-handle"></div>
              <div class="activity-calendar-header">
                <h3 class="widget-title">Activity</h3>

                <!-- NEW: View Toggle Switch -->
                <div class="calendar-view-toggle-container">
                  <label for="calendarViewToggle">Year</label>
                  <label class="switch">
                    <input type="checkbox" id="calendarViewToggle">
                    <span class="slider round"></span>
                  </label>
                  <label for="calendarViewToggle">Month</label>
                </div>
                <!-- End NEW View Toggle Switch -->

                <!-- Year Navigation (Initially Visible) -->
                <div class="calendar-title-year-nav">
                  <button id="prevYearBtn" class="calendar-nav-btn">&#9664;</button>
                  <span id="calendarYearDisplay"></span>
                  <button id="nextYearBtn" class="calendar-nav-btn">&#9654;</button>
                </div>

                <!-- NEW: Month Navigation (Initially Hidden) -->
                <div class="calendar-title-month-nav"> <!-- REMOVED inline style="display: none;" -->
                  <button id="prevMonthBtn" class="calendar-nav-btn">&#9664;</button>
                  <span id="calendarMonthYearDisplay"></span> <!-- Combined Month/Year Display -->
                  <button id="nextMonthBtn" class="calendar-nav-btn">&#9654;</button>
                </div>
                <!-- End NEW Month Navigation -->

                <div class="calendar-legend">
                  <span>Less</span>
                  <div class="activity-square heatmap-level-0"></div>
                  <div class="activity-square heatmap-level-1"></div>
                  <div class="activity-square heatmap-level-2"></div>
                  <div class="activity-square heatmap-level-3"></div>
                  <span>More</span>
                </div>
              </div>
              <div id="activityCalendarContainer" class="calendar-container">
                <div class="activity-squares-container">
                  <!-- Activity squares will be rendered here -->
                </div>
              </div>
            </div>
            <!-- End New Activity Calendar Widget -->
        </div> <!-- End wrapper div -->

      </div> <!-- End widget-row -->

    </div>
  </div>

  <!-- NEW: Tooltip for Activity Calendar -->
  <div id="calendarTooltip" style="position: absolute; display: none; background-color: #2a263a; color: #e0e0e0; border: 1px solid #4f4b68; padding: 8px; border-radius: 4px; z-index: 1000; pointer-events: none; font-size: 12px; max-width: 250px; line-height: 1.4;"></div>
  <!-- End NEW Tooltip -->

  <!-- Daily Notes Modal -->
  <dialog id="dailyNotesModal">
    <h3 id="dailyNotesTitle">Notes for </h3>
    <div id="dailyNotesContent" style="white-space: pre-wrap; margin-bottom: 8px;"></div>
    <button id="closeDailyNotesBtn">Close</button>
  </dialog>

  <!-- Weekly Review Box -->  <div id="weeklyReviewBox" style="display: none; position: fixed; top: 60px; right: 60px; background: #18142A; border-radius: 18px; box-shadow: 0 8px 32px 0 rgba(33,29,48,0.45); padding: 32px 28px 24px 28px; border: none; max-width: 420px; width: 90%; color: #E0E0E0; font-family: Poppins, Arial, sans-serif; z-index: 2000; transition: opacity 0.2s;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <div style="font-weight: 600; font-size: 1.18rem; letter-spacing: 0.01em;">Weekly Review</div>
      <button id="closeWeeklyReviewBoxBtn" style="background: none; border: none; cursor: pointer; font-size: 1.5rem; line-height: 1; color: #63FFDA; font-weight: bold; padding: 0 4px;">&times;</button>
    </div>
    <textarea id="weeklyReviewBoxContent" placeholder="Click to add your weekly review notes..." style="background: #211D30; color: #E0E0E0; border: 1px solid #4F4B68; border-radius: 12px; padding: 18px 16px; font-family: Poppins, Arial, sans-serif; font-size: 1rem; min-height: 120px; resize: vertical; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.12); margin: 0 0 12px 0; width: 100%; height: 180px; box-sizing: border-box; display: block; white-space: pre-wrap; overflow-y: auto;"></textarea>
    <div style="display: flex; justify-content: flex-end; gap: 12px;">
      <button id="saveWeeklyReviewBtn" style="background: linear-gradient(135deg, #8B5CF6, #A855F7); color: #FFFFFF; border: none; border-radius: 6px; padding: 8px 16px; font-weight: 600; font-size: 0.9em; cursor: pointer; transition: all 0.3s ease;">Save</button>
    </div>
  </div>

  <script>
    // TASK STORAGE
    let tasks = []; // Use let instead of const to allow reassignment on load
    let currentPriority = 'low';
    
    // Quick Add Task integration from popup/landing page
    function addTaskFromPopup(data) {
      tasks.push({
        id: Date.now(),
        text: data.text,
        priority: data.priority,
        created: new Date(),
        completed: false,
        completedAt: null,
        timeAllotted: data.timeAllotted,
        timeSpent: 0,
        difficulty: data.difficulty
      });
      saveTasks();
      renderTasks();
      updateMainCharts(mainChartRange);
      updateDifficultyChart(mainChartRange);
      updatePriorityDifficultyChart(mainChartRange);
      renderActivitySquares(calendarCurrentYear, calendarCurrentMonth);
      saveState();
    }
    // Listen for postMessage events
    window.addEventListener('message', e => {
      if (e.data && e.data.type === 'addTask') addTaskFromPopup(e.data);
    });
    // Listen for storage events (popup writes)
    window.addEventListener('storage', e => {
      if (e.key === 'productivityQuickAdd' && e.newValue) {
        addTaskFromPopup(JSON.parse(e.newValue));
      }
    });

    let calendarCurrentYear = new Date().getFullYear(); // Initialize calendar year
    let calendarCurrentMonth = new Date().getMonth(); // Initialize calendar month (0-11)
    let calendarViewMode = 'year'; // NEW: 'year' or 'month'

    // Chart Ranges
    let mainChartRange = 'year'; // For ALL charts except calendar
    // NEW: Tooltip Element Reference
    const calendarTooltip = document.getElementById('calendarTooltip');

    // --- DOM Elements ---
    const activityCalendarCard = document.getElementById('activityCalendarCard'); // NEW: Calendar Card
    const calendarViewToggle = document.getElementById('calendarViewToggle'); // NEW: Toggle Switch
    const calendarYearDisplay = document.getElementById('calendarYearDisplay');
    const prevYearBtn = document.getElementById('prevYearBtn');
    const nextYearBtn = document.getElementById('nextYearBtn');
    const calendarMonthYearDisplay = document.getElementById('calendarMonthYearDisplay'); // NEW: Month Display
    const prevMonthBtn = document.getElementById('prevMonthBtn'); // NEW: Month Nav
    const nextMonthBtn = document.getElementById('nextMonthBtn'); // NEW: Month Nav
    // Difficulty Chart Elements
    const ctxDifficulty = document.getElementById('difficultyCompletionChart').getContext('2d');
    const difficultyToggleButtons = document.querySelectorAll('.difficulty-toggle button');
    // Priority/Difficulty Chart Elements
    const ctxPriorityDifficulty = document.getElementById('priorityDifficultyChart').getContext('2d');
    const priorityDifficultyToggleButtons = document.querySelectorAll('.priority-difficulty-toggle button'); // Keep reference for updating active state
    // NEW: Daily Notes Modal Elements
    const dailyNotesModal = document.getElementById('dailyNotesModal');
    const dailyNotesTitle = document.getElementById('dailyNotesTitle');
    const dailyNotesContent = document.getElementById('dailyNotesContent');
    const closeDailyNotesBtn = document.getElementById('closeDailyNotesBtn');    // Weekly Review Box Elements
    const weeklyReviewBox = document.getElementById('weeklyReviewBox');
    const weeklyReviewBoxContent = document.getElementById('weeklyReviewBoxContent');
    const closeWeeklyReviewBoxBtn = document.getElementById('closeWeeklyReviewBoxBtn');
    const saveWeeklyReviewBtn = document.getElementById('saveWeeklyReviewBtn');

    // --- LOCAL STORAGE FUNCTIONS ---
    function saveTasks() {
        localStorage.setItem('productivityTasks', JSON.stringify(tasks));
    }

    function loadTasks() {
        const savedTasks = localStorage.getItem('productivityTasks');
        if (savedTasks) {
            tasks = JSON.parse(savedTasks).map(task => ({
                ...task,
                // Convert date strings back to Date objects
                created: new Date(task.created),
                completedAt: task.completedAt ? new Date(task.completedAt) : null
            }));
        }
        // --- NEW: Check for pending quick add ---
        const quickAdd = localStorage.getItem('productivityQuickAdd');
        if (quickAdd) {
            const data = JSON.parse(quickAdd);
            // Only add if not already present (by text and created today)
            const today = new Date();
            const exists = tasks.some(t => t.text === data.text && t.priority === data.priority && t.timeAllotted === data.timeAllotted && t.difficulty === data.difficulty && isSameDay(t.created, today));
            if (!exists && data.text) {
                addTaskFromPopup(data);
            }
            // --- FIX: Remove quick add from localStorage after importing ---
            localStorage.removeItem('productivityQuickAdd');
        }
    }

    // --- NEW: Helper to get month name ---
    function getMonthName(monthIndex) {
        const monthNames = ["January", "February", "March", "April", "May", "June",
                          "July", "August", "September", "October", "November", "December"];
        return monthNames[monthIndex];
    }

    // PRIORITY BUTTON HANDLING
    document.querySelectorAll('.priority-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        currentPriority = btn.dataset.priority;
      });
    });

    // CHART.JS SETUP (Overall Performance)
    const ctxOverall = document.getElementById('overallPerformanceChart').getContext('2d');
    // New gradient using Cyan
    const gradientCyan = ctxOverall.createLinearGradient(0, 0, 0, 300);
    gradientCyan.addColorStop(0, 'rgba(99, 255, 218, 0.4)'); // #63FFDA with 40% opacity
    gradientCyan.addColorStop(1, 'rgba(99, 255, 218, 0)'); // #63FFDA with 0% opacity

    const overallChart = new Chart(ctxOverall, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          {
            type: 'bar',
            label: 'Low Assigned',
            data: [],
            backgroundColor: '#73BFFF', // Ligh Blue (like SaaS)
            stack: 'assigned',
            borderRadius: 6,
            borderSkipped: 'bottom',
            barPercentage: 0.5
          },
          {
            type: 'bar',
            label: 'Med Assigned',
            data: [],
            backgroundColor: '#FFF000', // NeonYellow - CHANGED FROM #FFD700
            stack: 'assigned',
            borderRadius: 6,
            borderSkipped: 'bottom',
            barPercentage: 0.5
          },
          {
            type: 'bar',
            label: 'High Assigned',
            data: [],
            backgroundColor: '#FF6B6B', // Red like pie chart) - CHANGED FROM #FFD700
            stack: 'assigned',
            borderRadius: 6,
            borderSkipped: 'bottom',
            barPercentage: 0.5
          },
          {
            type: 'line',
            label: 'Tasks Assigned',
            data: [],
            borderColor: '#A0A0A0', // Secondary Text Grey
            borderDash: [6,6],
            fill: false,
            tension: 0.4,
            pointRadius: 0,
            yAxisID: 'y'
          },
          {
            type: 'line',
            label: 'Tasks Completed',
            data: [],
            borderColor: '#63FFDA', // Cyan
            backgroundColor: gradientCyan, // Use new Cyan gradient
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointBackgroundColor: '#63FFDA', // Cyan point
            pointBorderColor: '#1A1625', // Match card background
            pointHoverRadius: 6,
            yAxisID: 'y'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        elements: { bar: { borderRadius: 8, borderSkipped: false } },
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: { stacked: true, grid: { display: false }, ticks: { color: '#A0A0A0' } }, // Secondary Text Ticks
          y: {
            beginAtZero: true,
            stacked: false,
            grid: { display: true, color: 'rgba(79, 75, 104, 0.3)', drawBorder: false }, // Darker Grid Lines
            ticks: {
              color: '#A0A0A0', // Secondary Text Ticks
              stepSize: 1
            }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            mode: 'index', intersect: false,
            displayColors: false,
            backgroundColor: '#211D30', titleColor: '#FFF', bodyColor: '#FFF', padding: 8, // Darker Tooltip BG
            borderColor: '#63FFDA', borderWidth: 1, // Cyan Border
            callbacks: {
              title: items => {
                const label = items[0].label;
                const now = new Date();
                if (mainChartRange === 'year') return label + ' ' + now.getFullYear();
                if (mainChartRange === 'month') return now.toLocaleString('default', { month: 'long' }) + ' ' + label + ', ' + now.getFullYear();
                return label; // Default
              },
              label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}`
            }
          }
        }
      }
    });

    // CHART.JS SETUP (Hours Worked)
    const ctxHours = document.getElementById('hoursWorkedChart').getContext('2d');
    const hoursChart = new Chart(ctxHours, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Time Allotted',
                    data: [],
                    backgroundColor: '#4F4B68', // Neutral Dark Grey
                    borderRadius: 6,
                    borderSkipped: false
                },
                {
                    label: 'Time Spent',
                    data: [],
                    backgroundColor: '#A076F9', // Accent Purple
                    borderRadius: 6,
                    borderSkipped: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: '#A0A0A0' } // Secondary Text Ticks
                },
                y: {
                    beginAtZero: true,
                    grid: { display: true, color: 'rgba(79, 75, 104, 0.3)', drawBorder: false }, // Darker Grid Lines
                    ticks: { color: '#A0A0A0' } // Secondary Text Ticks
                },
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: { color: '#A0A0A0' } // Secondary Text Legend
                },
                tooltip: {
                    enabled: true,
                    mode: 'index',
                    intersect: false,
                    displayColors: false,
                    backgroundColor: '#211D30', titleColor: '#FFF', bodyColor: '#FFF', padding: 8, // Darker Tooltip BG
                    borderColor: '#A076F9', borderWidth: 1, // Purple Border
                    callbacks: {
                        title: items => {
                            const label = items[0].label;
                            const now = new Date();
                            if (mainChartRange === 'year') return label + ' ' + now.getFullYear();
                            if (mainChartRange === 'month') return now.toLocaleString('default', { month: 'long' }) + ' ' + label + ', ' + now.getFullYear();
                            return label; // Default
                        },
                        label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y} hrs`
                    }
                }
            }
        }
    });

    // CHART.JS SETUP (Difficulty Completion)
    const difficultyChart = new Chart(ctxDifficulty, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Easy Completed',
                    data: [],
                    borderColor: '#63FFDA', // Cyan for Easy
                    backgroundColor: 'rgba(99, 255, 218, 0.1)', // Cyan fill (low opacity)
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    pointBackgroundColor: '#63FFDA', // Cyan point
                    pointBorderColor: '#1A1625', // Match card background
                    pointHoverRadius: 4,
                },
                {
                    label: 'Hard Completed',
                    data: [],
                    borderColor: '#A076F9', // Purple for Hard
                    backgroundColor: 'rgba(160, 118, 249, 0.1)', // Purple fill (low opacity)
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    pointBackgroundColor: '#A076F9', // Purple point
                    pointBorderColor: '#1A1625', // Match card background
                    pointHoverRadius: 4,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: {
                    grid: {
                        display: false,
                        drawBorder: false
                    },
                    ticks: { display: false }
                },
                y: {
                    beginAtZero: true,
                    grid: { display: false, color: 'rgba(79, 75, 104, 0.3)', drawBorder: false }, // Darker Grid Lines (kept false)
                    ticks: {
                        display: false,
                        color: '#A0A0A0', // Secondary Text Ticks
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    enabled: true,
                    mode: 'index', intersect: false,
                    displayColors: false,
                    backgroundColor: '#211D30', titleColor: '#FFF', bodyColor: '#FFF', padding: 8, // Darker Tooltip BG
                    borderColor: '#63FFDA', borderWidth: 1, // Cyan Border (matches Easy)
                    callbacks: {
                        title: items => items[0].label, // Simpler title
                        label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}`
                    }
                }
            }
        }
    });

    // --- NEW: Center Text Plugin for Doughnut Chart ---
    const centerTextPlugin = {
      id: 'centerText',
      afterDraw: (chart) => {
        if (chart.config.type === 'doughnut' && chart.config.options.plugins.centerText?.display) {
          const ctx = chart.ctx;
          const { width, height } = chart.chartArea;
          const numberText = chart.config.options.plugins.centerText.text || '0'; // Get number from options
          const labelText = "tasks completed"; // Second line text

          ctx.save();
          const centerX = width / 2;
          const centerY = height / 2;
          const lineHeight = 10; // Adjust spacing between lines

          // Draw the number
          ctx.font = 'bold 24px Poppins'; // Make number slightly larger
          ctx.fillStyle = '#E0E0E0'; // Lighter text
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom'; // Align bottom of number text
          ctx.fillText(numberText, centerX, centerY + lineHeight / 2); // Position number slightly above center point

          // Draw the label below the number
          ctx.font = 'normal 12px Poppins'; // Smaller font for label
          ctx.fillStyle = '#A0A0A0'; // Secondary Text
          ctx.textBaseline = 'top'; // Align top of label text
          ctx.fillText(labelText, centerX, centerY + lineHeight / 2 + 2); // Position label slightly below center point + spacing

          ctx.restore();
        }
      }
    };
    // Register the plugin globally (or locally in the chart options)
    // Chart.register(centerTextPlugin); // Global registration - alternatively, add to chart options

    // CHART.JS SETUP (Priority vs Difficulty Doughnut)
    const priorityDifficultyChart = new Chart(ctxPriorityDifficulty, {
        type: 'doughnut',
        data: {
            // Update labels to be more specific for tooltips
            labels: ['Priority: High', 'Priority: Med', 'Priority: Low', 'Difficulty: Easy', 'Difficulty: Hard'],
            datasets: [
                {
                    label: 'Priority', // Outer ring
                    data: [0, 0, 0], // Start with 0, will be updated
                    backgroundColor: [
                        '#FF6B6B', // High (Red)
                        '#FFF000', // Med (Neon Yellow) - CHANGED FROM #FFD700
                        '#63FFDA'  // Low (Cyan)
                    ],
                    borderWidth: 2,
                    borderColor: '#1A1625', // Match card background for separation
                },
                {
                    label: 'Difficulty', // Inner ring
                    data: [0, 0], // Start with 0, will be updated
                    backgroundColor: [
                        '#63FFDA', // Easy (Cyan)
                        '#FF6B6B'  // Hard (Red) - CHANGED FROM PURPLE
                    ],
                    borderWidth: 2,
                    borderColor: '#1A1625',
                    weight: 0.7 // Makes the inner ring slightly smaller relative to outer
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%', // Increased cutout percentage to make rings thinner
            plugins: {
                centerText: {
                  display: true,
                  text: '0' // Initial text value (number)
                },
                legend: {
                    display: false // Hide default legend
                },
                tooltip: {
                    enabled: true, // Enable tooltips
                    backgroundColor: '#211D30', // Darker Tooltip BG
                    titleColor: '#FFF',
                    bodyColor: '#FFF',
                    borderColor: '#A0A0A0', // Secondary Text Border
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            // Use the specific label defined in data.labels
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                // Show the actual count
                                label += context.parsed;
                            }
                            return label;
                        }
                    }
                }
            },
        },
        plugins: [centerTextPlugin]
    });

    // AGGREGATION LOGIC
    function aggregate(range) {
      const now = new Date(); // This is effectively the 'current date' for the dashboard
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth(); // 0-11
      const currentDayOfMonth = now.getDate(); // 1-31
      const currentDayOfWeek = (now.getDay() + 6) % 7; // 0=Mon, 6=Sun

      let labels, low, med, high, completed, allottedHours, spentHours, easyCompleted, hardCompleted;
      let completedLowArr, completedMedArr, completedHighArr;
      let previousTotalSpent = 0;

      if (range === 'year') {
        labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        // Only include months up to the current month
        labels = labels.slice(0, currentMonth + 1);

        low = Array(currentMonth + 1).fill(0); med = Array(currentMonth + 1).fill(0); high = Array(currentMonth + 1).fill(0); completed = Array(currentMonth + 1).fill(0);
        allottedHours = Array(currentMonth + 1).fill(0); spentHours = Array(currentMonth + 1).fill(0);
        easyCompleted = Array(currentMonth + 1).fill(0); hardCompleted = Array(currentMonth + 1).fill(0);
        completedLowArr = Array(currentMonth + 1).fill(0); completedMedArr = Array(currentMonth + 1).fill(0); completedHighArr = Array(currentMonth + 1).fill(0);

        tasks.forEach(t => {
          const taskDate = t.created;
          const taskCompletedDate = t.completedAt;

          if (taskDate.getFullYear() === currentYear) {
            const m = taskDate.getMonth();
            if (m <= currentMonth) { // Process only up to the current month
              if (m < currentMonth || (m === currentMonth && taskDate.getDate() <= currentDayOfMonth)) {
                if (t.priority==='low') low[m]++; if (t.priority==='med') med[m]++; if (t.priority==='high') high[m]++;
                allottedHours[m] += (t.timeAllotted || 0);
                spentHours[m] += (t.timeSpent || 0);
              }
            }
          }
          if (taskCompletedDate && taskCompletedDate.getFullYear() === currentYear) {
            const m = taskCompletedDate.getMonth();
            if (m <= currentMonth) { // Process only up to the current month
              if (m < currentMonth || (m === currentMonth && taskCompletedDate.getDate() <= currentDayOfMonth)) {
                completed[m]++;
                if (t.difficulty === 'easy') easyCompleted[m]++;
                else if (t.difficulty === 'hard') hardCompleted[m]++;
                if (t.priority === 'low') completedLowArr[m]++;
                if (t.priority === 'med') completedMedArr[m]++;
                if (t.priority === 'high') completedHighArr[m]++;
              }
            }
          }
          // Previous year data for delta calculation (remains unchanged)
          if (t.created.getFullYear() === currentYear - 1) {
            previousTotalSpent += (t.timeSpent || 0);
          }
        });
      } else if (range === 'month') {
        // Labels will be days of the current month, up to currentDayOfMonth
        labels = Array.from({ length: currentDayOfMonth }, (_, i) => (i + 1).toString());
        low = Array(currentDayOfMonth).fill(0); med = Array(currentDayOfMonth).fill(0); high = Array(currentDayOfMonth).fill(0); completed = Array(currentDayOfMonth).fill(0);
        allottedHours = Array(currentDayOfMonth).fill(0); spentHours = Array(currentDayOfMonth).fill(0);
        easyCompleted = Array(currentDayOfMonth).fill(0); hardCompleted = Array(currentDayOfMonth).fill(0);
        completedLowArr = Array(currentDayOfMonth).fill(0); completedMedArr = Array(currentDayOfMonth).fill(0); completedHighArr = Array(currentDayOfMonth).fill(0);

        const prevMonthDate = new Date(currentYear, currentMonth, 1);
        prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
        const prevMonth = prevMonthDate.getMonth();
        const prevMonthYear = prevMonthDate.getFullYear();

        tasks.forEach(t => {
          const taskDate = t.created;
          const taskCompletedDate = t.completedAt;

          if (taskDate.getFullYear() === currentYear && taskDate.getMonth() === currentMonth) {
            const dayIndex = taskDate.getDate() - 1;
            if (dayIndex < currentDayOfMonth) { // Process only up to current day
              if (t.priority === 'low') low[dayIndex]++; if (t.priority === 'med') med[dayIndex]++; if (t.priority === 'high') high[dayIndex]++;
              allottedHours[dayIndex] += (t.timeAllotted || 0); spentHours[dayIndex] += (t.timeSpent || 0);
            }
          }
          if (taskCompletedDate && taskCompletedDate.getFullYear() === currentYear && taskCompletedDate.getMonth() === currentMonth) {
            const dayIndex = taskCompletedDate.getDate() - 1;
            if (dayIndex < currentDayOfMonth) { // Process only up to current day
              completed[dayIndex]++;
              if (t.difficulty === 'easy') easyCompleted[dayIndex]++;
              else if (t.difficulty === 'hard') hardCompleted[dayIndex]++;
              if (t.priority === 'low') completedLowArr[dayIndex]++;
              if (t.priority === 'med') completedMedArr[dayIndex]++;
              if (t.priority === 'high') completedHighArr[dayIndex]++;
            }
          }
          if (t.created.getFullYear() === prevMonthYear && t.created.getMonth() === prevMonth) {
            previousTotalSpent += (t.timeSpent || 0);
          }
        });
      } else if (range === 'week') {
        labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        // Only include days of the week up to the current day of the week
        labels = labels.slice(0, currentDayOfWeek + 1);

        low = Array(currentDayOfWeek + 1).fill(0); med = Array(currentDayOfWeek + 1).fill(0); high = Array(currentDayOfWeek + 1).fill(0); completed = Array(currentDayOfWeek + 1).fill(0);
        allottedHours = Array(currentDayOfWeek + 1).fill(0); spentHours = Array(currentDayOfWeek + 1).fill(0);
        easyCompleted = Array(currentDayOfWeek + 1).fill(0); hardCompleted = Array(currentDayOfWeek + 1).fill(0);
        completedLowArr = Array(currentDayOfWeek + 1).fill(0); completedMedArr = Array(currentDayOfWeek + 1).fill(0); completedHighArr = Array(currentDayOfWeek + 1).fill(0);

        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - currentDayOfWeek); // Set to Monday of the current week
        startOfWeek.setHours(0,0,0,0);

        const endOfWeek = new Date(now); // Current day is the end of the week for chart purposes
        endOfWeek.setHours(23,59,59,999);


        const prevWeekStart = new Date(startOfWeek); prevWeekStart.setDate(startOfWeek.getDate() - 7);
        const prevWeekEnd = new Date(endOfWeek); prevWeekEnd.setDate(endOfWeek.getDate() - 7);


        tasks.forEach(t => {
          const taskDate = t.created;
          const taskCompletedDate = t.completedAt;
          const dayIndexInWeek = (taskDate.getDay() + 6) % 7;
          const completedDayIndexInWeek = taskCompletedDate ? (taskCompletedDate.getDay() + 6) % 7 : -1;

          if (taskDate >= startOfWeek && taskDate <= endOfWeek) {
            if (dayIndexInWeek <= currentDayOfWeek) {
              if(t.priority==='low') low[dayIndexInWeek]++; if(t.priority==='med') med[dayIndexInWeek]++; if(t.priority==='high') high[dayIndexInWeek]++;
              allottedHours[dayIndexInWeek] += (t.timeAllotted || 0); spentHours[dayIndexInWeek] += (t.timeSpent || 0);
            }
          }
          if(taskCompletedDate && taskCompletedDate >= startOfWeek && taskCompletedDate <= endOfWeek) {
            if (completedDayIndexInWeek <= currentDayOfWeek) {
              completed[completedDayIndexInWeek]++;
              if (t.difficulty === 'easy') easyCompleted[completedDayIndexInWeek]++;
              else if (t.difficulty === 'hard') hardCompleted[completedDayIndexInWeek]++;
              if (t.priority === 'low') completedLowArr[completedDayIndexInWeek]++;
              if (t.priority === 'med') completedMedArr[completedDayIndexInWeek]++;
              if (t.priority === 'high') completedHighArr[completedDayIndexInWeek]++;
            }
          }
          if (t.created >= prevWeekStart && t.created <= prevWeekEnd) {
            previousTotalSpent += (t.timeSpent || 0);
          }
        });
      } else { // day (today)
        labels = Array.from({length: now.getHours() + 1},(_,i)=>`${i}:00`); // Hours up to current hour
        const currentHour = now.getHours();
        low = Array(currentHour + 1).fill(0); med = Array(currentHour + 1).fill(0); high = Array(currentHour + 1).fill(0); completed = Array(currentHour + 1).fill(0);
        allottedHours = Array(currentHour + 1).fill(0); spentHours = Array(currentHour + 1).fill(0);
        easyCompleted = Array(currentHour + 1).fill(0); hardCompleted = Array(currentHour + 1).fill(0);
        completedLowArr = Array(currentHour + 1).fill(0); completedMedArr = Array(currentHour + 1).fill(0); completedHighArr = Array(currentHour + 1).fill(0);

        const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1);

        tasks.forEach(t => {
          const taskDate = t.created;
          const taskCompletedDate = t.completedAt;

          if (isSameDay(taskDate, now)) {
            const h = taskDate.getHours();
            if (h <= currentHour) { // Process only up to current hour
              low[h]+=(t.priority==='low'); med[h]+=(t.priority==='med'); high[h]+=(t.priority==='high');
              allottedHours[h] += (t.timeAllotted || 0);
            }
          }
          if (taskCompletedDate && isSameDay(taskCompletedDate, now)) {
            const h = taskCompletedDate.getHours();
            if (h <= currentHour) { // Process only up to current hour
              completed[h]++;
              spentHours[h] += (t.timeSpent || 0); // ADD spentHours aggregation based on completion hour
              if (t.difficulty === 'easy') easyCompleted[h]++;
              else if (t.difficulty === 'hard') hardCompleted[h]++;
              if (t.priority === 'low') completedLowArr[h]++;
              if (t.priority === 'med') completedMedArr[h]++;
              if (t.priority === 'high') completedHighArr[h]++;
            }
          }
          if (isSameDay(t.created, yesterday)) { // Previous day for delta
             previousTotalSpent += (t.timeSpent || 0);
          }
        });
      }

      const assignedSum = low.map((l,i) => l + med[i] + high[i]);
      const totalSpentInRange = spentHours.reduce((a,b) => a+b, 0);
      let percentageChange = 0;
      if (previousTotalSpent > 0) {
        percentageChange = ((totalSpentInRange - previousTotalSpent) / previousTotalSpent) * 100;
      } else if (totalSpentInRange > 0) { // If previous was 0 and current is > 0, it's a 100% increase effectively
        percentageChange = 100;
      } // else percentageChange remains 0

      // --- Calculate total completed counts by priority for the range ---
      const totalCompletedLow = completedLowArr.reduce((sum, count) => sum + count, 0);
      const totalCompletedMed = completedMedArr.reduce((sum, count) => sum + count, 0);
      const totalCompletedHigh = completedHighArr.reduce((sum, count) => sum + count, 0);
      const totalCompletedPriority = totalCompletedLow + totalCompletedMed + totalCompletedHigh; // Sum for center text

      // --- Calculate total completed counts by difficulty for the range ---
      const totalCompletedEasy = easyCompleted.reduce((sum, count) => sum + count, 0);
      const totalCompletedHard = hardCompleted.reduce((sum, count) => sum + count, 0);


      // Return all aggregated data, including the *new* priority and difficulty completion totals
      return {
          // Original data for other charts
          labels, low, med, high, assignedSum, completed, allottedHours, spentHours,
          easyCompleted, hardCompleted, totalSpentInRange, percentageChange, previousTotalSpent,
          // New data for priority/difficulty chart
          totalCompletedLow, totalCompletedMed, totalCompletedHigh,
          totalCompletedEasy, totalCompletedHard,
          totalCompleted: totalCompletedPriority // Add the overall total completed count
      };
    }
    function isSameDay(a,b){ return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate(); }

    // CHART UPDATE FUNCTION (Main Charts: Overall Performance & Hours Worked)
    function updateMainCharts(range){
        const {labels, low, med, high, assignedSum, completed, allottedHours, spentHours, totalSpentInRange, percentageChange, previousTotalSpent} = aggregate(range);

        // --- Overall Performance Chart Update ---
        overallChart.data.labels=labels;
        overallChart.data.datasets[0].data=low;
        overallChart.data.datasets[1].data=med;
        overallChart.data.datasets[2].data=high;
        overallChart.data.datasets[3].data=assignedSum;
        overallChart.data.datasets[4].data=completed;
        // Update tooltip title callback based on mainChartRange
        overallChart.options.plugins.tooltip.callbacks.title = items => {
            const label = items[0].label;
            const now = new Date();
            if (mainChartRange === 'year') return label + ' ' + now.getFullYear();
            if (mainChartRange === 'month') return now.toLocaleString('default', { month: 'long' }) + ' ' + label + ', ' + now.getFullYear();
            return label; // Default
        };
        overallChart.update();

        // --- Hours Worked Chart Update ---
        hoursChart.data.labels = labels;
        hoursChart.data.datasets[0].data = allottedHours;
        hoursChart.data.datasets[1].data = spentHours;
        hoursChart.options.scales.x.ticks.autoSkip = range !== 'month';
        // Update tooltip title callback based on mainChartRange
        hoursChart.options.plugins.tooltip.callbacks.title = items => {
            const label = items[0].label;
            const now = new Date();
            if (mainChartRange === 'year') return label + ' ' + now.getFullYear();
            if (mainChartRange === 'month') return now.toLocaleString('default', { month: 'long' }) + ' ' + label + ', ' + now.getFullYear();
            return label; // Default
        };
        hoursChart.update();

        // --- Update Total Hours Display & Delta ---
        const totalHoursEl = document.getElementById('totalHoursDisplay').querySelector('span:first-child');
        const deltaIndicatorEl = document.getElementById('totalHoursDisplay').querySelector('.delta-indicator');

        let rangeText = '';
        if (range === 'year') rangeText = 'This Year';
        else if (range === 'month') rangeText = 'This Month';
        else if (range === 'week') rangeText = 'This Week';
        else if (range === 'day') rangeText = 'Today';
        totalHoursEl.textContent = `Total Spent (${rangeText}): ${totalSpentInRange} hrs`;

        // Update Delta Indicator
        deltaIndicatorEl.classList.remove('increase', 'decrease'); // Clear previous classes
        deltaIndicatorEl.innerHTML = ''; // Clear previous content

        if (previousTotalSpent === 0 && totalSpentInRange === 0) {
            deltaIndicatorEl.innerHTML = '--'; // No change from zero or no data
        } else if (percentageChange === Infinity) {
            deltaIndicatorEl.innerHTML = 'â†— âˆž%'; // Increase from zero - angled arrow, no parens
            deltaIndicatorEl.classList.add('increase');
        } else if (percentageChange > 0) {
            deltaIndicatorEl.innerHTML = `â†— ${percentageChange.toFixed(1)}%`; // Angled up arrow, no parens
            deltaIndicatorEl.classList.add('increase');
        } else if (percentageChange < 0) {
            deltaIndicatorEl.innerHTML = `â†˜ ${Math.abs(percentageChange).toFixed(1)}%`; // Angled down arrow, no parens
            deltaIndicatorEl.classList.add('decrease');
        } else { // percentageChange === 0
             deltaIndicatorEl.innerHTML = 'â†’ 0.0%'; // Right arrow for no change, no parens

        }
    }

    // CHART UPDATE FUNCTION (Difficulty Completion Chart)
    function updateDifficultyChart(range) {
        const { labels, easyCompleted, hardCompleted } = aggregate(range);

        difficultyChart.data.labels = labels;
        difficultyChart.data.datasets[0].data = easyCompleted;
        difficultyChart.data.datasets[1].data = hardCompleted;
        // Update tooltip title callback based on the passed range
        difficultyChart.options.plugins.tooltip.callbacks.title = items => {
            const label = items[0].label;
            const now = new Date();
            if (range === 'year') return label + ' ' + now.getFullYear(); // Use passed range
            if (range === 'month') return now.toLocaleString('default', { month: 'long' }) + ' ' + label + ', ' + now.getFullYear(); // Use passed range
            return label; // Default
        };
        difficultyChart.options.scales.x.ticks.autoSkip = range !== 'month'; // Match behavior
        difficultyChart.update();
    }

    // CHART UPDATE FUNCTION (Priority vs Difficulty Chart) - Updated
    function updatePriorityDifficultyChart(range) { // Accepts range, which will be mainChartRange
        // Aggregate data, getting all necessary properties
        const aggregatedData = aggregate(range); // Use the passed range
        const { totalCompletedLow, totalCompletedMed, totalCompletedHigh, totalCompletedEasy, totalCompletedHard, totalCompleted } = aggregatedData; // Get totalCompleted

        // --- Prepare data for the outer ring (Priority) ---
        let priorityData = [totalCompletedHigh, totalCompletedMed, totalCompletedLow];
        const totalCompletedPriority = totalCompletedHigh + totalCompletedMed + totalCompletedLow;
        if (totalCompletedPriority === 0) {
            priorityData = [0, 0, 0];
        }
        priorityDifficultyChart.data.datasets[0].data = priorityData;

        // --- Prepare data for the inner ring (Difficulty) ---
        let difficultyData = [totalCompletedEasy, totalCompletedHard];
        const totalCompletedDifficulty = totalCompletedEasy + totalCompletedHard;
        if (totalCompletedDifficulty === 0) {
            difficultyData = [0, 0];
        }
        priorityDifficultyChart.data.datasets[1].data = difficultyData;

        // --- Update center text ---
        priorityDifficultyChart.config.options.plugins.centerText.text = totalCompleted.toString(); // Update text in options

        priorityDifficultyChart.update(); // Update the chart
    }

    // TIMEFRAME BUTTONS (Main Listener - NOW INCLUDES ALL CHARTS)
    document.querySelectorAll('.timeframe-toggle button').forEach(btn => { // Select ALL toggle buttons
      btn.addEventListener('click', () => {
        const range = btn.dataset.range;
        mainChartRange = range; // Update main range

        // Update active state in ALL toggle groups
        document.querySelectorAll('.timeframe-toggle button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll(`.timeframe-toggle button[data-range="${range}"]`).forEach(b => b.classList.add('active'));

        updateMainCharts(mainChartRange); // Update main charts (Overall, Hours)
        updateDifficultyChart(mainChartRange); // Update difficulty chart
        updatePriorityDifficultyChart(mainChartRange); // Update priority/difficulty chart
        saveState(); // Save state after chart updates
      });
    });

    // TASK UI & LOGIC
    const taskListEl = document.getElementById('taskList');
    const newTaskIn  = document.getElementById('newTask');
    const addBtn     = document.getElementById('addBtn');
    const newTimeAllotted = document.getElementById('newTimeAllotted');
    const newDifficultyIn = document.getElementById('newDifficulty');
    const difficultyLabel = document.getElementById('difficultyLabel');

    // --- Difficulty toggle setup ---
    newDifficultyIn.addEventListener('change', () => {
      difficultyLabel.textContent = newDifficultyIn.checked ? 'Hard' : 'Easy';
    });

    function renderTasks(){
      taskListEl.innerHTML = '';
      const today = new Date(); // Get today's date once for efficiency
      
      // Filter tasks to only include those created today for display
      const tasksToday = tasks.filter(t => isSameDay(t.created, today));

      tasksToday.forEach(t => { // Iterate over tasksToday instead of all tasks
        const li = document.createElement('li');
        li.dataset.taskId = t.id; // Add data attribute for easier selection

        const chk = document.createElement('input'); chk.type='checkbox'; chk.checked=t.completed;
        chk.addEventListener('change',()=>{
            t.completed=!t.completed;
            t.completedAt=t.completed?new Date():null;
            saveTasks(); // Save tasks when completion status changes
            updateMainCharts(mainChartRange); // Update main charts
            updateDifficultyChart(mainChartRange); // Use mainChartRange
            updatePriorityDifficultyChart(mainChartRange); // Use mainChartRange
            // Only update the calendar data, do not change the view mode
            if (calendarViewMode === 'month') {
                renderActivitySquares(calendarCurrentYear, calendarCurrentMonth); // Month view
            } else {
                renderActivitySquares(calendarCurrentYear); // Year view
            }
            saveState(); // Save state after task completion change
        });

        const priorityIndicator = document.createElement('span');
        priorityIndicator.classList.add('priority-btn', t.priority, 'selected'); priorityIndicator.title = t.priority.charAt(0).toUpperCase()+t.priority.slice(1);

        const lbl = document.createElement('label'); lbl.textContent = t.text;

        const tooltip = document.createElement('span');
        tooltip.classList.add('tooltip');
        tooltip.textContent = `Time Allotted: ${t.timeAllotted || 0}h, Time Spent: ${t.timeSpent || 0}h`; // Ensure 0 if undefined

        // --- Edit Functionality Elements ---
        const editBtn = document.createElement('button');
        editBtn.innerHTML = `
          <svg viewBox="0 0 24 24" class="pencil-icon">
            <path d="M3 17.25 V21 h3.75 L17.81 9.94 l-3.75 -3.75 L3 17.25 z M20.71 7.04 a1.003 1.003 0 0 0 0 -1.41 l -2.34 -2.34 a1.003 1.003 0 0 0 -1.41 0 l -1.83 1.83 l 3.75 3.75 l 1.83 -1.83 z"/>
          </svg>`;
        editBtn.title = 'Edit';
        editBtn.classList.add('edit-btn');

        const editContainer = document.createElement('span');
        editContainer.classList.add('edit-container');

        const timeSpentInput = document.createElement('input');
        timeSpentInput.type = 'number';
        timeSpentInput.min = '0';
        timeSpentInput.placeholder = 'hrs spent';
        timeSpentInput.value = t.timeSpent || 0;

        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'Save';
        saveBtn.classList.add('save-btn');

        editContainer.append(timeSpentInput, saveBtn);
        // --- End Edit Functionality Elements ---

        li.append(chk, priorityIndicator, lbl, tooltip, editBtn, editContainer); // Add edit button and container

        // --- Edit Button Logic ---
        editBtn.addEventListener('click', () => {
            li.classList.add('editing'); // Add class to show/hide elements via CSS
            timeSpentInput.value = t.timeSpent || 0; // Ensure input has current value
            timeSpentInput.focus(); // Focus the input field
        });

        // --- Save Button Logic ---
        saveBtn.addEventListener('click', () => {
            const newSpentTime = parseInt(timeSpentInput.value) || 0;
            t.timeSpent = newSpentTime; // Update task object
            tooltip.textContent = `Time Allotted: ${t.timeAllotted || 0}h, Time Spent: ${t.timeSpent || 0}h`; // Update tooltip
            li.classList.remove('editing'); // Remove editing class
            saveTasks(); // Save to localStorage
            updateMainCharts(mainChartRange); // Update main charts
            updateDifficultyChart(mainChartRange); // Use mainChartRange
            updatePriorityDifficultyChart(mainChartRange); // Use mainChartRange
            saveState(); // Save state after task edit
        });
        // Allow saving with Enter key in the input
        timeSpentInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                saveBtn.click(); // Trigger save button click
            } else if (e.key === 'Escape') {
                 li.classList.remove('editing'); // Cancel editing on Escape
            }
        });


        // Add delete button (logic remains the same as it already checks for today)
        if (isSameDay(t.created, today)) {
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `
              <svg viewBox="0 0 24 24" class="trash-icon">
                <path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-4.5l-1-1z"/>
              </svg>`;
            deleteBtn.title = 'Delete';
            deleteBtn.classList.add('delete-btn');
            deleteBtn.addEventListener('click', () => {
                const taskIndex = tasks.findIndex(task => task.id === t.id);
                if (taskIndex > -1) {
                    tasks.splice(taskIndex, 1); // Remove task from array
                    saveTasks(); // Save updated array
                    renderTasks(); // Re-render the task list UI
                    updateMainCharts(mainChartRange); // Update main charts
                    updateDifficultyChart(mainChartRange); // Use mainChartRange
                    updatePriorityDifficultyChart(mainChartRange); // Use mainChartRange
                    renderActivitySquares(calendarCurrentYear); // Update calendar too
                    saveState(); // Save state after task deletion
                }
            });
            li.appendChild(deleteBtn); // Append delete button to the list item
        }        taskListEl.appendChild(li);
      });
      
      // Setup animated gradient effects for newly created edit/delete buttons
      setupAnimatedButtons();
    }
      function addTask() {
        const txt = newTaskIn.value.trim();
        if (!txt) {
          return;
        }
      
        const allotted = parseInt(newTimeAllotted.value) || 0;
        // capture difficulty
      const difficulty = newDifficultyIn.checked ? 'hard' : 'easy';
      const spent = 0; // Default timeSpent to 0
      tasks.push({ id: Date.now(), text: txt, priority: currentPriority, created: new Date(), completed: false, completedAt: null, timeAllotted: allotted, timeSpent: spent, difficulty });
      newTaskIn.value=''; newTimeAllotted.value='';
      // reset toggle
      newDifficultyIn.checked = false;
      difficultyLabel.textContent = 'Easy';
      // Close the details dropdown after adding
      const detailsElement = newTaskIn.closest('.card').querySelector('.task-dropdown');
      if (detailsElement) {
          detailsElement.removeAttribute('open');
      }
      saveTasks(); // Save tasks after adding a new one
      updateMainCharts(mainChartRange); // Update main charts
      updateDifficultyChart(mainChartRange); // Use mainChartRange
      updatePriorityDifficultyChart(mainChartRange); // Use mainChartRange
      renderTasks();
      saveState(); // Save state after adding a task
    }
    addBtn.addEventListener('click', addTask);
    newTaskIn.addEventListener('keydown',e=>{ if(e.key==='Enter') addTask(); });

    // --- NEW: Activity Squares Logic (MODIFIED) ---
    function renderActivitySquares(year, month) { // Added month parameter
      const container = document
        .getElementById('activityCalendarContainer')
        .querySelector('.activity-squares-container');
      if (!container) return;
      container.innerHTML = ''; // Clear previous squares

      let startDate, daysCount;
      let firstDayOfMonth = 0; // For month view padding

      if (month !== undefined && month !== null) { // MONTH VIEW
          startDate = new Date(year, month, 1);
          const nextMonth = new Date(year, month + 1, 1);
          daysCount = Math.round((nextMonth - startDate) / (1000 * 60 * 60 * 24));
          firstDayOfMonth = (startDate.getDay() + 6) % 7; // 0=Mon, 6=Sun

          // Add padding squares for the start of the month
          for (let i = 0; i < firstDayOfMonth; i++) {
              const padSq = document.createElement('div');
              padSq.classList.add('activity-square', 'padding-square'); // Add padding class
              container.appendChild(padSq);
          }

      } else { // YEAR VIEW (Original Logic)
          startDate = new Date(year, 0, 1);
          const nextYearDate = new Date(year + 1, 0, 1);
          daysCount = Math.round((nextYearDate - startDate) / (1000 * 60 * 60 * 24));
      }


      for (let i = 0; i < daysCount; i++) {
        const d = new Date(startDate);
        d.setDate(startDate.getDate() + i);

        const completedCount = tasks.filter(
          t => t.completedAt && isSameDay(t.completedAt, d)
        ).length;

        let level = 0;
        if (completedCount >= 5) level = 3;
        else if (completedCount >= 3) level = 2;
        else if (completedCount >= 1) level = 1;

        const sq = document.createElement('div');
        sq.classList.add('activity-square', `heatmap-level-${level}`);
        sq.dataset.date = d.toISOString().split('T')[0]; // Store date for tooltip        // Highlight Fridays in month view AND add click listener
        if (month !== undefined && month !== null && d.getDay() === 5) {
          sq.style.outline = '2px solid #FF6B6B'; // Red outline for Friday
          sq.style.outlineOffset = '-2px';
          sq.addEventListener('click', (e) => {
            e.stopPropagation();
            showWeeklyReviewBox(d); // Pass the specific Friday date
          });
        }

        // --- Tooltip Event Listeners (Modified to use dataset.date) ---
        sq.addEventListener('mouseover', (event) => {
            const squareDate = new Date(event.target.dataset.date + 'T00:00:00'); // Ensure correct date object
            const tasksForDay = tasks.filter(t => isSameDay(t.created, squareDate)); // Use created date for listing tasks
            let tooltipContent = `<strong>${squareDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</strong><br>`;

            if (tasksForDay.length > 0) {
                tooltipContent += '<ul>';
                tasksForDay.forEach(task => {
                    tooltipContent += `<li style="margin-left: 15px; padding-left: 5px; list-style-type: disc; color: ${task.completed ? '#63FFDA' : '#A0A0A0'};">${task.text} ${task.completed ? '(âœ“)' : ''}</li>`;
                });
                tooltipContent += '</ul>';
            } else {
                tooltipContent += 'No tasks created this day.';
            }

            calendarTooltip.innerHTML = tooltipContent;

            // Positioning logic (remains the same)
            let left = event.pageX + 15;
            let top = event.pageY + 15;
            const tooltipRect = calendarTooltip.getBoundingClientRect();
            const bodyRect = document.body.getBoundingClientRect();

            if (left + tooltipRect.width > bodyRect.right) {
                left = event.pageX - tooltipRect.width - 15;
            }
            if (top + tooltipRect.height > bodyRect.bottom) {
                top = event.pageY - tooltipRect.height - 15;
            }

            calendarTooltip.style.left = `${left}px`;
            calendarTooltip.style.top = `${top}px`;
            calendarTooltip.style.display = 'block';
        });

        sq.addEventListener('mouseout', () => {
            calendarTooltip.style.display = 'none';
        });
        // --- END: Tooltip Event Listeners ---

        container.appendChild(sq);
      }
    }
    // --- END: Activity Squares Logic ---

    // --- Calendar Navigation Logic (MODIFIED) ---
    function updateCalendarDisplay() {
        activityCalendarCard.classList.remove('calendar-view-year', 'calendar-view-month'); // Clear old classes
        activityCalendarCard.classList.add(`calendar-view-${calendarViewMode}`); // Add current view class

        if (calendarViewMode === 'year') {
            calendarYearDisplay.textContent = calendarCurrentYear;
            renderActivitySquares(calendarCurrentYear); // Render year view
        } else { // month view
            calendarMonthYearDisplay.textContent = `${getMonthName(calendarCurrentMonth)} ${calendarCurrentYear}`;
            renderActivitySquares(calendarCurrentYear, calendarCurrentMonth); // Render month view
        }
        // Update toggle state visually (in case it was changed programmatically)
        calendarViewToggle.checked = (calendarViewMode === 'month');
        saveState(); // Save state after calendar view change
    }

    // Year Navigation
    prevYearBtn.addEventListener('click', () => {
        calendarCurrentYear--;
        updateCalendarDisplay();
    });
    nextYearBtn.addEventListener('click', () => {
        calendarCurrentYear++;
        updateCalendarDisplay();
    });

    // NEW: Month Navigation
    prevMonthBtn.addEventListener('click', () => {
        calendarCurrentMonth--;
        if (calendarCurrentMonth < 0) {
            calendarCurrentMonth = 11;
            calendarCurrentYear--;
        }
        updateCalendarDisplay();
    });
    nextMonthBtn.addEventListener('click', () => {
        calendarCurrentMonth++;
        if (calendarCurrentMonth > 11) {
            calendarCurrentMonth = 0;
            calendarCurrentYear++;
        }
        updateCalendarDisplay();
    });

    // NEW: Toggle Switch Listener
    calendarViewToggle.addEventListener('change', (event) => {
        calendarViewMode = event.target.checked ? 'month' : 'year';
        updateCalendarDisplay(); // Update view when toggle changes
    });
    // --- End Calendar Navigation Logic ---

    // --- NEW: Daily Notes Modal Logic ---
    function showDailyNotesModal(date) {
        const dateStr = date.toISOString().split('T')[0];
        const key = `dailyNotes_${dateStr}`;
        const notes = localStorage.getItem(key) || '';
        dailyNotesTitle.textContent = `Notes for ${date.toLocaleDateString(undefined, { month:'short', day:'numeric', year:'numeric' })}`;
        dailyNotesContent.textContent = notes || 'No notes for this day.';
        if (!dailyNotesModal.open) {
            dailyNotesModal.showModal();
        }
    }
    // Close daily notes modal
    closeDailyNotesBtn.addEventListener('click', () => {
        if (dailyNotesModal.open) {
            dailyNotesModal.close();
        }
    });    // --- NEW: Weekly Review Box Logic ---
    function showWeeklyReviewBox(dateForWeek = null) {
        const targetDate = dateForWeek || new Date();
        const weekNum = getWeekNumber(targetDate);
        const year = targetDate.getFullYear();
        const weekKey = `weeklyReview_${year}_${weekNum}`;
        const review = localStorage.getItem(weekKey) || '';
        
        // Update the header to show which week we're reviewing
        const weekTitle = weeklyReviewBox.querySelector('div > div');
        const weekStart = getStartOfWeek(targetDate);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        weekTitle.textContent = `Weekly Review - Week ${weekNum}, ${year} (${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()})`;
        
        weeklyReviewBoxContent.value = review;
        weeklyReviewBox.style.display = 'block';
        weeklyReviewBox.style.opacity = '1';
        
        // Store the current week key for saving
        weeklyReviewBox.dataset.weekKey = weekKey;
        
        // Make review non-editable if it's already saved (has content)
        const hasSavedContent = review.trim().length > 0;
        weeklyReviewBoxContent.readOnly = hasSavedContent;
        saveWeeklyReviewBtn.style.display = hasSavedContent ? 'none' : 'inline-block';
        
        // Update placeholder and styling based on edit state
        if (hasSavedContent) {
            weeklyReviewBoxContent.placeholder = 'This weekly review has been completed and is now read-only.';
            weeklyReviewBoxContent.style.cursor = 'default';
            weeklyReviewBoxContent.style.backgroundColor = '#1A1625';
            weeklyReviewBoxContent.style.borderColor = '#3A3651';
        } else {
            weeklyReviewBoxContent.placeholder = 'Click to add your weekly review notes...';
            weeklyReviewBoxContent.style.cursor = 'text';
            weeklyReviewBoxContent.style.backgroundColor = '#211D30';
            weeklyReviewBoxContent.style.borderColor = '#4F4B68';
            // Focus the textarea for immediate editing only if editable
            setTimeout(() => weeklyReviewBoxContent.focus(), 100);
        }
    }
    
    // Helper function to get the start of the week (Monday)
    function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
        return new Date(d.setDate(diff));
    }    closeWeeklyReviewBoxBtn.addEventListener('click', () => {
        weeklyReviewBox.style.opacity = '0';
        setTimeout(() => { weeklyReviewBox.style.display = 'none'; }, 200);
    });
    
    // Add click-outside-to-close functionality for weekly review box
    document.addEventListener('click', (e) => {
        // Check if weekly review box is open and click is outside of it
        if (weeklyReviewBox.style.display === 'block' && 
            !weeklyReviewBox.contains(e.target)) {
            // Close the weekly review box
            weeklyReviewBox.style.opacity = '0';
            setTimeout(() => { weeklyReviewBox.style.display = 'none'; }, 200);
        }
    });      saveWeeklyReviewBtn.addEventListener('click', () => {
        const weekKey = weeklyReviewBox.dataset.weekKey;
        const reviewText = weeklyReviewBoxContent.value.trim();
        
        if (weekKey) {
            if (reviewText) {
                localStorage.setItem(weekKey, reviewText);
                
                // Make the review non-editable after saving
                weeklyReviewBoxContent.readOnly = true;
                weeklyReviewBoxContent.placeholder = 'This weekly review has been completed and is now read-only.';
                weeklyReviewBoxContent.style.cursor = 'default';
                weeklyReviewBoxContent.style.backgroundColor = '#1A1625';
                weeklyReviewBoxContent.style.borderColor = '#3A3651';
                
                // Hide the save button
                saveWeeklyReviewBtn.style.display = 'none';
                
                // Show a brief success indicator on the close button
                const originalText = closeWeeklyReviewBoxBtn.innerHTML;
                closeWeeklyReviewBoxBtn.innerHTML = 'âœ“';
                closeWeeklyReviewBoxBtn.style.color = '#10b981';
                setTimeout(() => {
                    closeWeeklyReviewBoxBtn.innerHTML = originalText;
                    closeWeeklyReviewBoxBtn.style.color = '#63FFDA';
                }, 1500);
            } else {
                // Remove empty reviews from localStorage
                localStorage.removeItem(weekKey);
            }
        }
    });
      // Add keyboard shortcuts for the weekly review
    weeklyReviewBoxContent.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeWeeklyReviewBoxBtn.click();
        } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey) && !weeklyReviewBoxContent.readOnly) {
            // Only allow save shortcut if not read-only
            e.preventDefault();
            saveWeeklyReviewBtn.click();
        }
    });

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    // --- End Weekly Review Box Logic ---

    // --- NEW: Dashboard State Persistence ---
    function collectDashboardState() {
        return {
            tasks,
            calendarCurrentYear,
            calendarCurrentMonth,
            calendarViewMode,
            mainChartRange
        };
    }

    function applyDashboardState(state) {
        if (!state) return;
        tasks = (state.tasks || []).map(t => ({
          ...t,
          created: t.created ? new Date(t.created) : new Date(),
          completedAt: t.completedAt ? new Date(t.completedAt) : null
        }));
        calendarCurrentYear = state.calendarCurrentYear || new Date().getFullYear();
        calendarCurrentMonth = state.calendarCurrentMonth || new Date().getMonth();
        calendarViewMode = state.calendarViewMode || 'year';
        mainChartRange = state.mainChartRange || 'year';

        renderTasks();
        updateMainCharts(mainChartRange);
        updateDifficultyChart(mainChartRange);
        updatePriorityDifficultyChart(mainChartRange);
        updateCalendarDisplay();
    }

    function saveState() {
        const state = collectDashboardState();
        localStorage.setItem('productivityState', JSON.stringify(state));
    }

    function loadState() {
        const saved = localStorage.getItem('productivityState');
        if (!saved) return;
        const state = JSON.parse(saved);
        applyDashboardState(state);
    }

    window.addEventListener('DOMContentLoaded', () => {
        loadState();
    });
    // --- End Dashboard State Persistence ---

    // initialize
    loadTasks(); // Load tasks from localStorage first
    // Set initial active buttons for ALL toggles based on mainChartRange
    document.querySelectorAll(`.timeframe-toggle button[data-range="${mainChartRange}"]`).forEach(b => b.classList.add('active'));

    updateMainCharts(mainChartRange); // Initial update for main charts
    updateDifficultyChart(mainChartRange); // Initial update for difficulty chart using main range
    updatePriorityDifficultyChart(mainChartRange); // Initial update for new chart using main range
    renderTasks();
    updateCalendarDisplay(); // Initial setup of calendar view, display, and squares

    /* Disabled drag handles and Sortable to prevent widget movement */
    document.querySelectorAll('.drag-handle').forEach(h => h.remove());
    /*
    // Add drag handles to cards dynamically
    Array.from(document.querySelectorAll('.card')).forEach(card => {
      const handle = document.createElement('div');
      handle.className = 'drag-handle';
      card.insertBefore(handle, card.firstChild);
    });
    // Initialize drag-and-drop functionality
    new Sortable(document.querySelector('.dashboard'), {
        group: 'dashboardWidgets',
        handle: '.drag-handle',
        draggable: '> div',
        animation: 150,
        fallbackOnBody: true,
        forceFallback: true,
        ghostClass: 'sortable-ghost',
        fallbackClass: 'sortable-fallback'
    });
    new Sortable(document.querySelector('.widget-row'), {
        group: 'dashboardWidgets',
        handle: '.drag-handle',
        draggable: '> div',
        animation: 150,
        fallbackOnBody: true,
        forceFallback: true,
        ghostClass: 'sortable-ghost',
        fallbackClass: 'sortable-fallback'
    });
    (function(){
      const widgetGroup = 'dashboardWidgets';
      const cardParents = new Set(Array.from(document.querySelectorAll('.card')).map(c => c.parentElement));
      cardParents.forEach(container => {
        new Sortable(container, {
          group: widgetGroup,
          handle: '.drag-handle',
          draggable: '.card',
          animation: 150,
          fallbackOnBody: true,
          forceFallback: true,
          ghostClass: 'sortable-ghost',
          fallbackClass: 'sortable-fallback'
        });
      });    })();    */    // === ANIMATED GRADIENT EFFECT FOR BUTTONS ===
    function setupAnimatedButtons() {
      const buttons = document.querySelectorAll('.task-input button, .task-dropdown summary.options-btn, .timeframe-toggle button, .landing-timeframe-controls button, .difficulty-toggle button, .priority-difficulty-toggle button, .edit-btn, .delete-btn');
      
      buttons.forEach(button => {
        // Skip if already has event listeners
        if (button.hasAttribute('data-animated-setup')) return;
        button.setAttribute('data-animated-setup', 'true');
        
        button.addEventListener('mousemove', (e) => {
          const rect = button.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          
          button.style.setProperty('--mouse-x', `${x}%`);
          button.style.setProperty('--mouse-y', `${y}%`);
        });
        
        button.addEventListener('mouseleave', () => {
          // Reset to center when mouse leaves
          button.style.setProperty('--mouse-x', '50%');
          button.style.setProperty('--mouse-y', '50%');
        });
      });    }    // Initialize animated gradient effects
    setupAnimatedButtons();    // === SIDEBAR DROPDOWN FUNCTIONALITY ===
    function initializeSidebarDropdown() {
      // Finance dropdown
      const financeMainIcon = document.getElementById('financeMainIcon');
      const financeSubmenu = document.getElementById('financeSubmenu');
      
      // Productivity dropdown
      const productivityMainIcon = document.getElementById('productivityMainIcon');
      const productivitySubmenu = document.getElementById('productivitySubmenu');
        // Function to toggle a specific dropdown
      function toggleDropdown(icon, submenu) {
        if (!icon || !submenu) return;
        
        const isExpanded = submenu.classList.contains('expanded');
        
        // Close all dropdowns first
        document.querySelectorAll('.sidebar-submenu').forEach(menu => menu.classList.remove('expanded'));
        
        // If it wasn't expanded, expand this one and return true (indicating we toggled)
        if (!isExpanded) {
          submenu.classList.add('expanded');
          return true;
        }
        return false; // Indicate we just closed it
      }
      
      // Finance dropdown event listener
      if (financeMainIcon && financeSubmenu) {
        financeMainIcon.addEventListener('click', (e) => {
          const wasToggled = toggleDropdown(financeMainIcon, financeSubmenu);
          if (wasToggled) {
            e.preventDefault(); // Only prevent navigation if we opened a dropdown
            e.stopPropagation();
          }
          // If wasToggled is false, allow normal navigation behavior
        });
      }
      
      // Productivity dropdown event listener
      if (productivityMainIcon && productivitySubmenu) {
        productivityMainIcon.addEventListener('click', (e) => {
          const wasToggled = toggleDropdown(productivityMainIcon, productivitySubmenu);
          if (wasToggled) {
            e.preventDefault(); // Only prevent navigation if we opened a dropdown
            e.stopPropagation();
          }
          // If wasToggled is false, allow normal navigation behavior
        });
      }
      
      // Close dropdown when clicking elsewhere
      document.addEventListener('click', (e) => {
        const isDropdownClick = e.target.closest('.sidebar-item-main') || e.target.closest('.sidebar-submenu');
        if (!isDropdownClick) {
          document.querySelectorAll('.sidebar-submenu').forEach(menu => menu.classList.remove('expanded'));
        }
      });
      
      // Close dropdown on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document.querySelectorAll('.sidebar-submenu').forEach(menu => menu.classList.remove('expanded'));
        }
      });
    }
    
    // Initialize dropdown on page load
    initializeSidebarDropdown();
  </script>
  <script src="theme.js"></script>
</body>
</html>