<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Two‑Column Task Dashboard with Rounded Bars</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      background: #121212;
      color: #EEE;
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 40px;
      display: flex;
      justify-content: center;
    }
    .app-container {
      width: 100%;
      max-width: 1400px; /* Increased from 1000px */
    }
    /* Removed .dashboard ruleset as it was empty */
    .card {
      background: #1F1F1F;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      margin-bottom: 24px; /* Add margin between cards in the same column */
    }
    /* To‑Do Card */
    .task-input {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .priority-select {
      display: flex;
      gap: 8px;
      margin-right: 8px;
    }
    .priority-btn {
      width: 16px;
      height: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      opacity: 0.6;
    }
    .priority-btn.selected { opacity: 1; }
    .priority-btn.low  { background: #4CAF50; }
    .priority-btn.med  { background: #FFC107; }
    .priority-btn.high { background: #F44336; }

    .task-input input {
      flex: 1;
      /* match button height */
      height: 36px;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background: #2A2A2A;
      color: #FFF;
      font-size: 14px;
    }
    .task-input button {
      margin-left: 8px;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      background: #8A4FFF;
      color: #FFF;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px; /* Ensure consistent font size */
    }
    .task-input button,
    .task-dropdown summary.options-btn {
      height: 36px;
      padding: 0 16px;  /* only left/right padding */
    }
    .task-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
      padding-top: 24px; /* ensure first tooltip shows above without being cut off */
    }
    .task-list li {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #333;
      position: relative;
    }
    .task-list label {
      margin-left: 8px;
      flex: 1;
      color: #EEE;
      margin-right: 8px; /* Add margin to separate label from potential delete button */
    }

    /* Style for the delete button */
    .delete-btn {
        background: transparent; /* Transparent background */
        color: #F44336;
        border: none;
        border-radius: 4px;
        padding: 4px; /* Adjust click target */
        font-size: 12px;
        cursor: pointer;
        margin-left: 8px; /* Add some space between edit/delete */
    }
    .delete-btn:hover {
        opacity: 0.8;
    }

    /* Styles for Edit button and inline editing */
    .edit-btn, .save-btn {
        background: transparent; /* Transparent background */
        color: #8A4FFF; /* Use theme color */
        border: none;
        border-radius: 4px;
        padding: 4px; /* Adjust click target */
        font-size: 12px;
        cursor: pointer;
        margin-left: auto; /* Push edit/save controls to the right */
    }
    .edit-btn:hover, .save-btn:hover {
        opacity: 0.8;
    }
    .edit-container {
        display: flex;
        align-items: center;
        margin-left: auto; /* Push container to the right */
        gap: 4px; /* Space between input and save button */
    }
    .edit-container input[type="number"] {
        width: 60px; /* Adjust width as needed */
        padding: 4px 6px;
        border: none;
        border-radius: 4px;
        background: #2A2A2A;
        color: #FFF;
        font-size: 12px;
        appearance: textfield; /* Standard property for compatibility */
        -moz-appearance: textfield; /* hide Firefox spinner */
    }
    .edit-container input[type="number"]::-webkit-outer-spin-button,
    .edit-container input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none; /* hide Chrome/Safari spinner */
        margin: 0;
    }
    /* Hide edit container by default */
    .edit-container {
        display: none;
    }
    /* Hide edit button when editing */
    .task-list li.editing .edit-btn {
        display: none;
    }
    /* Show edit container when editing */
    .task-list li.editing .edit-container {
        display: flex;
    }

    /* Tooltip for task time info */
    .task-list li .tooltip {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 8px;
      background: #2A2A2A;
      color: #FFF;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      z-index: 10;
    }
    .task-list li:hover .tooltip {
      display: block;
    }

    /* dropdown menu for time fields */
    .task-dropdown { position: relative; margin-left: 8px; }
    /* Style the summary like a button */
    .task-dropdown summary.options-btn {
      /* match Add Task button sizing */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 36px;      /* same as input */
      padding: 0 16px;   /* only horizontal padding */
      border: none;
      border-radius: 4px;
      background: #8A4FFF;
      color: #FFF;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      line-height: normal;
    }
    /* Hide default summary arrow in Webkit browsers */
    .task-dropdown summary.options-btn::-webkit-details-marker {
      display: none;
    }
    .task-dropdown-content {
      position: absolute;
      top: calc(100% + 4px); /* Position below the button */
      left: 0;
      min-width: 150px; /* Give it some minimum width */
      background: #2A2A2A; padding: 8px; border-radius: 4px; z-index: 10; display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5); /* Add shadow */
    }
    .task-dropdown[open] .task-dropdown-content { display: block; }
    .task-dropdown-content label { display: block; color: #EEE; margin-bottom: 4px; font-size: 14px; }
    .task-dropdown-content input {
      width: 100%; padding: 4px 8px; margin-top: 2px;
      border: none; border-radius: 4px; background: #1F1F1F; color: #FFF;
    }

    /* iOS‑style toggle switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
      margin-left: 8px;
      vertical-align: middle;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #555;
      border-radius: 34px;
      transition: .4s;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background: #FFF;
      border-radius: 50%;
      transition: .4s;
    }
    .switch input:checked + .slider {
      background: #8A4FFF;
    }
    .switch input:checked + .slider:before {
      transform: translateX(20px);
    }

    /* Chart Card */
    .chart-header {
      display: flex;
      justify-content: space-between; /* Default alignment */
      align-items: center; /* Default alignment */
      margin-bottom: 8px; /* Add some space below header */
    }
    /* Specific style to center the Activity Calendar header and align items */
    .activity-calendar-header {
        justify-content: space-between; /* Distribute items: Title | Nav | Legend */
        align-items: center; /* Vertically align items */
        position: relative; /* Keep for potential future use */
    }
    .calendar-title-year-nav { /* Wrapper for center elements (Arrows + Year) */
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 15px; /* Gap between arrows and year */
    }
    .activity-calendar-header h3 { /* Style for the title now on the left */
        margin: 0;
        font-weight: 600;
        font-size: 18px; /* Keep original size or adjust as needed */
        width: 120px; /* Adjusted width for balance */
        text-align: left; /* Ensure text aligns left */
    }
    #calendarYearDisplay {
        font-size: 16px;   /* Increased from 14px */
        color: #AAA;
        font-weight: bold; /* Bold year display */
    }
    .calendar-nav-btn {
        background: transparent;
        border: none;
        color: #AAA;
        font-size: 20px; /* Make arrows larger */
        cursor: pointer;
        padding: 0 5px; /* Add some padding */
        font-weight: bold; /* Bold arrow buttons */
    }
    .calendar-nav-btn:hover {
        color: #FFF;
    }
    /* Style for the calendar legend (Resized and on the right) */
    .calendar-legend {
        display: flex;
        align-items: center;
        justify-content: flex-end; /* Align items to the right within the legend */
        gap: 3px; /* Reduced gap */
        padding: 3px 6px; /* Slightly reduced padding */
        border-radius: 4px;
        font-size: 10px; /* Reduced font size by ~20% */
        color: #AAA;
        width: 120px; /* Adjusted width to match title */
    }
    .calendar-legend .activity-square {
        width: 11px; /* Reduced size by ~20% */
        height: 11px; /* Reduced size by ~20% */
    }
    .timeframe-toggle {
      display: flex;
      gap: 8px;
    }
    .timeframe-toggle button {
      background: transparent;
      border: none;
      color: #888;
      font-size: 13px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .timeframe-toggle button.active {
      color: #FFF;
      font-weight: 600;
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 12px;
    }
    .hours-chart-container {
        position: relative;
        height: 150px; /* Updated height for hours chart */
        margin-top: 12px;
    }
    /* New style for two-column widget layout */
    .widget-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* Two equal columns */
        gap: 24px; /* Gap between columns */
        align-items: start; /* Align items to the top, preventing vertical stretching */
    }
    /* Ensure cards within the row don't have extra bottom margin if they are the last */
    .widget-row > .card {
        margin-bottom: 0; /* Remove bottom margin from cards inside the row */
    }
    /* Style for the new calendar widget container */
    .calendar-container {
        position: relative; /* Make container relative for absolute positioning of legend */
        height: 480px; /* Restored fixed height */
        margin-top: 12px;
        overflow: hidden; /* Add overflow hidden to prevent content spillover */
    }

    /* Styles for the new activity squares */
    .activity-squares-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0; /* Removed gap between squares */
      width: 100%; /* Ensure container takes full width */
      height: 100%; /* Ensure container takes full height */
      align-content: flex-start; /* Align wrapped lines to the start */
      justify-content: center; /* Center items horizontally, affecting the last row */
    }

    .activity-square {
      /* Final size adjustment */
      width: 28.5px; 
      height: 28.5px; 
      background-color: #2A2A2A; /* Default empty color */
      border-radius: 2px; /* Slightly rounded corners */
    }
    /* New Heatmap activity levels (Royal Blue theme) */
    .activity-square.heatmap-level-0 { background-color: #2A2A2A; } /* 0 tasks */
    .activity-square.heatmap-level-1 { background-color: rgba(65, 105, 225, 0.3); } /* 1-2 tasks (Royal Blue 30%) */
    .activity-square.heatmap-level-2 { background-color: rgba(65, 105, 225, 0.6); } /* 3-4 tasks (Royal Blue 60%) */
    .activity-square.heatmap-level-3 { background-color: rgb(65, 105, 225); } /* 5+ tasks (Royal Blue 100%) */

    /* strip box around pencil/trash icons */
    .edit-btn,
    .delete-btn {
      background: none !important;
      border: none !important;
      padding: 0 !important;
      margin: 0 8px !important;
      line-height: 1;
      font-size: 16px; /* adjust icon size if needed */
    }

    /* restyle icons to match grey/red theme */
    .edit-btn {
      color: #CCC;        /* light grey pencil */
    }
    .delete-btn {
      color: rgba(244, 67, 54, 0.7);  /* semi‐light red trashcan */
    }

    /* icon sizing: pencil stays 16x16, trash slightly larger */
    .edit-btn svg { width: 16px; height: 16px; }
    .delete-btn svg { width: 18px; height: 18px; }

    /* icon sizing & colors */
    .edit-btn svg, .delete-btn svg {
      vertical-align: middle;
    }
    .edit-btn .pencil-icon { fill: #CCC; }                     /* light grey pencil */
    .delete-btn .trash-icon { fill: rgba(244, 67, 54, 0.7); }   /* soft red trashcan */

    /* color the delta arrow/percent green on increase, red on decrease */
    .delta-indicator.increase {
      color: #4CAF50;
    }
    .delta-indicator.decrease {
      color: #F44336;
    }

    /* Style for the new placeholder widget */
    .new-widget-placeholder {
        height: 260px; /* Adjusted height */
        width: 50%; /* Half width of the parent container (the column wrapper div) */
        display: flex; /* Example content alignment */
        align-items: center;
        justify-content: center;
        font-style: italic;
        color: #666;
    }
    /* Style for the new difficulty chart container */
    .difficulty-chart-container {
        height: 180px; /* Reduced height for the chart canvas area */
        margin-top: 8px; /* Space below toggle */
        position: relative;
    }
    /* Specific height for the difficulty chart card */
    .card:has(.difficulty-toggle) { /* Target the card containing the difficulty toggle */
        height: 260px;
        display: flex; /* Use flexbox for internal alignment */
        flex-direction: column; /* Stack toggle and chart vertically */
    }
    /* Style for the new priority/difficulty chart */
    .priority-difficulty-chart-container {
        height: 180px; /* Match difficulty chart canvas area height */
        margin-top: 8px; /* Space below toggle */
        position: relative;
    }
    /* Specific height for the priority/difficulty chart card */
    .card:has(#priorityDifficultyChart) { /* Target the card containing the new chart */
        height: 260px; /* Match the other small card height */
        display: flex;
        flex-direction: column;
    }

    /* Remove placeholder styles if they conflict */
    .new-widget-placeholder {
        /* Keep general styles if needed, but height/content might be overridden */
        /* height: 260px; */ /* Now controlled by card:has() */
        /* width: 50%; */ /* Width is handled by the grid/flex layout */
        display: flex;
        align-items: center;
        justify-content: center;
        font-style: italic;
        color: #666;
    }
    /* Ensure the specific card for the new chart doesn't act like a placeholder */
    .card:has(#priorityDifficultyChart).new-widget-placeholder {
        font-style: normal;
        color: inherit;
        /* Override other placeholder styles if necessary */
    }

  </style>
</head>
<body>

  <div class="app-container">
    <div class="dashboard">

      <!-- 1. EXISTING TODO LIST CARD -->
      <div class="card">
        <div class="task-input">
          <div class="priority-select">
            <button class="priority-btn low selected"  data-priority="low"  title="Low"></button>
            <button class="priority-btn med"           data-priority="med"  title="Medium"></button>
            <button class="priority-btn high"          data-priority="high" title="High"></button>
          </div>
          <input id="newTask" type="text" placeholder="Enter a new task…">
          <!-- time fields dropdown -->
          <details class="task-dropdown">
            <summary class="options-btn">Options</summary>
            <div class="task-dropdown-content">
              <label>Time Allotted
                <input id="newTimeAllotted" type="number" min="0" placeholder="hrs">
              </label>
              <!-- Difficulty toggle → iOS switch -->
              <label>Difficulty</label>
              <label class="switch">
                <input id="newDifficulty" type="checkbox">
                <span class="slider"></span>
              </label>
              <span id="difficultyLabel">Easy</span>
            </div>
          </details>
          <button id="addBtn">Add Task</button>
        </div>
        <ul id="taskList" class="task-list"></ul>
      </div>

      <!-- 2. OVERALL PERFORMANCE CARD (Moved Here) -->
      <div class="card">
        <div class="chart-header">
          <h3>Overall Performance</h3>
          <div class="timeframe-toggle">
            <button data-range="year" class="active">This Year</button>
            <button data-range="month">This Month</button>
            <button data-range="week">This Week</button>
            <button data-range="day">Today</button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="overallPerformanceChart"></canvas>
        </div>
      </div>

      <!-- Row container for Hours Worked and future widget -->
      <div class="widget-row">
        <!-- Column 1: Hours Worked + New Widget -->
        <div> <!-- Added wrapper div for vertical stacking -->
            <!-- 3. HOURS WORKED CARD (Now inside wrapper) -->
            <div class="card">
              <div class="chart-header">
                <h3>Hours Worked</h3>
                <div class="timeframe-toggle">
                  <button data-range="year" class="active">This Year</button>
                  <button data-range="month">This Month</button>
                  <button data-range="week">This Week</button>
                  <button data-range="day">Today</button>
                </div>
              </div>
              <!-- Total Hours Display Area -->
              <div id="totalHoursDisplay">
                  <span>Total Spent: 0 hrs</span>
                  <span class="delta-indicator"></span> <!-- Added span for delta -->
              </div>
              <div class="hours-chart-container">
                <canvas id="hoursWorkedChart"></canvas>
              </div>
            </div>

            <!-- 5. NEW HALF-WIDTH WIDGET PLACEHOLDER -->
            <!-- Wrapper for side-by-side placeholders -->
            <div style="display: flex; gap: 24px;"> <!-- Added flex wrapper -->
                <!-- Difficulty Completion Chart -->
                <div class="card"> <!-- Removed new-widget-placeholder class -->
                    <div class="timeframe-toggle difficulty-toggle"> <!-- New toggle group -->
                        <button data-range="year" class="active">This Year</button>
                        <button data-range="month">This Month</button>
                        <button data-range="week">This Week</button>
                        <button data-range="day">Today</button>
                    </div>
                    <div class="difficulty-chart-container"> <!-- Adjusted container height via CSS -->
                        <canvas id="difficultyCompletionChart"></canvas> <!-- New canvas -->
                    </div>
                </div>
                <!-- Priority vs Difficulty Chart -->
                <div class="card"> <!-- Removed new-widget-placeholder class -->
                    <div class="timeframe-toggle priority-difficulty-toggle"> <!-- New toggle group -->
                        <button data-range="year">This Year</button>
                        <button data-range="month">This Month</button>
                        <button data-range="week">This Week</button>
                        <button data-range="day" class="active">Today</button> <!-- Default to Today -->
                    </div>
                    <div class="priority-difficulty-chart-container"> <!-- New container -->
                        <canvas id="priorityDifficultyChart"></canvas> <!-- New canvas -->
                    </div>
                </div>
            </div> <!-- End flex wrapper -->
        </div> <!-- End wrapper div -->

        <!-- Column 2: Activity Calendar -->
        <div> <!-- Added wrapper div for consistency, though only one item -->
            <!-- 4. NEW ACTIVITY CALENDAR WIDGET -->
            <div class="card">
              <!-- Updated Header Structure -->
              <div class="chart-header activity-calendar-header">
                <!-- Title Moved to Left -->
                <h3>Activity Calendar</h3>

                <!-- Wrapper for Center Elements (Arrows + Year) -->
                <div class="calendar-title-year-nav">
                    <button class="calendar-nav-btn" id="prevYearBtn">&lt;</button> <!-- Left Arrow -->
                    <div class="calendar-title-year">
                      <!-- H3 removed from here -->
                      <span id="calendarYearDisplay">2025</span> <!-- Year Display -->
                    </div>
                    <button class="calendar-nav-btn" id="nextYearBtn">&gt;</button> <!-- Right Arrow -->
                </div>

                <!-- Legend Moved to Right -->
                <div class="calendar-legend">
                  <span>Less</span>
                  <div class="activity-square heatmap-level-0"></div>
                  <div class="activity-square heatmap-level-1"></div>
                  <div class="activity-square heatmap-level-2"></div>
                  <div class="activity-square heatmap-level-3"></div>
                  <span>More</span>
                </div>
              </div>
              <!-- End Updated Header Structure -->
              <div class="calendar-container" id="activityCalendarContainer">
                <div class="activity-squares-container">
                  <!-- Squares will be generated here by JS -->
                </div>
              </div>
            </div>
            <!-- End New Activity Calendar Widget -->
        </div> <!-- End wrapper div -->

      </div> <!-- End widget-row -->

    </div>
  </div>

  <script>
    // TASK STORAGE
    let tasks = []; // Use let instead of const to allow reassignment on load
    let currentPriority = 'low';
    let calendarCurrentYear = new Date().getFullYear(); // Initialize calendar year
    // Chart Ranges
    let mainChartRange = 'year'; // For ALL charts except calendar

    // --- DOM Elements ---
    const calendarYearDisplay = document.getElementById('calendarYearDisplay');
    const prevYearBtn = document.getElementById('prevYearBtn');
    const nextYearBtn = document.getElementById('nextYearBtn');
    // Difficulty Chart Elements
    const ctxDifficulty = document.getElementById('difficultyCompletionChart').getContext('2d');
    const difficultyToggleButtons = document.querySelectorAll('.difficulty-toggle button');
    // Priority/Difficulty Chart Elements
    const ctxPriorityDifficulty = document.getElementById('priorityDifficultyChart').getContext('2d');
    const priorityDifficultyToggleButtons = document.querySelectorAll('.priority-difficulty-toggle button'); // Keep reference for updating active state


    // --- LOCAL STORAGE FUNCTIONS ---
    function saveTasks() {
        localStorage.setItem('productivityTasks', JSON.stringify(tasks));
    }

    function loadTasks() {
        const savedTasks = localStorage.getItem('productivityTasks');
        if (savedTasks) {
            tasks = JSON.parse(savedTasks).map(task => ({
                ...task,
                // Convert date strings back to Date objects
                created: new Date(task.created),
                completedAt: task.completedAt ? new Date(task.completedAt) : null
            }));
        }
    }

    // PRIORITY BUTTON HANDLING
    document.querySelectorAll('.priority-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        currentPriority = btn.dataset.priority;
      });
    });

    // CHART.JS SETUP (Overall Performance)
    const ctxOverall = document.getElementById('overallPerformanceChart').getContext('2d');
    const gradient = ctxOverall.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(138, 79, 255, 0.4)');
    gradient.addColorStop(1, 'rgba(138, 79, 255, 0)');

    const overallChart = new Chart(ctxOverall, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          {
            type: 'bar',
            label: 'Low Assigned',
            data: [],
            backgroundColor: '#4CAF50',
            stack: 'assigned',
            borderRadius: 6,
            borderSkipped: 'bottom',
            barPercentage: 0.5 // Added to reduce bar width
          },
          {
            type: 'bar',
            label: 'Med Assigned',
            data: [],
            backgroundColor: '#FFC107',
            stack: 'assigned',
            borderRadius: 6,
            borderSkipped: 'bottom',
            barPercentage: 0.5 // Added to reduce bar width
          },
          {
            type: 'bar',
            label: 'High Assigned',
            data: [],
            backgroundColor: '#F44336',
            stack: 'assigned',
            borderRadius: 6,
            borderSkipped: 'bottom',
            barPercentage: 0.5 // Added to reduce bar width
          },
          {
            type: 'line',
            label: 'Tasks Assigned',
            data: [],
            borderColor: '#FFFFFF',
            borderDash: [6,6],
            fill: false,
            tension: 0.4,
            pointRadius: 0, // Hide points by default
            yAxisID: 'y'
          },
          {
            type: 'line',
            label: 'Tasks Completed',
            data: [],
            borderColor: '#8A4FFF',
            backgroundColor: gradient,
            fill: true,
            tension: 0.4,
            pointRadius: 0, // Hide points by default
            pointBackgroundColor: '#8A4FFF',
            pointBorderColor: '#1F1F1F',
            pointHoverRadius: 6,
            yAxisID: 'y'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        elements: { bar: { borderRadius: 8, borderSkipped: false } },
        interaction: { mode: 'index', intersect: false },
        scales: { 
          x: { stacked: true, grid: { display: false }, ticks: { color: '#AAA' } }, 
          y: { 
            beginAtZero: true, 
            stacked: false, 
            grid: { display: false, color: 'rgba(255,255,255,0.1)', drawBorder: false }, 
            ticks: { 
              color: '#AAA',
              stepSize: 1 // Ensure y-axis increments by whole numbers
            } 
          } 
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            mode: 'index', intersect: false,
            displayColors: false,
            backgroundColor: '#2A244B', titleColor: '#FFF', bodyColor: '#FFF', padding: 8,
            borderColor: '#8A4FFF', borderWidth: 1,
            callbacks: {
              title: items => {
                const label = items[0].label;
                const now = new Date();
                if (mainChartRange === 'year') return label + ' ' + now.getFullYear();
                if (mainChartRange === 'month') return now.toLocaleString('default', { month: 'long' }) + ' ' + label + ', ' + now.getFullYear();
                return label; // Default
              },
              label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}`
            }
          }
        }
      }
    });

    // CHART.JS SETUP (Hours Worked)
    const ctxHours = document.getElementById('hoursWorkedChart').getContext('2d');
    const hoursChart = new Chart(ctxHours, {
        type: 'bar',
        data: {
            labels: [], // Labels will be updated dynamically
            datasets: [
                {
                    label: 'Time Allotted',
                    data: [], // Initial value
                    backgroundColor: '#4CAF50', // Green
                    borderRadius: 6,
                    borderSkipped: false
                },
                {
                    label: 'Time Spent',
                    data: [], // Initial value
                    backgroundColor: '#8A4FFF', // Blue/Purple
                    borderRadius: 6,
                    borderSkipped: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { // Time axis
                    grid: { display: false },
                    ticks: { color: '#AAA' }
                },
                y: { // Hours axis
                    beginAtZero: true,
                    grid: { display: false, color: 'rgba(255,255,255,0.1)', drawBorder: false },
                    ticks: { color: '#AAA' }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: { color: '#AAA' }
                },
                tooltip: {
                    enabled: true,
                    mode: 'index', // Show tooltips for both bars at the same index
                    intersect: false,
                    displayColors: false,
                    backgroundColor: '#2A244B', titleColor: '#FFF', bodyColor: '#FFF', padding: 8,
                    borderColor: '#8A4FFF', borderWidth: 1,
                    callbacks: {
                        title: items => {
                            const label = items[0].label;
                            const now = new Date();
                            if (mainChartRange === 'year') return label + ' ' + now.getFullYear();
                            if (mainChartRange === 'month') return now.toLocaleString('default', { month: 'long' }) + ' ' + label + ', ' + now.getFullYear();
                            return label; // Default
                        },
                        label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y} hrs`
                    }
                }
            }
        }
    });

    // CHART.JS SETUP (Difficulty Completion)
    const difficultyChart = new Chart(ctxDifficulty, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Easy Completed',
                    data: [],
                    borderColor: '#4CAF50', // Green for Easy (remains green)
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    fill: false, // Changed to false to remove fill
                    tension: 0.4,
                    pointRadius: 0, // Hide points by default
                    pointBackgroundColor: '#4CAF50', // Green point
                    pointBorderColor: '#1F1F1F',
                    pointHoverRadius: 4, // Keep hover radius
                },
                {
                    label: 'Hard Completed',
                    data: [],
                    borderColor: '#F44336', // Changed to Red for Hard
                    backgroundColor: 'rgba(244, 67, 54, 0.1)', // Red background fill
                    fill: false, // Changed to false to remove fill
                    tension: 0.4,
                    pointRadius: 0, // Hide points by default
                    pointBackgroundColor: '#F44336', // Red point
                    pointBorderColor: '#1F1F1F',
                    pointHoverRadius: 4, // Keep hover radius
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { 
                    grid: { 
                        display: false, // Hide X grid lines again
                        drawBorder: false 
                    }, 
                    ticks: { display: false } // Keep X ticks hidden
                }, 
                y: {
                    beginAtZero: true,
                    grid: { display: false, color: 'rgba(255,255,255,0.1)', drawBorder: false },
                    ticks: { 
                        display: false, // Hide Y-axis ticks (numbers)
                        color: '#AAA', 
                        stepSize: 1 
                    } 
                }
            },
            plugins: {
                legend: { display: false }, // Hide legend
                tooltip: { // Keep tooltips, simplified
                    enabled: true,
                    mode: 'index', intersect: false,
                    displayColors: false,
                    backgroundColor: '#2A244B', titleColor: '#FFF', bodyColor: '#FFF', padding: 8,
                    borderColor: '#8A4FFF', borderWidth: 1,
                    callbacks: {
                        title: items => items[0].label, // Simpler title
                        label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}`
                    }
                }
            }
        }
    });

    // --- NEW: Center Text Plugin for Doughnut Chart ---
    const centerTextPlugin = {
      id: 'centerText',
      afterDraw: (chart) => {
        if (chart.config.type === 'doughnut' && chart.config.options.plugins.centerText?.display) {
          const ctx = chart.ctx;
          const { width, height } = chart.chartArea;
          const numberText = chart.config.options.plugins.centerText.text || '0'; // Get number from options
          const labelText = "tasks completed"; // Second line text

          ctx.save();
          const centerX = width / 2;
          const centerY = height / 2;
          const lineHeight = 10; // Adjust spacing between lines

          // Draw the number
          ctx.font = 'bold 24px Poppins'; // Make number slightly larger
          ctx.fillStyle = '#EEE';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom'; // Align bottom of number text
          ctx.fillText(numberText, centerX, centerY + lineHeight / 2); // Position number slightly above center point

          // Draw the label below the number
          ctx.font = 'normal 12px Poppins'; // Smaller font for label
          ctx.fillStyle = '#AAA'; // Slightly dimmer color for label
          ctx.textBaseline = 'top'; // Align top of label text
          ctx.fillText(labelText, centerX, centerY + lineHeight / 2 + 2); // Position label slightly below center point + spacing

          ctx.restore();
        }
      }
    };
    // Register the plugin globally (or locally in the chart options)
    // Chart.register(centerTextPlugin); // Global registration - alternatively, add to chart options

    // CHART.JS SETUP (Priority vs Difficulty Doughnut)
    const priorityDifficultyChart = new Chart(ctxPriorityDifficulty, {
        type: 'doughnut',
        data: {
            // Update labels to be more specific for tooltips
            labels: ['Priority: High', 'Priority: Med', 'Priority: Low', 'Difficulty: Easy', 'Difficulty: Hard'],
            datasets: [
                {
                    label: 'Priority', // Outer ring
                    data: [0, 0, 0], // Start with 0, will be updated
                    backgroundColor: [
                        '#F44336', // High
                        '#FFC107', // Med
                        '#4CAF50'  // Low
                    ],
                    borderWidth: 2,
                    borderColor: '#1F1F1F', // Match card background for separation
                },
                {
                    label: 'Difficulty', // Inner ring
                    data: [0, 0], // Start with 0, will be updated
                    // Use the same colors as the difficulty line chart for consistency
                    backgroundColor: [
                        '#4CAF50', // Easy (Green)
                        '#F44336'  // Hard (Red)
                    ],
                    borderWidth: 2,
                    borderColor: '#1F1F1F',
                    weight: 0.7 // Makes the inner ring slightly smaller relative to outer
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%', // Increased cutout percentage to make rings thinner
            plugins: {
                centerText: {
                  display: true,
                  text: '0' // Initial text value (number)
                },
                legend: {
                    display: false // Hide default legend
                },
                tooltip: {
                    enabled: true, // Enable tooltips
                    callbacks: {
                        label: function(context) {
                            // Use the specific label defined in data.labels
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                // Show the actual count
                                label += context.parsed;
                            }
                            return label;
                        }
                    }
                }
            }
        },
        plugins: [centerTextPlugin]
    });

    // AGGREGATION LOGIC
    function aggregate(range) {
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth();
      let labels, low, med, high, completed, allottedHours, spentHours, easyCompleted, hardCompleted;
      // Add temporary arrays for priority completion counts within the range
      let completedLowArr, completedMedArr, completedHighArr;
      let previousTotalSpent = 0;

      // --- Calculate Current Period Data ---
      if (range === 'year') {
        labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        low = Array(12).fill(0); med = Array(12).fill(0); high = Array(12).fill(0); completed = Array(12).fill(0);
        allottedHours = Array(12).fill(0); spentHours = Array(12).fill(0);
        easyCompleted = Array(12).fill(0); hardCompleted = Array(12).fill(0);
        // Initialize temporary priority completion arrays
        completedLowArr = Array(12).fill(0); completedMedArr = Array(12).fill(0); completedHighArr = Array(12).fill(0);
        tasks.forEach(t => {
          // Current year assignment data
          if (t.created.getFullYear() === currentYear) {
            const m = t.created.getMonth();
            if (t.priority==='low') low[m]++; if (t.priority==='med') med[m]++; if (t.priority==='high') high[m]++;
            allottedHours[m] += (t.timeAllotted || 0);
            spentHours[m] += (t.timeSpent || 0);
          }
          // Current year completion data
          if (t.completedAt && t.completedAt.getFullYear() === currentYear) {
            const m = t.completedAt.getMonth();
            completed[m]++;
            if (t.difficulty === 'easy') easyCompleted[m]++;
            else if (t.difficulty === 'hard') hardCompleted[m]++;
            // Count completed by priority into temporary arrays
            if (t.priority === 'low') completedLowArr[m]++;
            if (t.priority === 'med') completedMedArr[m]++;
            if (t.priority === 'high') completedHighArr[m]++;
          }
          // Previous year data for delta calculation
          if (t.created.getFullYear() === currentYear - 1) {
            previousTotalSpent += (t.timeSpent || 0);
          }
        });
      } else if (range === 'month') {
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        labels = Array.from({ length: daysInMonth }, (_, i) => (i + 1).toString());
        low = Array(daysInMonth).fill(0); med = Array(daysInMonth).fill(0); high = Array(daysInMonth).fill(0); completed = Array(daysInMonth).fill(0);
        allottedHours = Array(daysInMonth).fill(0); spentHours = Array(daysInMonth).fill(0);
        easyCompleted = Array(daysInMonth).fill(0); hardCompleted = Array(daysInMonth).fill(0);
        // Initialize temporary priority completion arrays
        completedLowArr = Array(daysInMonth).fill(0); completedMedArr = Array(daysInMonth).fill(0); completedHighArr = Array(daysInMonth).fill(0);
        const prevMonthDate = new Date(currentYear, currentMonth, 1);
        prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
        const prevMonth = prevMonthDate.getMonth();
        const prevMonthYear = prevMonthDate.getFullYear();
        tasks.forEach(t => {
            // Current month assignment data
            if (t.created.getFullYear() === currentYear && t.created.getMonth() === currentMonth) {
                const dayIndex = t.created.getDate() - 1;
                if (t.priority === 'low') low[dayIndex]++; if (t.priority === 'med') med[dayIndex]++; if (t.priority === 'high') high[dayIndex]++;
                allottedHours[dayIndex] += (t.timeAllotted || 0); spentHours[dayIndex] += (t.timeSpent || 0);
            }
            // Current month completion data
            if (t.completedAt && t.completedAt.getFullYear() === currentYear && t.completedAt.getMonth() === currentMonth) {
                const dayIndex = t.completedAt.getDate() - 1;
                completed[dayIndex]++;
                if (t.difficulty === 'easy') easyCompleted[dayIndex]++;
                else if (t.difficulty === 'hard') hardCompleted[dayIndex]++;
                // Count completed by priority into temporary arrays
                if (t.priority === 'low') completedLowArr[dayIndex]++;
                if (t.priority === 'med') completedMedArr[dayIndex]++;
                if (t.priority === 'high') completedHighArr[dayIndex]++;
            }
            // Previous month data for delta calculation
            if (t.created.getFullYear() === prevMonthYear && t.created.getMonth() === prevMonth) {
                previousTotalSpent += (t.timeSpent || 0);
            }
        });
      } else if (range === 'week') {
        const day = now.getDay(), iso = (day+6)%7; // 0=Mon, 6=Sun
        const start = new Date(now); start.setDate(now.getDate()-iso); start.setHours(0,0,0,0);
        const end   = new Date(start); end.setDate(start.getDate()+6); end.setHours(23,59,59,999);
        const prevWeekStart = new Date(start); prevWeekStart.setDate(start.getDate() - 7);
        const prevWeekEnd = new Date(end); prevWeekEnd.setDate(end.getDate() - 7);
        labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        low = Array(7).fill(0); med = Array(7).fill(0); high = Array(7).fill(0); completed = Array(7).fill(0);
        allottedHours = Array(7).fill(0); spentHours = Array(7).fill(0);
        easyCompleted = Array(7).fill(0); hardCompleted = Array(7).fill(0);
        // Initialize temporary priority completion arrays
        completedLowArr = Array(7).fill(0); completedMedArr = Array(7).fill(0); completedHighArr = Array(7).fill(0);
        tasks.forEach(t=>{
          // Current week assignment data
          if (t.created>=start && t.created<=end) {
            const i=(t.created.getDay()+6)%7;
            if(t.priority==='low') low[i]++; if(t.priority==='med') med[i]++; if(t.priority==='high') high[i]++;
            allottedHours[i] += (t.timeAllotted || 0); spentHours[i] += (t.timeSpent || 0);
          }
          // Current week completion data
          if(t.completedAt && t.completedAt>=start && t.completedAt<=end) {
            const i = (t.completedAt.getDay()+6)%7;
            completed[i]++;
            if (t.difficulty === 'easy') easyCompleted[i]++;
            else if (t.difficulty === 'hard') hardCompleted[i]++;
            // Count completed by priority into temporary arrays
            if (t.priority === 'low') completedLowArr[i]++;
            if (t.priority === 'med') completedMedArr[i]++;
            if (t.priority === 'high') completedHighArr[i]++;
          }
          // Previous week data for delta calculation
          if (t.created >= prevWeekStart && t.created <= prevWeekEnd) {
            previousTotalSpent += (t.timeSpent || 0);
          }
        });
      } else { // day
        labels = Array.from({length:24},(_,i)=>`${i}:00`);
        low = Array(24).fill(0); med = Array(24).fill(0); high = Array(24).fill(0); completed = Array(24).fill(0);
        allottedHours = Array(24).fill(0); spentHours = Array(24).fill(0);
        easyCompleted = Array(24).fill(0); hardCompleted = Array(24).fill(0);
        // Initialize temporary priority completion arrays
        completedLowArr = Array(24).fill(0); completedMedArr = Array(24).fill(0); completedHighArr = Array(24).fill(0);
        const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1);
        tasks.forEach(t=>{
          // Current day assignment data
          if (isSameDay(t.created, now)) {
            const h = t.created.getHours();
            low[h]+=(t.priority==='low'); med[h]+=(t.priority==='med'); high[h]+=(t.priority==='high');
            allottedHours[h] += (t.timeAllotted || 0); spentHours[h] += (t.timeSpent || 0);
          }
          // Current day completion data
          if (t.completedAt && isSameDay(t.completedAt, now)) {
            const h = t.completedAt.getHours();
            completed[h]++;
            if (t.difficulty === 'easy') easyCompleted[h]++;
            else if (t.difficulty === 'hard') hardCompleted[h]++;
            // Count completed by priority into temporary arrays
            if (t.priority === 'low') completedLowArr[h]++;
            if (t.priority === 'med') completedMedArr[h]++;
            if (t.priority === 'high') completedHighArr[h]++;
          }
          // Previous day data for delta calculation
          if (isSameDay(t.created, yesterday)) {
            previousTotalSpent += (t.timeSpent || 0);
          }
        });
      }

      // --- Calculate Totals and Percentage Change ---
      const assignedSum = low.map((_,i)=> low[i]+med[i]+high[i]);
      const totalSpentInRange = spentHours.reduce((sum, hours) => sum + hours, 0);
      let percentageChange = 0;
      if (previousTotalSpent > 0) {
          percentageChange = ((totalSpentInRange - previousTotalSpent) / previousTotalSpent) * 100;
      } else if (totalSpentInRange > 0) {
          percentageChange = Infinity; // Indicate increase from zero
      } // else percentageChange remains 0

      // --- Calculate total completed counts by priority for the range ---
      const totalCompletedLow = completedLowArr.reduce((sum, count) => sum + count, 0);
      const totalCompletedMed = completedMedArr.reduce((sum, count) => sum + count, 0);
      const totalCompletedHigh = completedHighArr.reduce((sum, count) => sum + count, 0);
      const totalCompletedPriority = totalCompletedLow + totalCompletedMed + totalCompletedHigh; // Sum for center text

      // --- Calculate total completed counts by difficulty for the range ---
      const totalCompletedEasy = easyCompleted.reduce((sum, count) => sum + count, 0);
      const totalCompletedHard = hardCompleted.reduce((sum, count) => sum + count, 0);


      // Return all aggregated data, including the *new* priority and difficulty completion totals
      return {
          // Original data for other charts
          labels, low, med, high, assignedSum, completed, allottedHours, spentHours,
          easyCompleted, hardCompleted, totalSpentInRange, percentageChange, previousTotalSpent,
          // New data for priority/difficulty chart
          totalCompletedLow, totalCompletedMed, totalCompletedHigh,
          totalCompletedEasy, totalCompletedHard,
          totalCompleted: totalCompletedPriority // Add the overall total completed count
      };
    }
    function isSameDay(a,b){ return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate(); }

    // CHART UPDATE FUNCTION (Main Charts: Overall Performance & Hours Worked)
    function updateMainCharts(range){
        const {labels, low, med, high, assignedSum, completed, allottedHours, spentHours, totalSpentInRange, percentageChange, previousTotalSpent} = aggregate(range);

        // --- Overall Performance Chart Update ---
        overallChart.data.labels=labels;
        overallChart.data.datasets[0].data=low;
        overallChart.data.datasets[1].data=med;
        overallChart.data.datasets[2].data=high;
        overallChart.data.datasets[3].data=assignedSum;
        overallChart.data.datasets[4].data=completed;
        // Update tooltip title callback based on mainChartRange
        overallChart.options.plugins.tooltip.callbacks.title = items => {
            const label = items[0].label;
            const now = new Date();
            if (mainChartRange === 'year') return label + ' ' + now.getFullYear();
            if (mainChartRange === 'month') return now.toLocaleString('default', { month: 'long' }) + ' ' + label + ', ' + now.getFullYear();
            return label; // Default
        };
        overallChart.update();

        // --- Hours Worked Chart Update ---
        hoursChart.data.labels = labels;
        hoursChart.data.datasets[0].data = allottedHours;
        hoursChart.data.datasets[1].data = spentHours;
        hoursChart.options.scales.x.ticks.autoSkip = range !== 'month';
        // Update tooltip title callback based on mainChartRange
        hoursChart.options.plugins.tooltip.callbacks.title = items => {
            const label = items[0].label;
            const now = new Date();
            if (mainChartRange === 'year') return label + ' ' + now.getFullYear();
            if (mainChartRange === 'month') return now.toLocaleString('default', { month: 'long' }) + ' ' + label + ', ' + now.getFullYear();
            return label; // Default
        };
        hoursChart.update();

        // --- Update Total Hours Display & Delta ---
        const totalHoursEl = document.getElementById('totalHoursDisplay').querySelector('span:first-child');
        const deltaIndicatorEl = document.getElementById('totalHoursDisplay').querySelector('.delta-indicator');

        let rangeText = '';
        if (range === 'year') rangeText = 'This Year';
        else if (range === 'month') rangeText = 'This Month';
        else if (range === 'week') rangeText = 'This Week';
        else if (range === 'day') rangeText = 'Today';
        totalHoursEl.textContent = `Total Spent (${rangeText}): ${totalSpentInRange} hrs`;

        // Update Delta Indicator
        deltaIndicatorEl.classList.remove('increase', 'decrease'); // Clear previous classes
        deltaIndicatorEl.innerHTML = ''; // Clear previous content

        if (previousTotalSpent === 0 && totalSpentInRange === 0) {
            deltaIndicatorEl.innerHTML = '--'; // No change from zero or no data
        } else if (percentageChange === Infinity) {
            deltaIndicatorEl.innerHTML = '↗ ∞%'; // Increase from zero - angled arrow, no parens
            deltaIndicatorEl.classList.add('increase');
        } else if (percentageChange > 0) {
            deltaIndicatorEl.innerHTML = `↗ ${percentageChange.toFixed(1)}%`; // Angled up arrow, no parens
            deltaIndicatorEl.classList.add('increase');
        } else if (percentageChange < 0) {
            deltaIndicatorEl.innerHTML = `↘ ${Math.abs(percentageChange).toFixed(1)}%`; // Angled down arrow, no parens
            deltaIndicatorEl.classList.add('decrease');
        } else { // percentageChange === 0
             deltaIndicatorEl.innerHTML = '→ 0.0%'; // Right arrow for no change, no parens
        }
    }

    // CHART UPDATE FUNCTION (Difficulty Completion Chart)
    function updateDifficultyChart(range) {
        const { labels, easyCompleted, hardCompleted } = aggregate(range);

        difficultyChart.data.labels = labels;
        difficultyChart.data.datasets[0].data = easyCompleted;
        difficultyChart.data.datasets[1].data = hardCompleted;
        // Update tooltip title callback based on the passed range
        difficultyChart.options.plugins.tooltip.callbacks.title = items => {
            const label = items[0].label;
            const now = new Date();
            if (range === 'year') return label + ' ' + now.getFullYear(); // Use passed range
            if (range === 'month') return now.toLocaleString('default', { month: 'long' }) + ' ' + label + ', ' + now.getFullYear(); // Use passed range
            return label; // Default
        };
        difficultyChart.options.scales.x.ticks.autoSkip = range !== 'month'; // Match behavior
        difficultyChart.update();
    }

    // CHART UPDATE FUNCTION (Priority vs Difficulty Chart) - Updated
    function updatePriorityDifficultyChart(range) { // Accepts range, which will be mainChartRange
        // Aggregate data, getting all necessary properties
        const aggregatedData = aggregate(range); // Use the passed range
        const { totalCompletedLow, totalCompletedMed, totalCompletedHigh, totalCompletedEasy, totalCompletedHard, totalCompleted } = aggregatedData; // Get totalCompleted

        // --- Prepare data for the outer ring (Priority) ---
        let priorityData = [totalCompletedHigh, totalCompletedMed, totalCompletedLow];
        const totalCompletedPriority = totalCompletedHigh + totalCompletedMed + totalCompletedLow;
        if (totalCompletedPriority === 0) {
            priorityData = [0, 0, 0];
        }
        priorityDifficultyChart.data.datasets[0].data = priorityData;

        // --- Prepare data for the inner ring (Difficulty) ---
        let difficultyData = [totalCompletedEasy, totalCompletedHard];
        const totalCompletedDifficulty = totalCompletedEasy + totalCompletedHard;
        if (totalCompletedDifficulty === 0) {
            difficultyData = [0, 0];
        }
        priorityDifficultyChart.data.datasets[1].data = difficultyData;

        // --- Update center text ---
        priorityDifficultyChart.config.options.plugins.centerText.text = totalCompleted.toString(); // Update text in options

        console.log(`Updating Priority/Difficulty chart for range: ${range}. Priority: [H:${totalCompletedHigh}, M:${totalCompletedMed}, L:${totalCompletedLow}], Difficulty: [E:${totalCompletedEasy}, H:${totalCompletedHard}], Total: ${totalCompleted}`);

        priorityDifficultyChart.update(); // Update the chart
    }

    // TIMEFRAME BUTTONS (Main Listener - NOW INCLUDES ALL CHARTS)
    document.querySelectorAll('.timeframe-toggle button').forEach(btn => { // Select ALL toggle buttons
      btn.addEventListener('click', () => {
        const range = btn.dataset.range;
        mainChartRange = range; // Update main range

        // Update active state in ALL toggle groups
        document.querySelectorAll('.timeframe-toggle button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll(`.timeframe-toggle button[data-range="${range}"]`).forEach(b => b.classList.add('active'));

        updateMainCharts(mainChartRange); // Update main charts (Overall, Hours)
        updateDifficultyChart(mainChartRange); // Update difficulty chart
        updatePriorityDifficultyChart(mainChartRange); // Update priority/difficulty chart
      });
    });

    // TASK UI & LOGIC
    const taskListEl = document.getElementById('taskList');
    const newTaskIn  = document.getElementById('newTask');
    const addBtn     = document.getElementById('addBtn');
    const newTimeAllotted = document.getElementById('newTimeAllotted');
    const newDifficultyIn = document.getElementById('newDifficulty');
    const difficultyLabel = document.getElementById('difficultyLabel');

    // --- Difficulty toggle setup ---
    newDifficultyIn.addEventListener('change', () => {
      difficultyLabel.textContent = newDifficultyIn.checked ? 'Hard' : 'Easy';
    });

    function renderTasks(){
      taskListEl.innerHTML = '';
      const today = new Date(); // Get today's date once for efficiency
      
      // Filter tasks to only include those created today for display
      const tasksToday = tasks.filter(t => isSameDay(t.created, today));

      tasksToday.forEach(t => { // Iterate over tasksToday instead of all tasks
        const li = document.createElement('li');
        li.dataset.taskId = t.id; // Add data attribute for easier selection

        const chk = document.createElement('input'); chk.type='checkbox'; chk.checked=t.completed;
        chk.addEventListener('change',()=>{
            t.completed=!t.completed;
            t.completedAt=t.completed?new Date():null;
            saveTasks(); // Save tasks when completion status changes
            updateMainCharts(mainChartRange); // Update main charts
            updateDifficultyChart(mainChartRange); // Use mainChartRange
            updatePriorityDifficultyChart(mainChartRange); // Use mainChartRange
            renderActivitySquares(calendarCurrentYear); // Update calendar too
        });

        const priorityIndicator = document.createElement('span');
        priorityIndicator.classList.add('priority-btn', t.priority, 'selected'); priorityIndicator.title = t.priority.charAt(0).toUpperCase()+t.priority.slice(1);

        const lbl = document.createElement('label'); lbl.textContent = t.text;

        const tooltip = document.createElement('span');
        tooltip.classList.add('tooltip');
        tooltip.textContent = `Time Allotted: ${t.timeAllotted || 0}h, Time Spent: ${t.timeSpent || 0}h`; // Ensure 0 if undefined

        // --- Edit Functionality Elements ---
        const editBtn = document.createElement('button');
        editBtn.innerHTML = `
          <svg viewBox="0 0 24 24" class="pencil-icon">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71
                     7.04a1.003 1.003 0 0 0 0-1.41l-2.34-2.34a1.003
                     1.003 1.003 0 0 0-1.41 0l-1.83 1.83 3.75 3.75
                     1.83-1.83z"/>
          </svg>`;
        editBtn.title = 'Edit';
        editBtn.classList.add('edit-btn');

        const editContainer = document.createElement('span');
        editContainer.classList.add('edit-container');

        const timeSpentInput = document.createElement('input');
        timeSpentInput.type = 'number';
        timeSpentInput.min = '0';
        timeSpentInput.placeholder = 'hrs spent';
        timeSpentInput.value = t.timeSpent || 0;

        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'Save';
        saveBtn.classList.add('save-btn');

        editContainer.append(timeSpentInput, saveBtn);
        // --- End Edit Functionality Elements ---

        li.append(chk, priorityIndicator, lbl, tooltip, editBtn, editContainer); // Add edit button and container

        // --- Edit Button Logic ---
        editBtn.addEventListener('click', () => {
            li.classList.add('editing'); // Add class to show/hide elements via CSS
            timeSpentInput.value = t.timeSpent || 0; // Ensure input has current value
            timeSpentInput.focus(); // Focus the input field
        });

        // --- Save Button Logic ---
        saveBtn.addEventListener('click', () => {
            const newSpentTime = parseInt(timeSpentInput.value) || 0;
            t.timeSpent = newSpentTime; // Update task object
            tooltip.textContent = `Time Allotted: ${t.timeAllotted || 0}h, Time Spent: ${t.timeSpent || 0}h`; // Update tooltip
            li.classList.remove('editing'); // Remove editing class
            saveTasks(); // Save to localStorage
            updateMainCharts(mainChartRange); // Update main charts
            updateDifficultyChart(mainChartRange); // Use mainChartRange
            updatePriorityDifficultyChart(mainChartRange); // Use mainChartRange
        });
        // Allow saving with Enter key in the input
        timeSpentInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                saveBtn.click(); // Trigger save button click
            } else if (e.key === 'Escape') {
                 li.classList.remove('editing'); // Cancel editing on Escape
            }
        });


        // Add delete button (logic remains the same as it already checks for today)
        if (isSameDay(t.created, today)) {
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `
              <svg viewBox="0 0 24 24" class="trash-icon">
                <path d="M16 9v10H8V9h8m-1.5-6h-5l-1
                         1H5v2h14V4h-4.5l-1-1z"/>
              </svg>`;
            deleteBtn.title = 'Delete';
            deleteBtn.classList.add('delete-btn');
            deleteBtn.addEventListener('click', () => {
                const taskIndex = tasks.findIndex(task => task.id === t.id);
                if (taskIndex > -1) {
                    tasks.splice(taskIndex, 1); // Remove task from array
                    saveTasks(); // Save updated array
                    renderTasks(); // Re-render the task list UI
                    updateMainCharts(mainChartRange); // Update main charts
                    updateDifficultyChart(mainChartRange); // Use mainChartRange
                    updatePriorityDifficultyChart(mainChartRange); // Use mainChartRange
                    renderActivitySquares(calendarCurrentYear); // Update calendar too
                }
            });
            li.appendChild(deleteBtn); // Append delete button to the list item
        }


        taskListEl.appendChild(li);
      });
    }
    function addTask(){
      const txt=newTaskIn.value.trim(); if(!txt) return;
      const allotted=parseInt(newTimeAllotted.value)||0;
      // capture difficulty
      const difficulty = newDifficultyIn.checked ? 'hard' : 'easy';
      const spent = 0; // Default timeSpent to 0
      tasks.push({ id: Date.now(), text: txt, priority: currentPriority, created: new Date(), completed: false, completedAt: null, timeAllotted: allotted, timeSpent: spent, difficulty });
      newTaskIn.value=''; newTimeAllotted.value='';
      // reset toggle
      newDifficultyIn.checked = false;
      difficultyLabel.textContent = 'Easy';
      // Close the details dropdown after adding
      const detailsElement = newTaskIn.closest('.card').querySelector('.task-dropdown');
      if (detailsElement) {
          detailsElement.removeAttribute('open');
      }
      saveTasks(); // Save tasks after adding a new one
      updateMainCharts(mainChartRange); // Update main charts
      updateDifficultyChart(mainChartRange); // Use mainChartRange
      updatePriorityDifficultyChart(mainChartRange); // Use mainChartRange
      renderTasks();
    }
    addBtn.addEventListener('click', addTask);
    newTaskIn.addEventListener('keydown',e=>{ if(e.key==='Enter') addTask(); });

    // --- NEW: Activity Squares Logic ---
    function renderActivitySquares(year) {
      const container = document
        .getElementById('activityCalendarContainer')
        .querySelector('.activity-squares-container');
      if (!container) return;
      container.innerHTML = '';

      // start of year → next year to compute days count
      const start = new Date(year, 0, 1);
      const nextYear = new Date(year + 1, 0, 1);
      const daysInYear = Math.round((nextYear - start) / (1000 * 60 * 60 * 24));

      for (let i = 0; i < daysInYear; i++) {
        // build the date for this square
        const d = new Date(start);
        d.setDate(start.getDate() + i);

        // count tasks completed on that day
        const count = tasks.filter(
          t => t.completedAt && isSameDay(t.completedAt, d)
        ).length;

        // determine heatmap level
        let level = 0;
        if (count >= 5) level = 3;
        else if (count >= 3) level = 2;
        else if (count >= 1) level = 1;

        const sq = document.createElement('div');
        sq.classList.add('activity-square', `heatmap-level-${level}`);
        container.appendChild(sq);
      }
    }
    // --- END: Activity Squares Logic ---

    // --- Calendar Navigation Logic ---
    function updateCalendarDisplay() {
        calendarYearDisplay.textContent = calendarCurrentYear;
        renderActivitySquares(calendarCurrentYear); // Re-render squares for the new year
        // TODO: Potentially update other parts of the UI that depend on the calendar year
    }

    prevYearBtn.addEventListener('click', () => {
        calendarCurrentYear--;
        updateCalendarDisplay();
    });

    nextYearBtn.addEventListener('click', () => {
        calendarCurrentYear++;
        updateCalendarDisplay();
    });
    // --- End Calendar Navigation Logic ---

    // initialize
    loadTasks(); // Load tasks from localStorage first
    // Set initial active buttons for ALL toggles based on mainChartRange
    document.querySelectorAll(`.timeframe-toggle button[data-range="${mainChartRange}"]`).forEach(b => b.classList.add('active'));

    updateMainCharts(mainChartRange); // Initial update for main charts
    updateDifficultyChart(mainChartRange); // Initial update for difficulty chart using main range
    updatePriorityDifficultyChart(mainChartRange); // Initial update for new chart using main range
    renderTasks();
    updateCalendarDisplay(); // Initial setup of calendar year display and squares
  </script>
</body>
</html>