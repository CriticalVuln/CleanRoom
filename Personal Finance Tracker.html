<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Finance Tracker</title>

  <!-- Your original inline styles -->
  <style>
    /* Copied from Productivity Tracker */
    * { box-sizing: border-box; }
    body {
      background: #0D0B14; /* Darker background */
      color: #E0E0E0; /* Lighter default text */
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 40px;
      display: flex;
      flex-direction: column; /* Stack nav button and content */
      align-items: center; /* Center content horizontally */
    }
    .app-container {
      width: 100%;
      max-width: 1000px; /* Adjust max-width as needed */
      background: #1A1625; /* Darker card background */
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      margin-top: 70px; /* Add space below the fixed nav button */
    }
    /* Copied from Productivity Tracker */
    .card {
      background: #1A1625; /* Darker card background */
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      margin-bottom: 24px; /* Add margin between cards */
    }
    /* Container for the chart to control its height */
    .chart-container {
      position: relative;
      height: 300px; /* Match Productivity Tracker Overall Performance chart height */
      margin-top: 12px; /* Add some space above the chart */
    }
    /* --- End Copied/Adapted Styles --- */

    h1 {
        color: #FFF; /* White heading */
        font-weight: 600;
        margin-bottom: 20px;
        text-align: center;
    }
    #csvPicker {
        display: block; /* Make it a block element */
        margin: 0 auto 20px auto; /* Center it and add bottom margin */
        padding: 10px;
        border: 1px solid #4F4B68; /* Darker border */
        border-radius: 4px;
        background: #211D30; /* Darker input background */
        color: #E0E0E0; /* Lighter text */
        cursor: pointer;
    }
    /* Style the file input button text */
    #csvPicker::file-selector-button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        background: #63FFDA; /* Accent Cyan/Turquoise */
        color: #0D0B14; /* Dark text for contrast */
        font-weight: 600;
        cursor: pointer;
        margin-right: 10px;
    }
    #total {
        text-align: center;
        font-size: 1.1em;
        color: #FFF; /* White text for total */
    }
    /* Copied from Productivity Tracker */
    .nav-button {
        position: fixed;
        left: 15px;
        top: 15px;
        background: #63FFDA; /* Accent Cyan/Turquoise */
        color: #000000; /* Black emoji */
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        font-family: "Poppins", sans-serif;
        font-weight: 600;
        font-size: 20px;
        line-height: 1;
        cursor: pointer;
        text-decoration: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        z-index: 1001;
    }
    .nav-button:hover {
        opacity: 0.9;
    }
    .content {
      width: 100%;
      max-width: 1400px; /* Match Productivity Tracker app-container width */
      margin-top: 70px; /* Add space below the fixed nav button */
      /* Center the content container itself */
      margin-left: auto;
      margin-right: auto;
    }
    /* Copied from Productivity Tracker */
  </style>

  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- â€•â€•â€•---- added helper libraries ----â€•â€•â€• -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script> <!-- Papa Parse CDN :contentReference[oaicite:0]{index=0} -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script> <!-- Chart.js UMD bundle :contentReference[oaicite:1]{index=1} -->
  <!-- ADDED: Date Adapter for Chart.js Time Scale -->
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script> <!-- date-fns library -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script> <!-- date-fns adapter -->
</head>
<body>
  <!-- Nav button (unchanged) -->
  <a href="Productivity Tracker.html" class="nav-button">ðŸ“Š</a>

  <div class="content">
    <h1>Personal Finance Tracker</h1>

    <!-- â€•â€•â€•---- added UI controls ----â€•â€•â€• -->
    <input id="csvPicker" type="file" accept=".csv,.pdf" multiple> <!-- Allow multiple files -->
    <!-- accept='.csv' restricts picker to statement files :contentReference[oaicite:2]{index=2} -->

    <!-- NEW: Card structure for chart -->
    <div class="card">
      <p id="total"></p>
      <div class="chart-container">
        <canvas id="spendChart"></canvas> <!-- Removed width/height attributes -->
      </div>
    </div>
    <!-- END: Card structure -->
  </div>

  <!-- â€•â€•â€•---- parsing + charting logic ----â€•â€•â€• -->
  <script>
    let chart; // Keep a reference to the chart outside the function

    // Helper to extract month and year from filename
    function extractMonthYearFromName(name) {
      const months = ['january','february','march','april','may','june','july','august','september','october','november','december'];
      const lower = name.toLowerCase();
      let month = null;
      months.forEach((m, i) => {
        if (lower.includes(m) || lower.includes(m.substr(0,3))) month = i + 1;
      });
      const yearMatch = name.match(/\b(20\d{2})\b/);
      const year = yearMatch ? parseInt(yearMatch[1]) : new Date().getFullYear();
      return month ? { month, year } : null;
    }

    // Global aggregates across all uploads
    let monthlyNet = {};
    let monthlyCharges = {};
    let monthlyPayments = {};
    let totalCharges = 0;
    let totalPayments = 0;

    // Update totals display and chart
    function updateDisplay() {
      // Clear numeric summary
      document.getElementById('total').innerHTML = '';
      // Combine months from charges and payments
      const labels = Array.from(new Set([
        ...Object.keys(monthlyCharges),
        ...Object.keys(monthlyPayments)
      ])).sort();
      const chargesData = labels.map(l => monthlyCharges[l] || 0);
      const paymentsData = labels.map(l => monthlyPayments[l] || 0);
      if (chart) chart.destroy();
      chart = new Chart(document.getElementById('spendChart'), {
        type: 'line',
        data: { labels, datasets: [
          {
            label: 'Charges',
            data: chargesData,
            tension: 0.3,
            borderColor: '#FF4C4C',
            backgroundColor: 'rgba(255,76,76,0.1)',
            fill: false,
            pointRadius: 3,
            pointBackgroundColor: '#FF4C4C',
            pointBorderColor: '#1A1625',
            pointHoverRadius: 6
          },
          {
            label: 'Payments',
            data: paymentsData,
            tension: 0.3,
            borderColor: '#4CFF4C',
            backgroundColor: 'rgba(76,255,76,0.1)',
            fill: false,
            pointRadius: 3,
            pointBackgroundColor: '#4CFF4C',
            pointBorderColor: '#1A1625',
            pointHoverRadius: 6
          }
        ]},
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { grid: { color: '#333' }, ticks: { color: '#ccc' } },
            y: { grid: { color: '#333' }, ticks: { color: '#ccc' } }
          },
          plugins: { legend: { labels: { color: '#E0E0E0' } } }
        }
      });
    }

    // --- Event Listener for File Picker (supports multiple) ---
    document.getElementById('csvPicker').addEventListener('change', e => {
      const files = Array.from(e.target.files);
      if (!files.length) return;
      files.forEach(f => {
        const fileName = f.name;
        const fileExtension = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();

        if (fileExtension === 'csv') {
          Papa.parse(f, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: res => handleRows(res.data, fileName)
          });
        } else if (fileExtension === 'pdf') {
          // Placeholder for PDF processing logic
          console.log("PDF file selected. Backend processing would be needed here.");
          alert("PDF processing is not yet implemented. Please upload a CSV file.");
          // TODO: Implement PDF processing:
          // 1. Send the PDF file (f) to a backend service.
          // 2. The backend service would convert the PDF to CSV data.
          // 3. Receive the CSV data from the backend.
          // 4. Parse the CSV data using Papa.parse or similar:
          //    Papa.parse(csvDataFromBackend, {
          //      header: true,
          //      dynamicTyping: true,
          //      skipEmptyLines: true,
          //      complete: res => handleRows(res.data)
          //    });
          // For now, clear the file input if a PDF is selected as no processing is implemented
          e.target.value = null;
        } else {
          alert("Unsupported file type. Please upload a CSV or PDF file.");
          e.target.value = null;
        }
      });
    });

    // --- Function to process CSV rows (with optional filename override) ---
    function handleRows(rows, fileName) {
      // Require at least one row
      if (!rows || !rows.length) return;
      // Detect header fields
      const headers = Object.keys(rows[0]);
      const dateField = headers.find(h => /date/i.test(h));
      const amountField = headers.find(h => /(amount|amt|value)/i.test(h));
      if (!dateField || !amountField) {
        alert('CSV must include date and amount columns');
        return;
      }
      // Determine month override from filename
      const fileInfo = extractMonthYearFromName(fileName);
      // Precompute grouping override key (always use filename month-year if found)
      const overrideKey = fileInfo
        ? `${fileInfo.year}-${String(fileInfo.month).padStart(2,'0')}`
        : null;

      rows.forEach(r => {
        const rawDt = r[dateField];
        const rawAmt = r[amountField];
        const dt = new Date(rawDt);
        const amt = Number(rawAmt);
        if (isNaN(amt) || isNaN(dt) || dt.toString() === 'Invalid Date') {
          console.warn(`Skipping row: Invalid data. Date='${rawDt}', Amount='${rawAmt}'`);
          return;
        }
        // Determine grouping key (override if available)
        const key = overrideKey || `${dt.getUTCFullYear()}-${String(dt.getUTCMonth()+1).padStart(2,'0')}`;
        // Accumulate per-month totals
        if (amt > 0) {
          monthlyCharges[key] = (monthlyCharges[key] || 0) + amt;
          totalCharges += amt;
        } else if (amt < 0) {
          monthlyPayments[key] = (monthlyPayments[key] || 0) + Math.abs(amt);
          totalPayments += Math.abs(amt);
        }
      });
      // Refresh display & chart
      updateDisplay();
    }
  </script>
</body>
</html>
