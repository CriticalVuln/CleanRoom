<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Finance Tracker</title>
  <style>
    /* === CSS VARIABLES FOR THEMING === */
    :root {
      /* Light Mode (Default) */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F8F9FA;
      --bg-tertiary: #F5F5F5;
      --text-primary: #333333;
      --text-secondary: #6B7280;
      --text-accent: #8B5CF6;
      --border-color: #E0E0E0;
      --shadow-light: rgba(0,0,0,0.08);
      --shadow-medium: rgba(0,0,0,0.1);
      --button-gradient-start: #8B5CF6;      --button-gradient-end: #A855F7;
      --button-shadow: rgba(139, 92, 246, 0.3);
      --button-hover-bg: #A855F7;
      --button-hover-glow: rgba(139, 92, 246, 0.6);
      --button-text-selected: #FFFFFF;
      --button-hover-border: rgba(139, 92, 246, 0.4);
      --button-hover-gradient-center: rgba(139, 92, 246, 0.4);
      --button-hover-gradient-mid: rgba(139, 92, 246, 0.2);
      --button-active-gradient-center: rgba(255, 255, 255, 0.3);
      --button-active-gradient-mid: rgba(255, 255, 255, 0.1);
      --switch-active: #8B5CF6;
      --priority-low: #4CAF50;
      --priority-medium: #FFC107;
      --priority-high: #F44336;
      --button-disabled-bg: #E5E7EB;
      --button-disabled-text: #9CA3AF;
    }

    /* Dark Mode */
    [data-theme="dark"] {
      --bg-primary: #0D0B14;
      --bg-secondary: #1A1625;
      --bg-tertiary: #211D30;
      --text-primary: #E0E0E0;
      --text-secondary: #A0A0A0;
      --text-accent: #63FFDA;
      --border-color: #4F4B68;
      --shadow-light: rgba(33,29,48,0.45);
      --shadow-medium: rgba(0,0,0,0.7);
      --button-gradient-start: #63FFDA;      --button-gradient-end: #63FFDA;
      --button-shadow: rgba(99, 255, 218, 0.3);
      --button-hover-bg: #52D9C3;
      --button-hover-glow: rgba(99, 255, 218, 1);
      --button-text-selected: #000000;
      --button-hover-border: rgba(99, 255, 218, 0.5);
      --button-hover-gradient-center: rgba(99, 255, 218, 0.4);
      --button-hover-gradient-mid: rgba(99, 255, 218, 0.2);
      --button-active-gradient-center: rgba(0, 0, 0, 0.3);
      --button-active-gradient-mid: rgba(0, 0, 0, 0.1);
      --switch-active: #A076F9;
      --priority-low: #4CAF50;
      --priority-medium: #FFC107;
      --priority-high: #F44336;
      --button-disabled-bg: #4F4B68;
      --button-disabled-text: #6B7280;
    }

    /* Global Reset and Base Styles */
    * { 
      box-sizing: border-box; 
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    /* Reusable Card Component */
    .card, .app-container {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px var(--shadow-medium);
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
    }
    .app-container {
      width: 100%;
      max-width: 1000px;
      padding: 25px;
      margin-top: 70px;
    }

    /* Content Layout */
    .content {
      width: 100%;
      max-width: 1400px;
      margin-top: 70px;
      margin-left: auto;
      margin-right: auto;
    }
    
    /* Chart Containers */
    .chart-container, .category-chart-container, .net-worth-container, .recent-transactions-container {
      position: relative;
    }
    .chart-container > h2, .category-chart-container h2, .net-worth-container h2, .recent-transactions-container h2 {
      text-align: center;
      color: var(--text-accent);
      font-weight: 600;
      margin-bottom: 15px;
      font-size: 1.2em;
    }    .category-chart-inner-container, .net-worth-chart-inner-container, .charges-payments-chart-inner-container {
      position: relative;
      height: 300px;
    }
    
    .category-chart-inner-container {
      height: 380px;
    }.category-chart-inner-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      padding: 15px 0;
    }
    .category-chart-inner-container canvas {
      max-width: 100%;
      max-height: 100%;
    }
    .net-worth-chart-inner-container {
      height: 250px;
    }
    .charges-payments-chart-inner-container {
      height: 350px;
    }/* Page Elements */
    h1 {
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }
    
    #total {
      text-align: center;
      font-size: 1.1em;
      color: var(--text-primary);
    }
      /* Form Elements */
    #csvPicker {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
    }
    #csvPicker::file-selector-button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      background: var(--text-accent);
      color: var(--button-text-selected);
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;    }
    /* Sidebar Navigation */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 60px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px 0;
    }
    
    .sidebar-nav {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .sidebar a {
      color: var(--text-accent);
      font-size: 24px;
      margin: 16px 0;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    .sidebar a:hover {
      transform: scale(1.1);
      color: var(--text-accent);
    }
    
    .sidebar a svg {
      width: 24px;
      height: 24px;
      fill: none;
      stroke: var(--text-accent);
      stroke-width: 2;
    }    /* Theme Toggle Button */    .theme-toggle {
      background: none;
      border: none;
      color: var(--text-accent);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background-color 0.3s ease, filter 0.3s ease;
      margin: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle:hover {
      filter: brightness(1.2);
    }

    .theme-toggle svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-accent);
      stroke-width: 2;
      fill: none;
      transition: stroke 0.3s ease;
    }

    .theme-toggle .sun-icon {
      display: block;
    }

    .theme-toggle .moon-icon {
      display: none;
    }

    [data-theme="dark"] .theme-toggle .sun-icon {
      display: none;
    }

    [data-theme="dark"] .theme-toggle .moon-icon {
      display: block;
    }/* Tab Components - Consolidated styling for File History and Banks tabs */
    .file-history-tab, .banks-tab, .upload-pdf-btn {
      position: absolute;
      top: 18px;
      background: var(--bg-tertiary);
      color: var(--text-accent);
      border: none;
      border-radius: 8px 8px 0 0;
      padding: 8px 22px 8px 18px;
      font-family: 'Poppins', sans-serif;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      z-index: 1100;
      box-shadow: 0 2px 8px var(--shadow-light);
      transition: background 0.15s, color 0.15s;
    }
    .file-history-tab {
      left: 70px;
    }
    .banks-tab {
      left: 200px;
    }
    .upload-pdf-btn {
      left: 330px;
    }
    .file-history-tab.active, .banks-tab.active, .upload-pdf-btn.active {
      background: var(--text-accent);
      color: var(--button-text-selected);
    }    /* Panel Components - Consolidated styling for both panels */
    .file-history-panel {
      position: absolute;
      top: 54px;
      left: 70px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 16px var(--shadow-medium);
      min-width: 380px;
      max-width: 480px;
      padding: 18px 18px 10px 18px;
      z-index: 1100;
      display: none;
    }
    .file-history-panel h3 {
      margin: 0 0 10px 0;
      font-size: 1.1em;
      color: var(--text-accent);
      font-weight: 600;
    }    /* List Components */
    .file-history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 220px;
      overflow-y: auto;
    }
    .file-history-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
    }
    .file-history-list li:last-child { 
      border-bottom: none; 
    }
    .file-history-list .filename {
      flex: 1;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }    /* Advanced Delete Button Styling - Matching Productivity Tracker */
    .file-history-list .delete-btn, .delete-btn {
      background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
      border: 1px solid var(--border-color);
      color: var(--priority-high);
      border-color: rgba(244, 67, 54, 0.2);
      background: linear-gradient(145deg, 
        rgba(244, 67, 54, 0.05), 
        rgba(244, 67, 54, 0.02)
      );
      padding: 8px 12px;
      margin-left: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      --mouse-x: 50%;
      --mouse-y: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 32px;
      min-width: 32px;
      box-shadow: 
        0 2px 4px var(--shadow-light),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .file-history-list .delete-btn:hover, .delete-btn:hover {
      background: linear-gradient(145deg, 
        rgba(244, 67, 54, 0.15), 
        rgba(244, 67, 54, 0.08)
      );
      border-color: rgba(244, 67, 54, 0.6);
      box-shadow: 
        0 4px 12px rgba(244, 67, 54, 0.25),
        0 2px 4px var(--shadow-light),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transform: translateY(-2px) scale(1.05);
      color: var(--priority-high);
    }

    .file-history-list .delete-btn:active, .delete-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 
        0 1px 2px var(--shadow-light),
        inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Enhanced animated gradient effects for delete buttons */
    .file-history-list .delete-btn::before, .delete-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(
        circle at var(--mouse-x) var(--mouse-y),
        rgba(255, 255, 255, 0.15) 0%,
        rgba(255, 255, 255, 0.05) 30%,
        transparent 60%
      );
      opacity: 0;
      transition: opacity 0.4s ease;
      border-radius: inherit;
      z-index: 1;
      pointer-events: none;
    }

    .file-history-list .delete-btn:hover::before, .delete-btn:hover::before {
      opacity: 1;
    }

    /* Subtle inner glow effect for delete buttons */
    .file-history-list .delete-btn::after, .delete-btn::after {
      content: '';
      position: absolute;
      top: 1px;
      left: 1px;
      right: 1px;
      bottom: 1px;
      background: linear-gradient(145deg, 
        rgba(244, 67, 54, 0.1), 
        transparent 50%
      );
      border-radius: 6px;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 0;
    }

    .file-history-list .delete-btn:hover::after, .delete-btn:hover::after {
      opacity: 1;
    }

    /* === DELETE BUTTON ANIMATED GRADIENT EFFECTS === */
    .delete-btn {
      position: relative;
      overflow: hidden;
      --mouse-x: 50%;
      --mouse-y: 50%;
    }
    
    .delete-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(
        circle at var(--mouse-x) var(--mouse-y),
        rgba(244, 67, 54, 0.4) 0%,
        rgba(244, 67, 54, 0.2) 30%,
        transparent 60%
      );
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: inherit;
      z-index: 1;
      pointer-events: none;
    }
    
    .delete-btn:hover::before {
      opacity: 1;
    }
    
    .delete-btn svg {
      position: relative;
      z-index: 2;
    }

    /* Timeframe Controls - Consolidated */
    .timeframe-controls {
      text-align: center;
      margin-bottom: 15px;
      display: flex;
      justify-content: center;
      gap: 12px;
    }
    .timeframe-controls button {
      background: none;
      border: 1px solid transparent;
      color: var(--text-accent);
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      padding: 5px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s, box-shadow 0.2s;
    }
    .timeframe-controls button.active {
      background-color: var(--bg-primary);
      color: var(--text-accent);
      border-color: var(--text-accent);
      box-shadow: none;
    }
    .timeframe-controls button:hover:not(.active) {
      background-color: transparent;
      color: var(--text-accent);
      border-color: transparent;
      box-shadow: 0 0 8px var(--button-hover-glow);
    }/* Layout Components */
    .charts-row-container {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 24px;
      margin-bottom: 24px;
    }
    .charts-row-container > .card {
      flex: 1 1 calc(50% - 12px);
      min-width: 300px;
      margin-bottom: 0;
    }
      /* Recent Transactions Table */
    .recent-transactions-table-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }
    .recent-transactions-table {
      width: 100%;
      border-collapse: collapse;
    }
    .recent-transactions-table th,
    .recent-transactions-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    .recent-transactions-table th {
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .recent-transactions-table td {
      color: var(--text-secondary);
    }
    .recent-transactions-table tr:last-child td {
      border-bottom: none;
    }
    .recent-transactions-table .amount-income {
      color: var(--text-accent);
      font-weight: 500;
    }
    .recent-transactions-table .amount-expense {
      color: var(--priority-high);
      font-weight: 500;
    }      /* Modal Components - Consolidated */
    .upload-modal {
      display: none;
      position: fixed;
      z-index: 1500;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }
    .upload-modal-content {
      background-color: var(--bg-secondary);
      margin: auto;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 8px 25px var(--shadow-medium);
      width: 90%;
      max-width: 550px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .upload-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    .upload-modal-header h2 {
      color: var(--text-primary);
      font-size: 1.4em;
      margin: 0;
    }
    .upload-modal-close-btn {
      color: var(--text-secondary);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
    }
    .upload-modal-close-btn:hover,
    .upload-modal-close-btn:focus {
      color: var(--text-primary);
    }    /* Upload Area Components */
    .upload-area {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      background-color: var(--bg-primary);
      transition: background-color 0.2s, border-color 0.2s;
    }
    .upload-area:hover {
      background-color: var(--bg-tertiary);
      border-color: var(--text-accent);
    }
    .upload-area-icon {
      font-size: 40px;
      color: var(--text-accent);
      margin-bottom: 15px;
    }
    .upload-area-text {
      color: var(--text-primary);
      font-size: 1.1em;
      margin-bottom: 8px;
    }
    .upload-area-subtext {
      color: var(--text-secondary);
      font-size: 0.9em;
    }
    #modalPdfInput {
      display: none;
    }
    #selectedFilesList {
      margin-top: 15px;
      max-height: 100px;
      overflow-y: auto;
      font-size: 0.9em;
      color: var(--text-secondary);
    }
    #selectedFilesList div {
      padding: 3px 0;
    }
    .upload-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }    /* Universal Button Styling - Consolidated */
    .upload-modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95em;
      transition: background-color 0.2s, color 0.2s;
    }    .upload-modal-btn.primary {
      background: transparent;
      color: var(--text-accent);
      border: 1px solid transparent;
    }    .upload-modal-btn.secondary {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid transparent;
    }
    
    /* Progress Bar Component */
    #progressBarContainer {
      position: fixed;
      top: 0;      left: 0;
      width: 100%;
      background-color: var(--bg-primary);
      padding: 8px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.7);
      display: none;
      z-index: 9999;
    }
    #progressBar {
      width: 80%;      margin: 0 auto;
      height: 20px;
      background-color: var(--text-accent);
      background-image: linear-gradient(
        45deg,
        rgba(13, 11, 20, 0.25) 25%,
        transparent 25%,
        transparent 50%,
        rgba(13, 11, 20, 0.25) 50%,
        rgba(13, 11, 20, 0.25) 75%,
        transparent 75%,
        transparent
      );
      background-size: 40px 40px;
      border-radius: 5px;
      text-align: center;      line-height: 20px;
      color: var(--bg-primary);
      font-weight: bold;
      animation: progressBarAnimation 2s linear infinite;
      transition: width 0.3s ease-in-out;
    }
    @keyframes progressBarAnimation {
      0% { background-position: 40px 0; }
      100% { background-position: 0 0; }
    }    /* Top Controls */
    .top-right-controls {
      position: fixed;
      top: 20px;
      left: 80px;  /* Position just to the right of 60px sidebar */
      z-index: 1000;
      display: flex;
      gap: 16px;  /* Increased gap for better spacing */
      align-items: center;
    }

    .control-btn {
      background: var(--bg-tertiary);
      color: var(--text-accent);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px 16px;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px var(--shadow-light);
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .control-btn:hover {
      background: var(--text-accent);
      color: var(--button-text-selected);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--button-shadow);
    }

    .control-btn.active {
      background: var(--text-accent);
      color: var(--button-text-selected);
    }#agent-action-button {
      background-color: var(--text-accent);
      color: var(--bg-primary);
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }    #agent-action-button:hover {
      background-color: var(--button-hover-bg);
    }      /* Consolidated Button States */
    button:not(.delete-btn), .upload-modal-btn, .file-history-tab, .banks-tab, .control-btn, #agent-action-button {      background: transparent;
      border: 1px solid transparent;
      color: var(--text-accent);
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s, box-shadow 0.2s, border-color 0.2s;
      outline: none;
      box-shadow: none;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      vertical-align: middle;
    }
    .file-history-tab, .banks-tab {
      padding: 8px 22px 8px 18px;
    }
    .control-btn, #agent-action-button {
      padding: 10px 16px;
    }
    .upload-modal-btn {
      padding: 10px 20px;
    }      /* Button Hover States */
    button:not(.delete-btn):not(.active):not(:disabled):hover,
    .upload-modal-btn:not(.active):not(:disabled):hover,
    .file-history-tab:not(.active):not(:disabled):hover,
    .banks-tab:not(.active):not(:disabled):hover,
    .control-btn:not(.active):not(:disabled):hover,
    #agent-action-button:not(.active):not(:disabled):hover {
      background-color: transparent;
      color: var(--text-accent);
      border-color: transparent;
      box-shadow: 0 0 8px var(--text-accent);
    }      /* === ANIMATED GRADIENT EFFECTS === */
    button:not(.delete-btn), .upload-modal-btn, .file-history-tab, .banks-tab, .control-btn, #agent-action-button, .timeframe-controls button {
      position: relative;
      overflow: hidden;
      --mouse-x: 50%;
      --mouse-y: 50%;
    }
    
    button:not(.delete-btn)::before, .upload-modal-btn::before, .file-history-tab::before, .banks-tab::before, .control-btn::before, #agent-action-button::before, .timeframe-controls button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(
        circle at var(--mouse-x) var(--mouse-y),
        var(--button-hover-gradient-center) 0%,
        var(--button-hover-gradient-mid) 30%,
        transparent 60%
      );
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: inherit;
      z-index: 1;
      pointer-events: none;
    }
      button:not(.delete-btn):hover::before, .upload-modal-btn:hover::before, .file-history-tab:hover::before, .banks-tab:hover::before, .control-btn:hover::before, #agent-action-button:hover::before, .timeframe-controls button:hover::before {
      opacity: 1;
    }
    
    button:not(.delete-btn) span, .upload-modal-btn span, .file-history-tab span, .banks-tab span, .control-btn span, #agent-action-button span, .timeframe-controls button span {
      position: relative;
      z-index: 2;
    }
    
    button:not(.delete-btn).active, .upload-modal-btn.active, .file-history-tab.active, .banks-tab.active, .control-btn.active, #agent-action-button.active, .timeframe-controls button.active {
      background: linear-gradient(135deg, var(--button-gradient-start), var(--button-gradient-end));
      color: var(--button-text-selected);
      border-color: var(--text-accent);
      box-shadow: 0 4px 15px var(--button-shadow);
    }
    
    button:not(.delete-btn).active::before, .upload-modal-btn.active::before, .file-history-tab.active::before, .banks-tab.active::before, .control-btn.active::before, #agent-action-button.active::before, .timeframe-controls button.active::before {
      background: radial-gradient(
        circle at var(--mouse-x) var(--mouse-y),
        var(--button-active-gradient-center) 0%,
        var(--button-active-gradient-mid) 30%,
        transparent 60%
      );
      opacity: 0.7;
    }
      button:not(.delete-btn).active:hover::before, .upload-modal-btn.active:hover::before, .file-history-tab.active:hover::before, .banks-tab.active:hover::before, .control-btn.active:hover::before, #agent-action-button.active:hover::before, .timeframe-controls button.active:hover::before {
      opacity: 1;    }      /* Button Active States */    button:not(.delete-btn).active, button:not(.delete-btn):active,
    .upload-modal-btn.active, .upload-modal-btn:active,
    .file-history-tab.active, .file-history-tab:active,
    .banks-tab.active, .banks-tab:active,
    .control-btn.active, .control-btn:active,
    #agent-action-button.active, #agent-action-button:active {
      background: linear-gradient(135deg, var(--button-gradient-start), var(--button-gradient-end));
      color: var(--button-text-selected);
      border-color: var(--text-accent);
      box-shadow: 0 4px 15px var(--button-shadow);
    }    /* Text visibility fix for active/selected buttons during hover */
    button:not(.delete-btn).active:hover,
    button:not(.delete-btn):active:hover,
    .upload-modal-btn.active:hover,
    .upload-modal-btn:active:hover,
    .file-history-tab.active:hover,
    .file-history-tab:active:hover,
    .banks-tab.active:hover,
    .banks-tab:active:hover,
    .control-btn.active:hover,
    .control-btn:active:hover,
    #agent-action-button.active:hover,
    #agent-action-button:active:hover {
      color: var(--button-text-selected) !important;
      position: relative;
      z-index: 2;
    }

    /* Text visibility fix for chart buttons with data attributes */
    button[data-chart].active:hover,
    button[data-range].active:hover,
    .timeframe-controls button.active:hover {
      color: var(--button-text-selected) !important;
      position: relative;
      z-index: 2;
    }
      /* Button Disabled States */
    button:not(.delete-btn):disabled,
    .upload-modal-btn:disabled,
    .file-history-tab:disabled,
    .banks-tab:disabled,
    .control-btn:disabled,
    #agent-action-button:disabled {
      color: #4F4B68;
      background-color: #211D30;
      border-color: #4F4B68;
      cursor: not-allowed;
      box-shadow: none;
    }    /* Category Chart Dropdown Positioning */
    .category-chart-container {
      position: relative;
    }
      .category-chart-header {
      position: relative;
      margin-bottom: 5px;
    }    .category-chart-header h2 {
      margin: 0 0 20px 0;
      text-align: center;
      color: var(--text-accent);
      font-weight: 600;
      font-size: 1.2em;
    }
    #categoryMonthSelector {
      position: absolute;
      top: 0;
      right: 0;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 6px 12px;
      color: var(--text-primary);
      font-size: 0.9em;
      min-width: 140px;
      transition: all 0.3s ease;
    }
    
    #categoryMonthSelector:focus {
      outline: none;
      border-color: var(--text-accent);
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }

    /* SVG icons for delete buttons */
    .delete-btn svg {
      width: 14px;
      height: 14px;
      position: relative;
      z-index: 2;
      pointer-events: none;
    }
    
    .delete-btn .trash-icon {
      fill: currentColor;
    }

    /* Budget Management Styles */
    .budget-management-container {
      margin-bottom: 24px;
    }

    .budget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .budget-header h2 {
      margin: 0;
      color: var(--text-accent);
      font-weight: 600;
      font-size: 1.4em;
    }

    .budget-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    #budgetMonthSelector {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-size: 0.9em;
      min-width: 140px;
      transition: all 0.3s ease;
    }

    #budgetMonthSelector:focus {
      outline: none;
      border-color: var(--text-accent);
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }

    .budget-action-btn {
      background: var(--text-accent);
      color: var(--button-text-selected);
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9em;
    }

    .budget-action-btn:hover {
      background: var(--button-hover-bg);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--button-shadow);
    }

    .budget-action-btn.secondary {
      background: transparent;
      color: var(--text-accent);
      border: 1px solid var(--text-accent);
    }

    .budget-action-btn.secondary:hover {
      background: var(--text-accent);
      color: var(--button-text-selected);
    }

    .budget-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .budget-summary-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .budget-summary-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px var(--shadow-medium);
    }

    .budget-summary-label {
      font-size: 0.85em;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }    .budget-summary-amount {
      font-size: 1.5em;
      font-weight: 600;
      color: var(--text-primary);
    }    /* Editable budget input that looks like the original div */
    .budget-summary-amount.editable-budget {
      background: transparent;
      border: none;
      outline: none;
      text-align: center;
      width: 100%;
      padding: 0;
      margin: 0;
      cursor: pointer;
    }

    .budget-summary-amount.editable-budget:hover {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 4px 8px;
      cursor: text;
    }

    .budget-summary-amount.editable-budget:focus {
      background: var(--bg-primary);
      border: 1px solid var(--text-accent);
      border-radius: 4px;
      padding: 4px 8px;
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
      cursor: text;
    }    /* Add subtle visual hint that the field is editable */
    .budget-summary-card:hover .budget-summary-amount.editable-budget {
      position: relative;
    }

    .budget-summary-card:hover .budget-summary-amount.editable-budget::after {
      content: "✎";
      position: absolute;
      top: -5px;
      right: -15px;
      font-size: 0.7em;
      color: var(--text-accent);
      opacity: 0.6;
    }

    /* Hide number input arrows */
    .budget-summary-amount.editable-budget::-webkit-outer-spin-button,
    .budget-summary-amount.editable-budget::-webkit-inner-spin-button {
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
    }

    .budget-summary-amount.editable-budget {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .budget-summary-amount.over-budget {
      color: var(--priority-high);
    }

    .budget-summary-amount.on-track {
      color: var(--text-accent);
    }

    .budget-progress-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .budget-progress-bar {
      flex: 1;
      height: 8px;
      background: var(--bg-secondary);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .budget-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--text-accent), var(--button-gradient-end));
      border-radius: 4px;
      transition: width 0.5s ease;
      width: 0%;
    }

    .budget-progress-fill.over-budget {
      background: linear-gradient(90deg, var(--priority-high), #ff4757);
    }

    .budget-progress-fill.warning {
      background: linear-gradient(90deg, var(--priority-medium), #ffa726);
    }

    .budget-progress-text {
      font-size: 0.85em;
      font-weight: 600;
      color: var(--text-secondary);
      min-width: 35px;
    }

    .budget-categories {
      display: grid;
      gap: 16px;
    }

    .budget-category-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .budget-category-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px var(--shadow-medium);
    }

    .budget-category-card.over-budget {
      border-color: var(--priority-high);
      background: linear-gradient(135deg, var(--bg-tertiary), rgba(244, 67, 54, 0.05));
    }

    .budget-category-card.warning {
      border-color: var(--priority-medium);
      background: linear-gradient(135deg, var(--bg-tertiary), rgba(255, 193, 7, 0.05));
    }

    .budget-category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .budget-category-name {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .budget-category-icon {
      width: 20px;
      height: 20px;
      stroke: var(--text-accent);
      stroke-width: 2;
      fill: none;
    }

    .budget-category-status {
      font-size: 0.8em;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
    }

    .budget-category-status.on-track {
      background: rgba(76, 175, 80, 0.1);
      color: var(--priority-low);
    }

    .budget-category-status.warning {
      background: rgba(255, 193, 7, 0.1);
      color: var(--priority-medium);
    }

    .budget-category-status.over-budget {
      background: rgba(244, 67, 54, 0.1);
      color: var(--priority-high);
    }

    .budget-category-amounts {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .budget-amount-item {
      text-align: center;
    }

    .budget-amount-label {
      font-size: 0.75em;
      color: var(--text-secondary);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .budget-amount-value {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--text-primary);
    }

    .budget-amount-value.over-budget {
      color: var(--priority-high);
    }

    .budget-category-progress {
      margin-bottom: 12px;
    }

    .budget-category-progress .budget-progress-bar {
      height: 10px;
      margin-bottom: 8px;
    }

    .budget-insights {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85em;
      color: var(--text-secondary);
    }

    .budget-trend {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .budget-trend-icon {
      width: 14px;
      height: 14px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }

    .budget-trend.positive {
      color: var(--priority-low);
    }

    .budget-trend.negative {
      color: var(--priority-high);
    }

    /* Budget Modal Styles */
    .budget-modal-content {
      max-width: 600px;
      width: 90%;
    }

    .budget-modal-body {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .budget-month-display {
      text-align: center;
      font-size: 1.1em;
      font-weight: 600;
      color: var(--text-accent);
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
    }

    .budget-inputs-container {
      display: grid;
      gap: 16px;
    }

    .budget-input-row {
      display: grid;
      grid-template-columns: 1fr 120px;
      gap: 16px;
      align-items: center;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .budget-input-label {
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .budget-input-field {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-size: 0.9em;
      text-align: right;
      transition: all 0.3s ease;
    }

    .budget-input-field:focus {
      outline: none;
      border-color: var(--text-accent);
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }

    .budget-quick-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .budget-quick-btn {
      background: var(--bg-tertiary);
      color: var(--text-accent);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .budget-quick-btn:hover {
      background: var(--text-accent);
      color: var(--button-text-selected);
      transform: translateY(-1px);
    }

    .budget-quick-btn.secondary {
      color: var(--text-secondary);
    }

    .budget-quick-btn.secondary:hover {
      background: var(--priority-high);
      color: white;
      border-color: var(--priority-high);
    }

    @media (max-width: 768px) {
      .budget-header {
        flex-direction: column;
        align-items: stretch;
      }

      .budget-controls {
        justify-content: center;
      }

      .budget-overview {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .budget-category-amounts {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .budget-input-row {
        grid-template-columns: 1fr;
        gap: 8px;
        text-align: center;
      }
    .budget-quick-actions {
        flex-direction: column;
      }
    }

    /* Collapsible Budget Tracker Styles */
    .collapsible-header {
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .collapsible-header:hover {
      color: var(--text-accent);
    }

    .collapse-arrow {
      font-size: 16px;
      font-weight: bold;
      transition: transform 0.3s ease;
      color: var(--text-accent);
    }

    .collapse-arrow.collapsed {
      transform: rotate(-90deg);
    }

    .budget-content {
      transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
      overflow: hidden;
      max-height: 1000px;
      opacity: 1;
    }

    .budget-content.collapsed {
      max-height: 0;
      opacity: 0;
      margin: 0;
      padding: 0;
    }
  </style>

  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- ―――---- added helper libraries ----――― -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script> <!-- Chart.js UMD bundle :contentReference[oaicite:1]{index=1} -->
  <!-- ADDED: Date Adapter for Chart.js Time Scale -->
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script> <!-- date-fns library -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script> <!-- date-fns adapter -->  <script src="config.js"></script>
  <!-- Ensure config.js is loaded before any other scripts that use GEMINI_API_KEY -->
  <script src="theme.js"></script>
</head>
<body>  <div class="sidebar">
    <div class="sidebar-nav">
      <a href="Landing Page.html" title="Home">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 10L12 3l9 7v11a1 1 0 0 1-1 1h-6v-7h-4v7H4a1 1 0 0 1-1-1V10z"/>
        </svg>
      </a>
      <a href="Personal Finance Tracker.html" title="Finance Tracker">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <polyline points="3 17 8 12 13 16 21 4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
      <a href="Productivity Tracker.html" title="Productivity Tracker">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="9"/>
          <polyline points="12 7 12 12 15 15" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>
    
    <!-- Theme Toggle Button -->
    <button id="themeToggle" title="Toggle Dark/Light Mode" class="theme-toggle">
      <svg viewBox="0 0 24 24" class="sun-icon">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
      <svg viewBox="0 0 24 24" class="moon-icon" style="display: none;">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
    </button>
  </div>  <!-- New: Top Right Controls Button -->
  <div class="top-right-controls">
    <button id="banksTab" class="control-btn">Banks</button>
    <button id="openPdfUploadModalBtn" class="control-btn">Upload PDF</button>
    <button id="fileHistoryTab" class="control-btn">File History</button>
    <button id="agent-action-button" class="control-btn">Generate Presentation</button>
  </div>
  <div class="content">
    <h1>Personal Finance Tracker</h1>
    <!-- Modified: This input will now trigger the modal. We'll hide its default appearance. -->
    <input id="pdfPicker" type="file" accept=".pdf" multiple style="display: none;">

    <div id="total"></div>

    <!-- New PDF Upload Modal -->
    <div id="pdfUploadModal" class="upload-modal">
      <div class="upload-modal-content">
        <div class="upload-modal-header">
          <h2>Upload PDF Statements</h2>
          <button id="closeUploadModalBtn" class="upload-modal-close-btn">&times;</button>
        </div>
        
        <label for="modalPdfInput" class="upload-area" id="uploadAreaLabel">
          <div class="upload-area-icon">&#x21E7;</div> <!-- Unicode UPWARDS ARROW -->
          <div class="upload-area-text">Drag & drop files or click to choose files</div>
          <div class="upload-area-subtext">Supported file types: PDF</div>
        </label>
        <input id="modalPdfInput" type="file" accept=".pdf" multiple>
        <div id="selectedFilesList">
          <!-- Selected files will be listed here -->
        </div>

        <div class="upload-modal-footer">          <button id="cancelUploadBtn" class="upload-modal-btn secondary"><span>Cancel</span></button>
          <button id="confirmUploadBtn" class="upload-modal-btn primary"><span>Upload</span></button>
        </div>
      </div>
    </div>    <!-- End New PDF Upload Modal -->

    <!-- New Budget Management Section (Moved to top and made collapsible) -->
    <div class="budget-management-container card">
      <div class="budget-header collapsible-header" onclick="toggleBudgetCollapse()">
        <h2>Monthly Budget Tracker</h2>
        <span class="collapse-arrow" id="budgetCollapseArrow">▼</span>
        <div class="budget-controls">
          <select id="budgetMonthSelector">
            <option value="">Select Month</option>
          </select>
          <button id="resetBudgetBtn" class="budget-action-btn secondary">Reset Month</button>
        </div>
      </div>
      
      <div class="budget-content" id="budgetContent">
        <div class="budget-overview">        
          <div class="budget-summary-card">
            <div class="budget-summary-label">Total Budget</div>
            <input type="number" class="budget-summary-amount editable-budget" id="totalBudgetAmount" value="0.00" min="0" step="0.01" placeholder="0.00">
          </div>
          <div class="budget-summary-card">
            <div class="budget-summary-label">Total Spent</div>
            <div class="budget-summary-amount" id="totalSpentAmount">$0.00</div>
          </div>
          <div class="budget-summary-card">
            <div class="budget-summary-label">Remaining</div>
            <div class="budget-summary-amount" id="totalRemainingAmount">$0.00</div>
          </div>
          <div class="budget-summary-card">
            <div class="budget-summary-label">Progress</div>
            <div class="budget-progress-wrapper">
              <div class="budget-progress-bar">
                <div class="budget-progress-fill" id="totalBudgetProgress"></div>
              </div>
              <span class="budget-progress-text" id="totalBudgetProgressText">0%</span>
            </div>
          </div>
        </div>

        <div class="budget-categories" id="budgetCategoriesContainer">
          <!-- Categories will be populated here -->
        </div>
      </div>
    </div>

    <!-- Row container for side-by-side charts -->
    <div class="charts-row-container">
      <div class="chart-container card">
        <h2>Expenses</h2> <!-- Changed from Charges vs Payments, removed inline style -->
        <div class="timeframe-controls">
          <button data-chart="expenses" data-range="day">Day</button>
          <button data-chart="expenses" data-range="week">Week</button>
          <button data-chart="expenses" data-range="month" class="active">Month</button>
          <button data-chart="expenses" data-range="year">Year</button>
        </div>
        <div class="charges-payments-chart-inner-container"> <!-- NEW WRAPPER -->
          <canvas id="spendChart"></canvas>
        </div>
      </div>      <div class="category-chart-container card"> <!-- Ensured .card class is present -->
        <div class="category-chart-header">
          <h2>Spending Categories</h2>
          <select id="categoryMonthSelector"></select>
        </div>
        <div class="category-chart-inner-container">
          <canvas id="categorySpendChart"></canvas>
        </div>
      </div>
    </div>

    <!-- New Recent Transactions Widget -->
    <div class="recent-transactions-container card">
      <h2>Recent Transactions</h2>
      <div class="recent-transactions-table-container">
        <table class="recent-transactions-table">
          <thead>
            <!-- Headers will be populated by JS or can be static if known -->
          </thead>
          <tbody id="recentTransactionsBody">
            <!-- Transactions will be populated here by JavaScript -->
          </tbody>
        </table>
      </div>    </div>

    <!-- Budget Setting Modal -->
    <div id="budgetModal" class="upload-modal">
      <div class="upload-modal-content budget-modal-content">
        <div class="upload-modal-header">
          <h2>Set Monthly Budgets</h2>
          <button id="closeBudgetModalBtn" class="upload-modal-close-btn">&times;</button>
        </div>
        <div class="budget-modal-body">
          <div class="budget-month-display">
            <span id="budgetModalMonth">Current Month</span>
          </div>
          <div class="budget-inputs-container" id="budgetInputsContainer">
            <!-- Budget inputs will be populated here -->
          </div>
          <div class="budget-quick-actions">
            <button id="setBudgetFromLastMonthBtn" class="budget-quick-btn">Copy from Last Month</button>
            <button id="setBudgetFromAverageBtn" class="budget-quick-btn">Set from 3-Month Average</button>
            <button id="clearAllBudgetsBtn" class="budget-quick-btn secondary">Clear All</button>
          </div>
        </div>
        <div class="upload-modal-footer">
          <button id="cancelBudgetBtn" class="upload-modal-btn secondary">Cancel</button>
          <button id="saveBudgetBtn" class="upload-modal-btn primary">Save Budgets</button>
        </div>
      </div>
    </div>

    <div id="fileHistoryPanel" class="file-history-panel">
      <h3>Uploaded Files</h3>
      <ul id="fileHistoryList" class="file-history-list"></ul>
    </div>    <!-- New Banks Panel (initially hidden) -->
    <div id="banksPanel" class="file-history-panel" style="display:none; position:absolute; top:54px; left:200px;">
      <h3>Banks</h3>
      <ul id="banksList" class="file-history-list">
        <li style="color:var(--text-secondary);">No banks added yet.</li>
      </ul>
      <div style="text-align:right; margin-top:12px;">
        <button id="importBanksBtn" class="upload-modal-btn primary"><span>Import</span></button>
      </div>
    </div>

    <div id="progressBarContainer">
      <div id="progressBar">Processing...</div>
    </div>    <script>
      // Toggle Budget Collapse Function
      function toggleBudgetCollapse() {
        const budgetContent = document.getElementById('budgetContent');
        const arrow = document.getElementById('budgetCollapseArrow');
        
        if (budgetContent && arrow) {
          budgetContent.classList.toggle('collapsed');
          arrow.classList.toggle('collapsed');
          
          // Update arrow text
          if (budgetContent.classList.contains('collapsed')) {
            arrow.textContent = '▶';
          } else {
            arrow.textContent = '▼';
          }
        }
      }

      // Helper to extract month/year from filename
      function extractMonthYearFromName(name) {
        if (typeof name !== 'string') return null;
        const trimmedName = name.trim();

        const monthMap = {
          jan: 1, january: 1, feb: 2, february: 2, mar: 3, march: 3, apr: 4, april: 4,
          may: 5, jun: 6, june: 6, jul: 7, july: 7, aug: 8, august: 8, sep: 9, september: 9,
          oct: 10, october: 10, nov: 11, november: 11, dec: 12, december: 12
        };
        const monthPattern = '(January|Jan|February|Feb|March|Mar|April|Apr|May|June|Jun|July|Jul|August|Aug|September|Sep|Oct|October|November|Nov|December|Dec)';

        const textualMatchMonthYear = trimmedName.match(new RegExp(monthPattern + '\\s+(\\d{4})', 'i'));

        if (textualMatchMonthYear && textualMatchMonthYear[1] && textualMatchMonthYear[2]) {
          const monthName = textualMatchMonthYear[1].toLowerCase();
          const year = parseInt(textualMatchMonthYear[2], 10);
          const month = monthMap[monthName];
          if (month && year >= 1900 && year <= 2100) { // Added year range check
            return { year, month };
          }
        }

        // Fallback: Try to match "YYYY Month" (less common for user's stated format)
        const textualMatchYearMonth = trimmedName.match(new RegExp('(\\d{4})\\s+' + monthPattern, 'i'));
         if (textualMatchYearMonth && textualMatchYearMonth[1] && textualMatchYearMonth[2]) {
          const year = parseInt(textualMatchYearMonth[1], 10);
          const monthName = textualMatchYearMonth[2].toLowerCase();
          const month = monthMap[monthName];
          if (month && year >= 1900 && year <= 2100) {
            return { year, month };
          }
        }

        // Fallback to numeric month and year (e.g., "2025-03", "2025_3")
        const numericDateMatch = trimmedName.match(/(\\d{4})[-_]?([0-1]?[0-9])/);
        if (numericDateMatch && numericDateMatch[1] && numericDateMatch[2]) {
          const year = parseInt(numericDateMatch[1], 10);
          const month = parseInt(numericDateMatch[2], 10);
          if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12) {
            return { year, month };
          }
        }
        console.warn('Could not extract month/year from filename:', name); // Added warning
        return null;
      }
      let chart = null;
      
      let dailyActivity = {}; // New: {"YYYY-MM-DD": {charges: 0, payments: 0, dcIncome: 0, categories: {"Groceries": 0,...}}}
      let globalAllTransactions = []; // New: To store all individual transactions

      let categoryChart = null;
      const CATEGORIES = ["Groceries", "Food Delivery/Restaurant", "Gas", "Misc"];

      // --- New: N8N Webhook URL ---
      const N8N_WEBHOOK_URL = "https://criticalvuln.app.n8n.cloud/webhook-test/f597b035-7b41-496a-8e8e-f3102a67508a"; // <<< REPLACE WITH YOUR ACTUAL N8N WEBHOOK URL

      // --- New: Net Worth (Income) Chart Global ---
      let netWorthChartInstance = null;
      let sharedChartTimeframe = 'month'; // New: Shared timeframe for Expenses and Net Worth charts

      // API Key will now be loaded from config.js
      const GEMINI_API_KEY = window.APP_CONFIG && window.APP_CONFIG.GEMINI_API_KEY;

      // --- File History State ---
      let fileHistory = JSON.parse(localStorage.getItem('financeFileHistory') || '[]');
      let fileDataKeysMap = JSON.parse(localStorage.getItem('financeFileDataKeysMap') || '{}'); // New: {"filename": ["YYYY-MM-DD", ...]}
      let globalAllTransactionsStorageKey = 'financeGlobalAllTransactions'; // New

      // --- Budget Management State ---
      let budgetData = JSON.parse(localStorage.getItem('financeBudgetData') || '{}'); // Format: {"YYYY-MM": {"Groceries": 500, "Gas": 200, ...}}

      const progressBarContainer = document.getElementById('progressBarContainer');
      const progressBar = document.getElementById('progressBar');
      // const originalStatusElement = document.getElementById('yourStatusMessageElementId'); // Optional: Replace ID

      function showProcessingBar(message = "Processing file...") {
   
        if (progressBarContainer && progressBar) {
          progressBar.textContent = message;
          progressBarContainer.style.display = 'block';
        }
      }

      function hideProcessingBar() {
        if (progressBarContainer) {
          progressBarContainer.style.display = 'none';
        }
       
      }
    
      function setupTimeframeControls() {
        const timeframeButtons = document.querySelectorAll('.timeframe-controls button[data-range]');

        timeframeButtons.forEach(button => {
          button.addEventListener('click', (event) => {
            const clickedButton = event.target;
            // Ensure the clicked element is a button with data-range
            if (!clickedButton.matches('button[data-range]')) return;

            const newTimeframe = clickedButton.dataset.range;
            
            // Update the shared timeframe state
            sharedChartTimeframe = newTimeframe;

            // Update 'active' class on ALL timeframe buttons
            document.querySelectorAll('.timeframe-controls button[data-range]').forEach(btn => {
              btn.classList.remove('active');
              if (btn.dataset.range === newTimeframe) {
                btn.classList.add('active');
              }
            });

            // Re-render both charts with the new timeframe
            if (typeof renderSpendChart === 'function') {
              renderSpendChart(sharedChartTimeframe);
            }
            if (typeof renderNetWorthChart === 'function') {
              renderNetWorthChart(sharedChartTimeframe);
            }
          });
        });
      }
      // --- End Synchronized Timeframe Controls Setup ---

      function saveFileDataKeysMap() { // New name
        localStorage.setItem('financeFileDataKeysMap', JSON.stringify(fileDataKeysMap));
      }

      // --- File History UI Logic ---
      const fileHistoryTab = document.getElementById('fileHistoryTab');
      const fileHistoryPanel = document.getElementById('fileHistoryPanel');
      const fileHistoryList = document.getElementById('fileHistoryList');

      function renderFileHistory() {
        // Guard against missing element
        if (!fileHistoryList) return;
        fileHistoryList.innerHTML = '';
        if (!fileHistory.length) {
          fileHistoryList.innerHTML = '<li style="color:#A0A0A0;">No files uploaded yet.</li>';
          return;
        }

        // Sort fileHistory by date (year, then month), then by name for undated files
        fileHistory.sort((a, b) => {
          const dateA = extractMonthYearFromName(a.name);
          const dateB = extractMonthYearFromName(b.name);

          if (dateA && dateB) {
            if (dateA.year !== dateB.year) {
              return dateA.year - dateB.year; // Sort by year ascending
            }
            return dateA.month - dateB.month; // Then by month ascending
          } else if (dateA) {
            return -1; // dateA (has date) comes before dateB (no date)
          } else if (dateB) {
            return 1;  // dateB (has date) comes before dateA (no date)
          } else {
            // Neither has a parseable date, sort by name alphabetically
            return a.name.localeCompare(b.name);
          }
        });

        fileHistory.forEach(f => {
          const li = document.createElement('li');
          const nameSpan = document.createElement('span');
          nameSpan.className = 'filename';
          nameSpan.textContent = f.name;          const delBtn = document.createElement('button');
          delBtn.className = 'delete-btn';
          delBtn.innerHTML = `
            <svg viewBox="0 0 24 24" class="trash-icon">
              <path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-4.5l-1-1z"/>
            </svg>`;
          delBtn.title = 'Delete';
          delBtn.onclick = (event) => { // Add event parameter
            event.stopPropagation(); // Stop the click from bubbling to the document
            deleteFileHistory(f.name);
          };          li.appendChild(nameSpan);
          li.appendChild(delBtn);
          fileHistoryList.appendChild(li);
        });
        
        // Setup animations for newly created delete buttons
        setupDeleteButtonAnimations();
      }

      function showFileHistory(show) {
        // Guard against missing elements
        if (!fileHistoryPanel || !fileHistoryTab) return;
         if (show) {
           fileHistoryPanel.style.display = 'block';
           fileHistoryTab.classList.add('active');
           renderFileHistory();
         } else {
           fileHistoryPanel.style.display = 'none';
           fileHistoryTab.classList.remove('active');
         }
      }
      if (fileHistoryTab) {
        fileHistoryTab.addEventListener('click', () => {
          showFileHistory(fileHistoryPanel.style.display !== 'block');
        });
      }
      if (fileHistoryPanel) {
        document.addEventListener('click', e => {
          if (!fileHistoryPanel.contains(e.target) && e.target !== fileHistoryTab) {
            showFileHistory(false);
          }
        });
      }

      function addFileToHistory(name, keys) { // keys are now YYYY-MM-DD
        if (!fileHistory.some(f => f.name === name)) {
          fileHistory.push({ name });
          localStorage.setItem('financeFileHistory', JSON.stringify(fileHistory));
        }
        if (Array.isArray(keys) && keys.length) {
          fileDataKeysMap[name] = keys; // Store daily keys
          saveFileDataKeysMap();
        }
      }
      function deleteFileHistory(name) {
        // Remove from fileHistory
        fileHistory = fileHistory.filter(f => f.name !== name);
        localStorage.setItem('financeFileHistory', JSON.stringify(fileHistory));
        // Remove all data from this file from the charts
        removeFileData(name); // Uses daily keys now
        // Remove mapping
        delete fileDataKeysMap[name];
        saveFileDataKeysMap();
        renderFileHistory();
        // updateDisplay(); // Will be called by updateAndSaveData
        updateAndSaveData();
      }

      // --- New: Helper function to rebuild dailyActivity from globalAllTransactions for specific dates ---
      function rebuildDailyActivityForDates(dateKeysToRebuild) {
        const dates = Array.isArray(dateKeysToRebuild) ? dateKeysToRebuild : Array.from(dateKeysToRebuild);

        dates.forEach(dateKey => {
          // Initialize/clear the specific day's activity
          dailyActivity[dateKey] = { charges: 0, payments: 0, dcIncome: 0, categories: {} };
          CATEGORIES.forEach(cat => dailyActivity[dateKey].categories[cat] = 0); // Ensure all categories are initialized for summing up
        });

        globalAllTransactions.forEach(tx => {
          if (dates.includes(tx.date)) { // Process only if the transaction's date is one we're rebuilding
            const dateKey = tx.date;
            const amount = parseFloat(tx.amount); // Amount is stored as parsed: positive for charge, negative for income/payment
            const isDCFile = tx.sourceFile.toUpperCase().startsWith("DC");

            if (!dailyActivity[dateKey]) { // Should not happen if initialized above, but as a safeguard
              dailyActivity[dateKey] = { charges: 0, payments: 0, dcIncome: 0, categories: {} };
              CATEGORIES.forEach(cat => dailyActivity[dateKey].categories[cat] = 0);
            }

            if (isDCFile) {
              if (amount < 0) { // DC income is stored as negative by parser, dcIncome in dailyActivity is positive
                dailyActivity[dateKey].dcIncome += Math.abs(amount);
              }            } else { // Not a DC file
              if (amount > 0) { // Charge
                dailyActivity[dateKey].charges += amount;
                let categoryToApply = "Misc"; // Default category
                if (tx.category && CATEGORIES.includes(tx.category)) {
                  categoryToApply = tx.category;
                }
                dailyActivity[dateKey].categories[categoryToApply] = (dailyActivity[dateKey].categories[categoryToApply] || 0) + amount;
              } else if (amount < 0) { // Payment
                dailyActivity[dateKey].payments += Math.abs(amount);
              }
            }
          }
        });

        // Clean up days that ended up with no activity after rebuild
        dates.forEach(dateKey => {
          const dayData = dailyActivity[dateKey];
          if (dayData) { // Check if dayData exists, as it might have been deleted by another process if code changes
            let isEmpty = dayData.charges === 0 && dayData.payments === 0 && dayData.dcIncome === 0;
            if (isEmpty) {
              let categoriesSum = 0;
              CATEGORIES.forEach(cat => categoriesSum += (dayData.categories[cat] || 0));
              if (categoriesSum === 0) {
                delete dailyActivity[dateKey];
              }
            }
          }
        });
      }

      function removeFileData(name) {
       
        const dailyKeysAffectedByThisFile = fileDataKeysMap[name] || [];

        // Remove transactions from globalAllTransactions associated with this file
        globalAllTransactions = globalAllTransactions.filter(tx => tx.sourceFile !== name);
        localStorage.setItem(globalAllTransactionsStorageKey, JSON.stringify(globalAllTransactions));

        // After removing transactions, rebuild dailyActivity for the dates this file affected
        if (dailyKeysAffectedByThisFile.length > 0) {
          rebuildDailyActivityForDates(dailyKeysAffectedByThisFile);
        }
          // fileDataKeysMap[name] will be deleted by deleteFileHistory function
        // Totals are recalculated in updateDisplay based on remaining dailyActivity
      }

      // --- On load, render file history ---
      renderFileHistory();
      showFileHistory(false);

      // Update totals display and chart
      function updateDisplay() {
        // Clear numeric summary
        document.getElementById('total').innerHTML = '';

        renderSpendChart(sharedChartTimeframe); // Use shared timeframe

        localStorage.setItem('financeDailyActivity', JSON.stringify(dailyActivity)); // New: Save all daily activity
        localStorage.setItem(globalAllTransactionsStorageKey, JSON.stringify(globalAllTransactions)); // New: Save all transactions

        // Update and render category chart
        populateCategoryMonthSelector();
        const selectedMonthForCategory = document.getElementById('categoryMonthSelector').value;
        renderCategoriesChart(selectedMonthForCategory);

        // Update and render Net Worth (Income) chart
        renderNetWorthChart(sharedChartTimeframe); // Use shared timeframe

        renderRecentTransactions(); // New: Render recent transactions
        
        // Update budget display if budget management is initialized
        if (typeof renderBudgetDisplay === 'function') {
          populateBudgetMonthSelector();
          renderBudgetDisplay();
        }
      }

      // --- Budget Management Functions ---
      function initializeBudgetManagement() {
        populateBudgetMonthSelector();
        setupBudgetEventListeners();
        renderBudgetDisplay();
      }

      function populateBudgetMonthSelector() {
        const selector = document.getElementById('budgetMonthSelector');
        const currentSelection = selector.value;
        selector.innerHTML = '<option value="">Select Month</option>';

        const availableMonths = new Set();
        
        // Add months from transaction data
        Object.keys(dailyActivity).forEach(dateKey => {
          availableMonths.add(dateKey.substring(0, 7)); // YYYY-MM
        });

        // Add current month if not present
        const now = new Date();
        const currentMonth = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
        availableMonths.add(currentMonth);

        // Add next month for planning
        const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        const nextMonthKey = `${nextMonth.getFullYear()}-${(nextMonth.getMonth() + 1).toString().padStart(2, '0')}`;
        availableMonths.add(nextMonthKey);

        const sortedMonths = Array.from(availableMonths).sort().reverse();

        sortedMonths.forEach(monthKey => {
          const option = document.createElement('option');
          option.value = monthKey;
          const [year, monthNum] = monthKey.split('-');
          const monthName = new Date(year, parseInt(monthNum) - 1, 1).toLocaleString('default', { month: 'long' });
          option.textContent = `${monthName} ${year}`;
          selector.appendChild(option);
        });

        // Set default to current month
        if (sortedMonths.includes(currentMonth)) {
          selector.value = currentMonth;
        } else if (sortedMonths.length > 0) {
          selector.value = sortedMonths[0];
        }        if (currentSelection && sortedMonths.includes(currentSelection)) {
          selector.value = currentSelection;
        }
      }

      function setupBudgetEventListeners() {
        const budgetMonthSelector = document.getElementById('budgetMonthSelector');
        const resetBudgetBtn = document.getElementById('resetBudgetBtn');
        const totalBudgetInput = document.getElementById('totalBudgetAmount');

        if (budgetMonthSelector) {
          budgetMonthSelector.addEventListener('change', renderBudgetDisplay);
        }

        if (resetBudgetBtn) {
          resetBudgetBtn.addEventListener('click', resetMonthBudget);
        }        // Add event listener for the editable total budget input
        if (totalBudgetInput) {
          totalBudgetInput.addEventListener('change', handleTotalBudgetChange);
          totalBudgetInput.addEventListener('blur', handleTotalBudgetChange);
        }

        // Budget Modal Event Listeners
        setupBudgetModalEvents();
      }

      // Function to handle manual total budget input
      function handleTotalBudgetChange() {
        const selectedMonth = document.getElementById('budgetMonthSelector').value;
        const totalBudgetInput = document.getElementById('totalBudgetAmount');
        
        if (!selectedMonth) {
          alert('Please select a month first.');
          totalBudgetInput.value = '0.00';
          return;
        }

        const totalBudgetValue = parseFloat(totalBudgetInput.value) || 0;
        
        // Initialize budget data for the month if it doesn't exist
        if (!budgetData[selectedMonth]) {
          budgetData[selectedMonth] = {};
        }

        // Distribute the total budget evenly across all categories that don't have budgets set
        // or store it as a total budget limit
        const currentBudgets = budgetData[selectedMonth];
        const categoriesWithBudgets = CATEGORIES.filter(cat => currentBudgets[cat] > 0);
        const categoriesWithoutBudgets = CATEGORIES.filter(cat => !currentBudgets[cat] || currentBudgets[cat] === 0);

        if (categoriesWithoutBudgets.length > 0 && totalBudgetValue > 0) {
          // Get current allocated budget for categories that already have budgets
          const allocatedBudget = categoriesWithBudgets.reduce((sum, cat) => sum + (currentBudgets[cat] || 0), 0);
          const remainingBudget = Math.max(0, totalBudgetValue - allocatedBudget);
          
          // Distribute remaining budget evenly among categories without budgets
          const budgetPerCategory = remainingBudget / categoriesWithoutBudgets.length;
          
          categoriesWithoutBudgets.forEach(category => {
            currentBudgets[category] = budgetPerCategory;
          });
        } else if (categoriesWithBudgets.length === 0 && totalBudgetValue > 0) {
          // No categories have budgets, distribute evenly across all
          const budgetPerCategory = totalBudgetValue / CATEGORIES.length;
          CATEGORIES.forEach(category => {
            currentBudgets[category] = budgetPerCategory;
          });
        }

        // Store as overall budget limit (for reference)
        currentBudgets._totalBudgetLimit = totalBudgetValue;

        // Save to localStorage
        localStorage.setItem('financeBudgetData', JSON.stringify(budgetData));
        
        // Refresh the display
        renderBudgetDisplay();
      }

      function setupBudgetModalEvents() {
        const budgetModal = document.getElementById('budgetModal');
        const closeBudgetModalBtn = document.getElementById('closeBudgetModalBtn');
        const cancelBudgetBtn = document.getElementById('cancelBudgetBtn');
        const saveBudgetBtn = document.getElementById('saveBudgetBtn');
        const setBudgetFromLastMonthBtn = document.getElementById('setBudgetFromLastMonthBtn');
        const setBudgetFromAverageBtn = document.getElementById('setBudgetFromAverageBtn');
        const clearAllBudgetsBtn = document.getElementById('clearAllBudgetsBtn');

        if (closeBudgetModalBtn) {
          closeBudgetModalBtn.addEventListener('click', () => {
            budgetModal.style.display = 'none';
          });
        }

        if (cancelBudgetBtn) {
          cancelBudgetBtn.addEventListener('click', () => {
            budgetModal.style.display = 'none';
          });
        }

        if (saveBudgetBtn) {
          saveBudgetBtn.addEventListener('click', saveBudgetSettings);
        }

        if (setBudgetFromLastMonthBtn) {
          setBudgetFromLastMonthBtn.addEventListener('click', setBudgetFromLastMonth);
        }

        if (setBudgetFromAverageBtn) {
          setBudgetFromAverageBtn.addEventListener('click', setBudgetFromAverage);
        }

        if (clearAllBudgetsBtn) {
          clearAllBudgetsBtn.addEventListener('click', clearAllBudgets);
        }

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
          if (event.target === budgetModal) {
            budgetModal.style.display = 'none';
          }
        });
      }

      function renderBudgetDisplay() {
        const selectedMonth = document.getElementById('budgetMonthSelector').value;
        if (!selectedMonth) {
          document.getElementById('budgetCategoriesContainer').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Please select a month to view budget information.</p>';
          updateBudgetSummary(null, null);
          return;
        }

        const monthBudgets = budgetData[selectedMonth] || {};
        const monthSpending = getMonthSpending(selectedMonth);

        updateBudgetSummary(monthBudgets, monthSpending);
        renderBudgetCategories(selectedMonth, monthBudgets, monthSpending);
      }

      function getMonthSpending(monthKey) {
        const spending = {};
        CATEGORIES.forEach(cat => spending[cat] = 0);

        Object.keys(dailyActivity).forEach(dateKey => {
          if (dateKey.startsWith(monthKey)) {
            const dayData = dailyActivity[dateKey];
            if (dayData && dayData.categories) {
              CATEGORIES.forEach(cat => {
                spending[cat] += dayData.categories[cat] || 0;
              });
            }
          }
        });

        return spending;
      }      function updateBudgetSummary(budgets, spending) {
        const totalBudgetEl = document.getElementById('totalBudgetAmount');
        const totalSpentEl = document.getElementById('totalSpentAmount');
        const totalRemainingEl = document.getElementById('totalRemainingAmount');
        const totalProgressEl = document.getElementById('totalBudgetProgress');
        const totalProgressTextEl = document.getElementById('totalBudgetProgressText');

        if (!budgets || !spending) {
          totalBudgetEl.value = '0.00';
          totalSpentEl.textContent = '$0.00';
          totalRemainingEl.textContent = '$0.00';
          totalProgressEl.style.width = '0%';
          totalProgressTextEl.textContent = '0%';
          totalBudgetEl.className = 'budget-summary-amount editable-budget';
          totalSpentEl.className = 'budget-summary-amount';
          totalRemainingEl.className = 'budget-summary-amount';
          return;
        }

        const totalBudget = Object.values(budgets).reduce((sum, budget) => sum + (budget || 0), 0);
        const totalSpent = Object.values(spending).reduce((sum, spent) => sum + (spent || 0), 0);
        const totalRemaining = totalBudget - totalSpent;
        const progressPercent = totalBudget > 0 ? Math.min((totalSpent / totalBudget) * 100, 100) : 0;

        totalBudgetEl.value = totalBudget.toFixed(2);
        totalSpentEl.textContent = `$${totalSpent.toFixed(2)}`;
        totalRemainingEl.textContent = `$${totalRemaining.toFixed(2)}`;
        totalProgressEl.style.width = `${progressPercent}%`;
        totalProgressTextEl.textContent = `${Math.round(progressPercent)}%`;

        // Apply status classes
        totalBudgetEl.className = 'budget-summary-amount editable-budget';
        totalSpentEl.className = 'budget-summary-amount';
        totalRemainingEl.className = 'budget-summary-amount';

        if (totalRemaining < 0) {
          totalRemainingEl.classList.add('over-budget');
          totalProgressEl.className = 'budget-progress-fill over-budget';
        } else if (progressPercent > 80) {
          totalProgressEl.className = 'budget-progress-fill warning';
        } else {
          totalRemainingEl.classList.add('on-track');
          totalProgressEl.className = 'budget-progress-fill';
        }
      }

      function renderBudgetCategories(monthKey, budgets, spending) {
        const container = document.getElementById('budgetCategoriesContainer');
        container.innerHTML = '';

        CATEGORIES.forEach(category => {
          const budget = budgets[category] || 0;
          const spent = spending[category] || 0;
          const remaining = budget - spent;
          const progressPercent = budget > 0 ? Math.min((spent / budget) * 100, 100) : 0;

          let statusClass = 'on-track';
          let statusText = 'On Track';
          
          if (budget === 0) {
            statusClass = 'no-budget';
            statusText = 'No Budget Set';
          } else if (remaining < 0) {
            statusClass = 'over-budget';
            statusText = 'Over Budget';
          } else if (progressPercent > 80) {
            statusClass = 'warning';
            statusText = 'Warning';
          }

          const categoryCard = document.createElement('div');
          categoryCard.className = `budget-category-card ${statusClass}`;
          
          categoryCard.innerHTML = `
            <div class="budget-category-header">
              <div class="budget-category-name">
                ${getCategoryIcon(category)}
                ${category}
              </div>
              <div class="budget-category-status ${statusClass}">${statusText}</div>
            </div>
            <div class="budget-category-amounts">
              <div class="budget-amount-item">
                <div class="budget-amount-label">Budget</div>
                <div class="budget-amount-value">$${budget.toFixed(2)}</div>
              </div>
              <div class="budget-amount-item">
                <div class="budget-amount-label">Spent</div>
                <div class="budget-amount-value ${statusClass === 'over-budget' ? 'over-budget' : ''}">$${spent.toFixed(2)}</div>
              </div>
              <div class="budget-amount-item">
                <div class="budget-amount-label">Remaining</div>
                <div class="budget-amount-value ${remaining < 0 ? 'over-budget' : ''}">$${remaining.toFixed(2)}</div>
              </div>
            </div>
            <div class="budget-category-progress">
              <div class="budget-progress-bar">
                <div class="budget-progress-fill ${statusClass === 'over-budget' ? 'over-budget' : statusClass === 'warning' ? 'warning' : ''}" style="width: ${progressPercent}%"></div>
              </div>
              <div class="budget-insights">
                <span>${budget > 0 ? Math.round(progressPercent) : 0}% of budget used</span>
                ${getTrendIndicator(category, monthKey)}
              </div>
            </div>
          `;

          container.appendChild(categoryCard);
        });
      }      function getCategoryIcon(category) {
        const icons = {
          'Groceries': '<svg class="budget-category-icon" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>',
          'Food Delivery/Restaurant': '<svg class="budget-category-icon" viewBox="0 0 24 24"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>',
          'Gas': '<svg class="budget-category-icon" viewBox="0 0 24 24"><path d="M19.77 7.23l.01-.01-3.72-3.72L15 4.56l2.11 2.11c-.94.36-1.61 1.26-1.61 2.33 0 1.38 1.12 2.5 2.5 2.5.36 0 .69-.08 1-.21v7.21c0 .55-.45 1-1 1s-1-.45-1-1V14c0-1.1-.9-2-2-2h-1V5c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2 2v16h10v-7.5h1.5v5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V9c0-.69-.28-1.32-.73-1.77z"/></svg>',
          'Misc': '<svg class="budget-category-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>'
        };
        return icons[category] || icons['Misc'];
      }

      function getTrendIndicator(category, currentMonth) {
        // Calculate trend compared to previous month
        const [year, month] = currentMonth.split('-');
        const prevMonth = new Date(year, month - 2, 1); // month - 2 because month is 1-indexed
        const prevMonthKey = `${prevMonth.getFullYear()}-${(prevMonth.getMonth() + 1).toString().padStart(2, '0')}`;
        
        const currentSpending = getMonthSpending(currentMonth)[category] || 0;
        const prevSpending = getMonthSpending(prevMonthKey)[category] || 0;
        
        if (prevSpending === 0) return '<span>No previous data</span>';
        
        const change = ((currentSpending - prevSpending) / prevSpending) * 100;
        
        if (Math.abs(change) < 5) {
          return '<div class="budget-trend"><svg class="budget-trend-icon" viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/></svg>Stable</div>';
        } else if (change > 0) {
          return `<div class="budget-trend negative"><svg class="budget-trend-icon" viewBox="0 0 24 24"><polyline points="18,15 12,9 6,15"/></svg>+${Math.round(change)}%</div>`;
        } else {
          return `<div class="budget-trend positive"><svg class="budget-trend-icon" viewBox="0 0 24 24"><polyline points="6,9 12,15 18,9"/></svg>${Math.round(change)}%</div>`;
        }
      }

      function openBudgetModal() {
        const selectedMonth = document.getElementById('budgetMonthSelector').value;
        if (!selectedMonth) {
          alert('Please select a month first.');
          return;
        }

        const modal = document.getElementById('budgetModal');
        const monthDisplay = document.getElementById('budgetModalMonth');
        const inputsContainer = document.getElementById('budgetInputsContainer');

        const [year, monthNum] = selectedMonth.split('-');
        const monthName = new Date(year, parseInt(monthNum) - 1, 1).toLocaleString('default', { month: 'long' });
        monthDisplay.textContent = `${monthName} ${year}`;

        // Populate input fields
        inputsContainer.innerHTML = '';
        const currentBudgets = budgetData[selectedMonth] || {};

        CATEGORIES.forEach(category => {
          const inputRow = document.createElement('div');
          inputRow.className = 'budget-input-row';
          inputRow.innerHTML = `
            <div class="budget-input-label">
              ${getCategoryIcon(category)}
              ${category}
            </div>
            <input type="number" class="budget-input-field" data-category="${category}" 
                   value="${currentBudgets[category] || ''}" placeholder="0.00" min="0" step="0.01">
          `;
          inputsContainer.appendChild(inputRow);
        });

        modal.style.display = 'flex';
      }

      function saveBudgetSettings() {
        const selectedMonth = document.getElementById('budgetMonthSelector').value;
        const inputs = document.querySelectorAll('.budget-input-field');

        if (!budgetData[selectedMonth]) {
          budgetData[selectedMonth] = {};
        }

        inputs.forEach(input => {
          const category = input.dataset.category;
          const value = parseFloat(input.value) || 0;
          budgetData[selectedMonth][category] = value;
        });

        // Save to localStorage
        localStorage.setItem('financeBudgetData', JSON.stringify(budgetData));

        // Close modal and refresh display
        document.getElementById('budgetModal').style.display = 'none';
        renderBudgetDisplay();
      }

      function setBudgetFromLastMonth() {
        const selectedMonth = document.getElementById('budgetMonthSelector').value;
        const [year, month] = selectedMonth.split('-');
        const prevMonth = new Date(year, month - 2, 1);
        const prevMonthKey = `${prevMonth.getFullYear()}-${(prevMonth.getMonth() + 1).toString().padStart(2, '0')}`;

        const prevBudgets = budgetData[prevMonthKey];
        if (!prevBudgets) {
          alert('No budget data found for previous month.');
          return;
        }

        const inputs = document.querySelectorAll('.budget-input-field');
        inputs.forEach(input => {
          const category = input.dataset.category;
          input.value = prevBudgets[category] || '';
        });
      }

      function setBudgetFromAverage() {
        const selectedMonth = document.getElementById('budgetMonthSelector').value;
        const [year, month] = selectedMonth.split('-');
        
        // Calculate average from last 3 months
        const averages = {};
        CATEGORIES.forEach(cat => averages[cat] = []);

        for (let i = 1; i <= 3; i++) {
          const date = new Date(year, month - 1 - i, 1);
          const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          const spending = getMonthSpending(monthKey);
          
          CATEGORIES.forEach(cat => {
            if (spending[cat] > 0) {
              averages[cat].push(spending[cat]);
            }
          });
        }

        const inputs = document.querySelectorAll('.budget-input-field');
        inputs.forEach(input => {
          const category = input.dataset.category;
          const values = averages[category];
          if (values.length > 0) {
            const average = values.reduce((sum, val) => sum + val, 0) / values.length;
            // Add 10% buffer to average
            input.value = (average * 1.1).toFixed(2);
          }
        });
      }

      function clearAllBudgets() {
        const inputs = document.querySelectorAll('.budget-input-field');
        inputs.forEach(input => {
          input.value = '';
        });
      }

      function resetMonthBudget() {
        const selectedMonth = document.getElementById('budgetMonthSelector').value;
        if (!selectedMonth) {
          alert('Please select a month first.');
          return;
        }

        if (confirm('Are you sure you want to reset all budgets for this month? This action cannot be undone.')) {
          delete budgetData[selectedMonth];
          localStorage.setItem('financeBudgetData', JSON.stringify(budgetData));
          renderBudgetDisplay();
        }
      }

      // --- New: Presentation Generation Logic ---
      async function generatePresentationData() {
        const presentationData = {};
        const today = new Date();
        const formattedToday = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;

        // Slide 1: Title Slide
        presentationData.slide1 = {
          title: "Personal Finance Overview",
          subtitle: `Generated on: ${formattedToday}`
        };

        // Helper to get overall financial summary
        function getOverallSummary() {
          let totalIncome = 0;
          let totalExpenses = 0;
          let firstDate = null;
          let lastDate = null;

          const dates = Object.keys(dailyActivity).sort();
          if (dates.length > 0) {
            firstDate = dates[0];
            lastDate = dates[dates.length - 1];
          }

          Object.values(dailyActivity).forEach(day => {
            totalIncome += day.dcIncome || 0;
            totalExpenses += day.charges || 0;
          });

          return {
            totalIncome: totalIncome.toFixed(2),
            totalExpenses: totalExpenses.toFixed(2),
            net: (totalIncome - totalExpenses).toFixed(2),
            periodCovered: firstDate && lastDate ? `Data from ${firstDate} to ${lastDate}` : "No data available"
          };
        }
        presentationData.slide2 = getOverallSummary();

        // Helper to get monthly aggregates
        function getMonthlyAggregates(dataType) { // dataType can be 'dcIncome' or 'charges'
          const monthly = {};
          Object.entries(dailyActivity).forEach(([dateKey, data]) => {
            const monthKey = dateKey.substring(0, 7); // YYYY-MM
            monthly[monthKey] = (monthly[monthKey] || 0) + (data[dataType] || 0);
          });
          return monthly;
        }

        // Slide 3: Income Highlights
        const monthlyIncome = getMonthlyAggregates('dcIncome');
        let totalIncomeThisMonth = 0;
        let highestIncomeMonthAmount = 0;
        let highestIncomeMonth = "N/A";
        const currentMonthKey = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;

        if (monthlyIncome[currentMonthKey]) {
          totalIncomeThisMonth = monthlyIncome[currentMonthKey];
        }
        for (const [month, amount] of Object.entries(monthlyIncome)) {
          if (amount > highestIncomeMonthAmount) {
            highestIncomeMonthAmount = amount;
            highestIncomeMonth = month;
          }
        }
        presentationData.slide3 = {
          title: "Income Highlights",
          totalIncomeThisMonth: totalIncomeThisMonth.toFixed(2),
          highestIncomeMonth: `${highestIncomeMonth} (${highestIncomeMonthAmount.toFixed(2)})`,
          // You could add more insights here, e.g., average monthly income
        };

        // Slide 4: Expense Highlights
        const monthlyExpenses = getMonthlyAggregates('charges');
        let totalExpensesThisMonth = 0;
        let highestExpenseMonthAmount = 0;
        let highestExpenseMonth = "N/A";

        if (monthlyExpenses[currentMonthKey]) {
          totalExpensesThisMonth = monthlyExpenses[currentMonthKey];
        }
        for (const [month, amount] of Object.entries(monthlyExpenses)) {
          if (amount > highestExpenseMonthAmount) {
            highestExpenseMonthAmount = amount;
            highestExpenseMonth = month;
          }
        }
        presentationData.slide4 = {
          title: "Expense Highlights",
          totalExpensesThisMonth: totalExpensesThisMonth.toFixed(2),
          highestExpenseMonth: `${highestExpenseMonth} (${highestExpenseMonthAmount.toFixed(2)})`,
          // You could add more insights here, e.g., average monthly expenses
        };
        
        // Slide 5: Top Expense Categories (for the most recent month with data)
        function getTopExpenseCategories() {
            const availableMonths = new Set();
            Object.keys(dailyActivity).forEach(dateKey_YYYY_MM_DD => {
                if (dailyActivity[dateKey_YYYY_MM_DD] && Object.keys(dailyActivity[dateKey_YYYY_MM_DD].categories).length > 0) {
                    availableMonths.add(dateKey_YYYY_MM_DD.substring(0, 7)); // YYYY-MM
                }
            });
            const sortedMonths = Array.from(availableMonths).sort().reverse();
            let topCategories = "No category data available for recent months.";

            if (sortedMonths.length > 0) {
                const latestMonthKey = sortedMonths[0];
                const aggregatedCategories = {};
                CATEGORIES.forEach(cat => aggregatedCategories[cat] = 0);

                Object.keys(dailyActivity).forEach(dateKey_YYYY_MM_DD => {
                    if (dateKey_YYYY_MM_DD.startsWith(latestMonthKey)) {
                        const dayData = dailyActivity[dateKey_YYYY_MM_DD];
                        if (dayData && dayData.categories) {
                            CATEGORIES.forEach(cat => {
                                if (dayData.categories[cat]) {
                                    aggregatedCategories[cat] += dayData.categories[cat];
                                }
                            });
                        }
                    }
                });
                
                const sortedTopCategories = Object.entries(aggregatedCategories)
                    .filter(([_, amount]) => amount > 0)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5); // Top 5 categories

                if (sortedTopCategories.length > 0) {
                    topCategories = sortedTopCategories.map(([name, amount]) => `${name}: ${amount.toFixed(2)}`).join(', ');
                } else {
                    topCategories = `No expenses recorded in categories for ${latestMonthKey}.`;
                }
                return {
                    title: `Top Expense Categories for ${latestMonthKey}`,
                    categories: topCategories
                };
            }
            return {
                title: "Top Expense Categories",
                categories: topCategories
            };
        }
        presentationData.slide5 = getTopExpenseCategories();

        // Slide 6: Recent Transactions Summary (last 7 days)
        function getRecentTransactionsSummary() {
          const sevenDaysAgo = new Date(today);
          sevenDaysAgo.setDate(today.getDate() - 7);
          
          let recentTxCount = 0;
          let totalSpentLast7Days = 0;
          const recentSample = [];

          const sortedTransactions = [...globalAllTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));

          sortedTransactions.forEach(tx => {
            const txDate = new Date(tx.date + "T00:00:00"); // Ensure correct date parsing
            if (txDate >= sevenDaysAgo) {
              recentTxCount++;
              if (tx.amount > 0) { // Expense
                totalSpentLast7Days += tx.amount;
              }
              if (recentSample.length < 3) { // Get last 3 transactions
                  recentSample.push(`${tx.date}: ${tx.description} (${tx.amount.toFixed(2)})`);
              }
            }
          });
          return {
            title: "Recent Transactions (Last 7 Days)",
            count: recentTxCount,
            totalSpent: totalSpentLast7Days.toFixed(2),
            sampleTransactions: recentSample.length > 0 ? recentSample.join('; ') : "No transactions in the last 7 days."
          };
        }
        presentationData.slide6 = getRecentTransactionsSummary();

        // Slide 7: Actionable Next Steps
        presentationData.slide7 = {
          title: "Actionable Next Steps",
          steps: [
            "Review spending patterns against budget goals.",
            "Identify top expense categories for potential savings.",
            "Monitor upcoming bills and payments.",
            "Consider setting new financial goals based on this overview."
            // These are generic; n8n agent could potentially generate more specific ones.
          ]
        };

        // Slide 8: Concluding Slide
        presentationData.slide8 = {
          title: "Thank You",
          message: "This financial overview was generated based on the available data."
        };
        
        return presentationData;
      }

      async function sendToN8N(data) {
        if (N8N_WEBHOOK_URL === "YOUR_N8N_WEBHOOK_URL_HERE" || !N8N_WEBHOOK_URL) {
          alert("N8N Webhook URL is not configured. Please update it in the script.");
          console.error("N8N Webhook URL is not configured.");
          return;
        }
        try {
          showProcessingBar("Generating presentation data...");
          const response = await fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
          });
          hideProcessingBar();
          if (response.ok) {
            alert('Presentation data sent to N8N successfully!');
            console.log('Data sent to N8N:', data);
          } else {
            const errorText = await response.text();
            alert(`Failed to send data to N8N. Status: ${response.status}. Details: ${errorText}`);
            console.error('Failed to send data to N8N:', response.status, errorText);
          }
        } catch (error) {
          hideProcessingBar();
          alert('Error sending data to N8N: ' + error.message);
          console.error('Error sending data to N8N:', error);
        }
      }

      const agentButton = document.getElementById('agent-action-button');
      if (agentButton) {
        agentButton.addEventListener('click', async () => {
          if (Object.keys(dailyActivity).length === 0 && globalAllTransactions.length === 0) {
            alert("No data available to generate a presentation. Please upload some files first.");            return;
          }
          const dataForN8N = await generatePresentationData();
          await sendToN8N(dataForN8N);
        });
      }
      // --- End Presentation Generation Logic ---

      // Initialize budget management and timeframe controls
      setupTimeframeControls();
      initializeBudgetManagement();
    </script>
</body>
</html>